function getColors(e){const t=PALETTES[(e-1)%PALETTES.length];return[null,t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9]]}function toggleTheme(){document.body.classList.toggle("dark-mode")}function toggleModal(e){const t=document.getElementById(e);t.classList.contains("hidden")?(document.querySelectorAll(".modal-overlay:not(.hidden)").forEach(e=>e.classList.add("hidden")),t.classList.remove("hidden")):t.classList.add("hidden")}function shareTwitter(){const e="https://codepen.io/Julibe/full/KwzXdRq",t="Julibe";let a=0,s=1,i=5,o="Solo";if(void 0!==p1&&p1)a=p1.player.score,s=p1.player.level,i=Math.round(1e3/p1.baseSpeed);else{const e=document.getElementById("inp-speed");e&&(i=parseInt(e.value)||5)}const d=void 0!==vsAI?vsAI:!!document.getElementById("chk-ai")&&document.getElementById("chk-ai").checked;d&&(o="Versus AI");const n=[`I just curated an exquisite piece in METRIO ${o}. Critics rated it ${a} moving at Speed ${i} on Level ${s}.`,`The tension between order and chaos in METRIO on Level ${s} resulted in a score of ${a}. A ${o} study at Speed ${i}.`,`At Speed ${i}, geometry becomes emotion in METRIO. I achieved ${a} in ${o}, reaching Level ${s} of the exhibit.`,`A kinetic performance of ${o} in METRIO. Level ${s} demanded Speed ${i}, yielding a critical score of ${a}.`],c=["Metrio","Minimalism","DigitalArt","Tetris","Julibe"],l=n[Math.floor(Math.random()*n.length)];let r=c.sort(()=>.5-Math.random()).slice(0,4);const p=r.join(","),f=`https://twitter.com/intent/tweet?text=${encodeURIComponent(l)}&url=${encodeURIComponent(e)}&hashtags=${encodeURIComponent(p)}&via=${encodeURIComponent(t)}`;window.open(f,"_blank")}function saveConfig(){const e={cols:document.getElementById("inp-cols").value,rows:document.getElementById("inp-rows").value,speed:document.getElementById("inp-speed").value,ai:document.getElementById("chk-ai").checked,grid:document.getElementById("chk-grid").checked,dark:document.getElementById("chk-dark").checked};localStorage.setItem("metrio_config",JSON.stringify(e))}function loadConfig(){const e=JSON.parse(localStorage.getItem("metrio_config"));if(e){document.getElementById("inp-cols").value=e.cols||12,document.getElementById("inp-rows").value=e.rows||20;let t=parseInt(e.speed);(t>20||t<1)&&(t=5),document.getElementById("inp-speed").value=t,document.getElementById("chk-ai").checked=e.ai,document.getElementById("chk-grid").checked=e.grid,document.getElementById("chk-dark").checked=e.dark,e.dark&&document.body.classList.add("dark-mode")}const t=localStorage.getItem("metrio_highscore")||0;document.getElementById("high-score-display").innerText="High Score: "+t}function drawMini(e,t,a){if(e.clearRect(0,0,60,60),!t)return;const s=getColors(a);e.save(),e.scale(15,15);const i=(4-t[0].length)/2,o=(4-t.length)/2;t.forEach((t,a)=>{t.forEach((t,d)=>{t&&(e.fillStyle=s[t],e.fillRect(d+i,a+o,1,1),e.lineWidth=.05,e.strokeStyle=document.body.classList.contains("dark-mode")?"#000":"#fff",e.strokeRect(d+i,a+o,1,1))})}),e.restore()}function togglePause(){gameRunning&&(isPaused?resumeGame():pauseGame())}function pauseGame(){isPaused=!0,document.getElementById("pause-menu").classList.remove("hidden"),document.getElementById("p1-canvas").classList.add("blurred"),vsAI&&document.getElementById("p2-canvas").classList.add("blurred"),document.getElementById("socials").classList.remove("hidden")}function resumeGame(){isPaused=!1,document.getElementById("pause-menu").classList.add("hidden"),document.getElementById("p1-canvas").classList.remove("blurred"),vsAI&&document.getElementById("p2-canvas").classList.remove("blurred"),lastTime=performance.now(),document.getElementById("socials").classList.add("hidden")}function showMenu(){gameRunning=!1,isPaused=!0,document.getElementById("menu").classList.remove("hidden"),document.getElementById("game-over").classList.add("hidden"),document.getElementById("pause-menu").classList.add("hidden"),document.querySelectorAll(".modal-overlay").forEach(e=>e.classList.add("hidden")),document.getElementById("pause-btn").style.display="none",document.getElementById("socials").classList.remove("hidden"),loadConfig()}function startGame(){"suspended"===audioCtx.state&&audioCtx.resume(),saveConfig();const e=parseInt(document.getElementById("inp-cols").value)||12,t=parseInt(document.getElementById("inp-rows").value)||20;let a=parseInt(document.getElementById("inp-speed").value)||5;a<1&&(a=1),a>20&&(a=20);const s=1e3/a;vsAI=document.getElementById("chk-ai").checked,showGrid=document.getElementById("chk-grid").checked,document.getElementById("menu").classList.add("hidden"),document.getElementById("game-over").classList.add("hidden"),document.getElementById("pause-btn").style.display="flex",document.getElementById("socials").classList.add("hidden"),document.getElementById("p1-canvas").classList.remove("blurred"),document.getElementById("p2-canvas").classList.remove("blurred");const i=document.getElementById("p2-container");i.style.display=vsAI?"block":"none",p1=new TetrisGame("p1-container","p1-canvas",e,t,!1),p1.setSpeed(s),p2=vsAI?new TetrisGame("p2-container","p2-canvas",e,t,!0):null,p2&&p2.setSpeed(s);const o=vsAI?"p2":"p1";drawMini(document.getElementById(o+"-hold").getContext("2d"),null,1),drawMini(document.getElementById("p1-hold").getContext("2d"),null,1),p1.triggerUI(),isPaused=!1,gameRunning=!0,passiveTimer=0,lastTime=performance.now(),requestAnimationFrame(update)}function gameOver(e){gameRunning=!1,isPaused=!0;const t=parseInt(localStorage.getItem("metrio_highscore"))||0;p1.player.score>t&&(localStorage.setItem("metrio_highscore",p1.player.score),e+=" (NEW HIGH SCORE!)"),document.getElementById("game-over").classList.remove("hidden"),document.getElementById("go-msg").innerText=e+" - Score: "+p1.player.score,document.getElementById("socials").classList.remove("hidden")}function updateGamepad(e){const t=navigator.getGamepads()[0];if(!t)return;const a=.5;if(t.buttons[9].pressed&&!gpState.start&&togglePause(),gpState.start=t.buttons[9].pressed,isPaused)return;t.buttons[0].pressed?p1.dropInterval=50:p1.dropInterval=p1.baseSpeed;const s=t.buttons[1].pressed||t.buttons[12].pressed;s&&!gpState.b&&p1.playerRotate(1),gpState.b=s,t.buttons[3].pressed&&!gpState.y&&hold(),gpState.y=t.buttons[3].pressed,t.buttons[2].pressed&&!gpState.x&&steal(),gpState.x=t.buttons[2].pressed,gpState.moveTimer+=e,gpState.moveTimer>100&&(t.axes[0]<-a||t.buttons[14].pressed?(p1.player.pos.x--,p1.collide(p1.arena,p1.player)?p1.player.pos.x++:sfx.play("move"),gpState.moveTimer=0):(t.axes[0]>a||t.buttons[15].pressed)&&(p1.player.pos.x++,p1.collide(p1.arena,p1.player)?p1.player.pos.x--:sfx.play("move"),gpState.moveTimer=0))}function update(e=0){if(isPaused||!gameRunning)return;lastTime||(lastTime=e);let t=e-lastTime;if(t>100&&(t=100),lastTime=e,updateGamepad(t),passiveTimer+=t,passiveTimer>1e4){const e=10+p1.player.level;p1.updateScore(e),p1.floatText("PASSIVE",1),passiveTimer=0}p1.update(t),p1.draw(),vsAI&&p2&&(p2.update(t),p2.draw()),p1.isDead?gameOver("DECONSTRUCTED"):vsAI&&p2.isDead&&(p1.updateScore(2e3),gameOver("DOMINANCE")),requestAnimationFrame(update)}function hold(){p1.player.canHold&&(p1.player.hold?([p1.player.matrix,p1.player.hold]=[p1.player.hold,p1.player.matrix],p1.player.pos.y=0,p1.player.pos.x=(p1.cols/2|0)-(p1.player.matrix[0].length/2|0)):(p1.player.hold=p1.player.matrix,p1.resetPiece()),p1.player.canHold=!1,drawMini(document.getElementById("p1-hold").getContext("2d"),p1.player.hold,p1.player.level))}function steal(){if(vsAI&&!p1.isDead&&!p2.isDead&&p1.player.score>=200){p1.updateScore(-200);const e=p1.player.matrix;p1.player.matrix=p2.player.matrix,p2.player.matrix=e,p1.player.pos.x=(p1.cols/2|0)-(p1.player.matrix[0].length/2|0),p2.player.pos.x=(p2.cols/2|0)-(p2.player.matrix[0].length/2|0),p1.floatText("EXCHANGE",1.5,"#d63031"),p2.floatText("ERROR",1.5)}}const SCALE=20,audioCtx=new(window.AudioContext||window.webkitAudioContext),sfx={play(e){"suspended"===audioCtx.state&&audioCtx.resume();const t=audioCtx.currentTime,a=audioCtx.createOscillator(),s=audioCtx.createGain();a.connect(s),s.connect(audioCtx.destination),"move"===e?(a.type="sine",a.frequency.setValueAtTime(400,t),a.frequency.exponentialRampToValueAtTime(600,t+.05),s.gain.setValueAtTime(.05,t),s.gain.exponentialRampToValueAtTime(.001,t+.05),a.start(t),a.stop(t+.05)):"rotate"===e?(a.type="triangle",a.frequency.setValueAtTime(200,t),a.frequency.linearRampToValueAtTime(300,t+.1),s.gain.setValueAtTime(.05,t),s.gain.linearRampToValueAtTime(0,t+.1),a.start(t),a.stop(t+.1)):"drop"===e?(a.type="sine",a.frequency.setValueAtTime(100,t),a.frequency.exponentialRampToValueAtTime(50,t+.2),s.gain.setValueAtTime(.1,t),s.gain.exponentialRampToValueAtTime(.001,t+.2),a.start(t),a.stop(t+.2)):"clear"===e?(a.type="sine",a.frequency.setValueAtTime(300,t),a.frequency.linearRampToValueAtTime(100,t+.3),s.gain.setValueAtTime(.1,t),s.gain.exponentialRampToValueAtTime(.001,t+.3),a.start(t),a.stop(t+.3)):"level"===e&&(a.type="sine",a.frequency.setValueAtTime(440,t),a.frequency.linearRampToValueAtTime(880,t+.5),s.gain.setValueAtTime(.1,t),s.gain.exponentialRampToValueAtTime(.001,t+.5),a.start(t),a.stop(t+.5))}},PALETTES=[{1:"#00cec9",2:"#e17055",3:"#0984e3",4:"#fdcb6e",5:"#d63031",6:"#6c5ce7",7:"#e84393",8:"#b2bec3",9:"#2d3436"},{1:"#48dbfb",2:"#ff9f43",3:"#2e86de",4:"#feca57",5:"#ff6b6b",6:"#1dd1a1",7:"#5f27cd",8:"#8395a7",9:"#222f3e"},{1:"#0abde3",2:"#ee5253",3:"#5f27cd",4:"#feca57",5:"#ff9f43",6:"#10ac84",7:"#2e86de",8:"#c8d6e5",9:"#222f3e"},{1:"#7f8fa6",2:"#c23616",3:"#273c75",4:"#e1b12c",5:"#e84118",6:"#44bd32",7:"#8c7ae6",8:"#dcdde1",9:"#353b48"},{1:"#718093",2:"#e1b12c",3:"#2f3640",4:"#c23616",5:"#44bd32",6:"#192a56",7:"#8c7ae6",8:"#7f8fa6",9:"#273c75"},{1:"#e1b12c",2:"#e17055",3:"#fab1a0",4:"#ffeaa7",5:"#d63031",6:"#00b894",7:"#a29bfe",8:"#636e72",9:"#2d3436"},{1:"#00d2d3",2:"#ff9f43",3:"#54a0ff",4:"#f368e0",5:"#ff6b6b",6:"#1dd1a1",7:"#5f27cd",8:"#c8d6e5",9:"#222f3e"},{1:"#55efc4",2:"#e17055",3:"#74b9ff",4:"#ffeaa7",5:"#ff7675",6:"#00b894",7:"#a29bfe",8:"#dfe6e9",9:"#2d3436"},{1:"#81ecec",2:"#fab1a0",3:"#0984e3",4:"#fdcb6e",5:"#d63031",6:"#00cec9",7:"#6c5ce7",8:"#b2bec3",9:"#2d3436"},{1:"#7efff5",2:"#ffcccc",3:"#18dcff",4:"#ff9f43",5:"#ff4d4d",6:"#3ae374",7:"#7d5fff",8:"#4b4b4b",9:"#3d3d3d"},{1:"#ff9ff3",2:"#feca57",3:"#54a0ff",4:"#ff9f43",5:"#ff6b6b",6:"#48dbfb",7:"#1dd1a1",8:"#8395a7",9:"#222f3e"},{1:"#fd79a8",2:"#e17055",3:"#0984e3",4:"#fab1a0",5:"#d63031",6:"#00b894",7:"#a29bfe",8:"#b2bec3",9:"#2d3436"},{1:"#e1b12c",2:"#e17055",3:"#2d3436",4:"#fab1a0",5:"#d63031",6:"#00cec9",7:"#6c5ce7",8:"#dfe6e9",9:"#636e72"},{1:"#81ecec",2:"#fab1a0",3:"#74b9ff",4:"#ffeaa7",5:"#ff7675",6:"#55efc4",7:"#a29bfe",8:"#b2bec3",9:"#2d3436"},{1:"#00d2d3",2:"#ff9f43",3:"#2e86de",4:"#feca57",5:"#ff6b6b",6:"#1dd1a1",7:"#5f27cd",8:"#c8d6e5",9:"#576574"},{1:"#48dbfb",2:"#ff9f43",3:"#54a0ff",4:"#f368e0",5:"#ff6b6b",6:"#10ac84",7:"#5f27cd",8:"#8395a7",9:"#222f3e"},{1:"#c7ecee",2:"#f0932b",3:"#686de0",4:"#ffbe76",5:"#ff7979",6:"#badc58",7:"#e056fd",8:"#95afc0",9:"#535c68"},{1:"#7ed6df",2:"#e056fd",3:"#22a6b3",4:"#f0932b",5:"#eb4d4b",6:"#6ab04c",7:"#be2edd",8:"#95afc0",9:"#130f40"},{1:"#e056fd",2:"#ffbe76",3:"#686de0",4:"#f6e58d",5:"#ff7979",6:"#badc58",7:"#4834d4",8:"#dff9fb",9:"#130f40"},{1:"#22a6b3",2:"#f0932b",3:"#4834d4",4:"#f9ca24",5:"#eb4d4b",6:"#6ab04c",7:"#be2edd",8:"#c7ecee",9:"#30336b"},{1:"#81ecec",2:"#fab1a0",3:"#74b9ff",4:"#ffeaa7",5:"#ff7675",6:"#55efc4",7:"#a29bfe",8:"#b2bec3",9:"#636e72"},{1:"#e1b12c",2:"#e17055",3:"#2d3436",4:"#fab1a0",5:"#d63031",6:"#00cec9",7:"#6c5ce7",8:"#dfe6e9",9:"#2d3436"},{1:"#00d2d3",2:"#ff9f43",3:"#54a0ff",4:"#feca57",5:"#ff6b6b",6:"#1dd1a1",7:"#5f27cd",8:"#c8d6e5",9:"#576574"},{1:"#a29bfe",2:"#e17055",3:"#0984e3",4:"#fdcb6e",5:"#d63031",6:"#00cec9",7:"#6c5ce7",8:"#b2bec3",9:"#2d3436"},{1:"#81ecec",2:"#fab1a0",3:"#74b9ff",4:"#ffeaa7",5:"#ff7675",6:"#55efc4",7:"#a29bfe",8:"#dfe6e9",9:"#636e72"},{1:"#00d2d3",2:"#ff9f43",3:"#2e86de",4:"#feca57",5:"#ff6b6b",6:"#1dd1a1",7:"#5f27cd",8:"#8395a7",9:"#222f3e"},{1:"#b2bec3",2:"#e17055",3:"#2d3436",4:"#fab1a0",5:"#d63031",6:"#00cec9",7:"#6c5ce7",8:"#dfe6e9",9:"#636e72"},{1:"#0abde3",2:"#ee5253",3:"#5f27cd",4:"#feca57",5:"#ff9f43",6:"#10ac84",7:"#2e86de",8:"#c8d6e5",9:"#222f3e"},{1:"#e1b12c",2:"#e17055",3:"#2d3436",4:"#fab1a0",5:"#d63031",6:"#00cec9",7:"#6c5ce7",8:"#b2bec3",9:"#2d3436"},{1:"#48dbfb",2:"#ff9f43",3:"#54a0ff",4:"#f368e0",5:"#ff6b6b",6:"#10ac84",7:"#5f27cd",8:"#8395a7",9:"#576574"},{1:"#b2bec3",2:"#e17055",3:"#2d3436",4:"#fab1a0",5:"#d63031",6:"#00cec9",7:"#6c5ce7",8:"#dfe6e9",9:"#636e72"},{1:"#636e72",2:"#b2bec3",3:"#2d3436",4:"#dfe6e9",5:"#d63031",6:"#00cec9",7:"#0984e3",8:"#b2bec3",9:"#000000"},{1:"#00d2d3",2:"#ff9f43",3:"#54a0ff",4:"#feca57",5:"#ff6b6b",6:"#1dd1a1",7:"#5f27cd",8:"#c8d6e5",9:"#222f3e"},{1:"#0abde3",2:"#ee5253",3:"#5f27cd",4:"#feca57",5:"#ff9f43",6:"#10ac84",7:"#2e86de",8:"#8395a7",9:"#576574"},{1:"#00d2d3",2:"#ff9f43",3:"#2e86de",4:"#feca57",5:"#ff6b6b",6:"#1dd1a1",7:"#5f27cd",8:"#c8d6e5",9:"#222f3e"},{1:"#48dbfb",2:"#ff9f43",3:"#54a0ff",4:"#f368e0",5:"#ff6b6b",6:"#10ac84",7:"#5f27cd",8:"#8395a7",9:"#576574"},{1:"#e17055",2:"#d63031",3:"#2d3436",4:"#fab1a0",5:"#ff7675",6:"#00cec9",7:"#6c5ce7",8:"#b2bec3",9:"#2d3436"},{1:"#0abde3",2:"#ee5253",3:"#5f27cd",4:"#feca57",5:"#ff9f43",6:"#10ac84",7:"#2e86de",8:"#c8d6e5",9:"#222f3e"},{1:"#00b894",2:"#fab1a0",3:"#0984e3",4:"#ffeaa7",5:"#d63031",6:"#55efc4",7:"#a29bfe",8:"#dfe6e9",9:"#636e72"},{1:"#a29bfe",2:"#e17055",3:"#0984e3",4:"#fdcb6e",5:"#d63031",6:"#00cec9",7:"#6c5ce7",8:"#b2bec3",9:"#2d3436"}];class TetrisGame{constructor(e,t,a,s,i){this.container=document.getElementById(e),this.canvas=document.getElementById(t),this.ctx=this.canvas.getContext("2d"),this.isAI=i;const o=i?"p2":"p1";this.uiElements=[document.getElementById(o+"-stats"),document.getElementById(o+"-lbl"),document.getElementById(o+"-hold-lbl"),document.getElementById(o+"-next-lbl")],this.cols=a,this.rows=s,this.canvas.width=a*SCALE,this.canvas.height=s*SCALE,this.container.style.width=a*SCALE+"px",this.container.style.height=s*SCALE+"px",this.ctx.scale(SCALE,SCALE),this.arena=this.createMatrix(a,s),this.player={pos:{x:0,y:0},matrix:null,next:null,hold:null,canHold:!0,score:0,level:1,lines:0},this.dropCounter=0,this.dropInterval=1e3,this.baseSpeed=1e3,this.isDead=!1,this.particles=[],this.shockwaves=[],this.glitch=0,this.uiTimeout=null,this.player.next=this.getRandomPiece(),this.resetPiece()}setSpeed(e){this.baseSpeed=e,this.dropInterval=e}createMatrix(e,t){const a=[];for(;t--;)a.push(new Array(e).fill(0));return a}createPiece(e){return"I"==e?[[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]]:"L"==e?[[0,2,0],[0,2,0],[0,2,2]]:"J"==e?[[0,3,0],[0,3,0],[3,3,0]]:"O"==e?[[4,4],[4,4]]:"Z"==e?[[5,5,0],[0,5,5],[0,0,0]]:"S"==e?[[0,6,6],[6,6,0],[0,0,0]]:"T"==e?[[0,7,0],[7,7,7],[0,0,0]]:"B"==e?[[0,9,0],[9,9,9],[0,9,0]]:"G"==e?[[8]]:void 0}getRandomPiece(){return this.createPiece(Math.random()<.05?"B":"ILJOTSZ"["ILJOTSZ".length*Math.random()|0])}collide(e,t){const a=t.matrix,s=t.pos;for(let t=0;t<a.length;++t)for(let i=0;i<a[t].length;++i)if(0!==a[t][i]&&0!==(e[t+s.y]&&e[t+s.y][i+s.x]))return!0;return!1}merge(e,t){t.matrix.forEach((a,s)=>{a.forEach((a,i)=>{0!==a&&(e[s+t.pos.y][i+t.pos.x]=a,isPaused||this.shockwaves.push({x:(i+t.pos.x)*SCALE+10,y:(s+t.pos.y)*SCALE+10,r:1,op:.5,col:"#999"}))})}),this.isAI||sfx.play("drop")}rotate(e,t){for(let t=0;t<e.length;++t)for(let a=0;a<t;++a)[e[a][t],e[t][a]]=[e[t][a],e[a][t]];t>0?e.forEach(e=>e.reverse()):e.reverse()}playerRotate(e){const t=this.player.pos.x;let a=1;for(this.rotate(this.player.matrix,e);this.collide(this.arena,this.player);)if(this.player.pos.x+=a,a=-(a+(a>0?1:-1)),a>this.player.matrix[0].length)return this.rotate(this.player.matrix,-e),void(this.player.pos.x=t);this.isAI||sfx.play("rotate")}resetPiece(){this.player.matrix=this.player.next,this.player.next=this.getRandomPiece(),this.player.pos.y=0,this.player.pos.x=(this.cols/2|0)-(this.player.matrix[0].length/2|0),this.collide(this.arena,this.player)&&(this.isDead=!0);const e=this.isAI?"p2":"p1",t=document.getElementById(e+"-next").getContext("2d");drawMini(t,this.player.next,this.player.level)}addGarbage(e){for(let t=0;t<e;t++)this.arena.shift();for(let t=0;t<e;t++){const e=new Array(this.cols).fill(8);e[Math.floor(Math.random()*this.cols)]=0,this.arena.push(e)}}sweep(){let e=0,t=null;e:for(let a=this.arena.length-1;a>0;--a){for(let e=0;e<this.arena[a].length;++e){if(0===this.arena[a][e])continue e;9===this.arena[a][e]&&(t={x:e,y:a})}const s=this.arena.splice(a,1)[0].fill(0);this.arena.unshift(s),++a,e++}for(let t=0;t<this.cols;t++){let a=!0;for(let e=0;e<this.rows;e++)if(0===this.arena[e][t]){a=!1;break}if(a){e++,this.floatText("VERTICAL",1.2);for(let e=0;e<this.rows;e++)this.arena[e][t]=0,this.particles.push({x:t,y:e,vx:Math.random()-.5,vy:Math.random()-.5,life:1,col:"#999"})}}if(t){e+=3,this.glitch=20,this.floatText("ANOMALY",2);for(let e=t.y-2;e<=t.y+2;e++)if(this.arena[e])for(let a=t.x-2;a<=t.x+2;a++)void 0!==this.arena[e][a]&&(this.arena[e][a]=0)}if(e>0){this.isAI||sfx.play("clear");let a=1===e?100:2===e?300:3===e?500:600;if(this.updateScore(a),this.player.lines+=e,e>=4?(this.floatText("METRIO!"),this.glitch=10):e>0&&!t&&this.floatText("+"+a),vsAI){const t=this.isAI?p1:p2;e>0&&!t.isDead&&t.addGarbage(e)}Math.floor(this.player.lines/5)+1>this.player.level&&(this.player.level++,this.isAI||sfx.play("level"),this.baseSpeed*=.9,this.floatText("EVOLUTION",1.5,"#e84393"),this.triggerUI())}}drop(){this.player.pos.y++,this.collide(this.arena,this.player)&&(this.player.pos.y--,this.merge(this.arena,this.player),this.resetPiece(),this.sweep(),this.player.canHold=!0),this.dropCounter=0}updateScore(e){this.player.score+=e,this.triggerUI()}triggerUI(){const e=this.isAI?"p2":"p1";document.getElementById(e+"-score").innerText=this.player.score,document.getElementById(e+"-lvl").innerText=this.player.level,showGrid?this.uiElements.forEach(e=>e.style.opacity=1):(this.uiElements.forEach(e=>e.style.opacity=1),this.uiTimeout&&clearTimeout(this.uiTimeout),this.uiTimeout=setTimeout(()=>this.uiElements.forEach(e=>e.style.opacity=0),5e3))}update(e){if(!this.isDead){if(this.dropCounter+=e,this.dropCounter>this.dropInterval&&this.drop(),this.isAI){if(Math.random()<.05&&this.playerRotate(1),Math.random()<.1){const e=Math.random()<.5?1:-1;this.player.pos.x+=e,this.collide(this.arena,this.player)&&(this.player.pos.x-=e)}Math.random()<.03&&this.drop()}this.particles.forEach(e=>{e.x+=e.vx,e.y+=e.vy,e.life-=.05}),this.particles=this.particles.filter(e=>e.life>0),this.shockwaves.forEach(e=>{e.r+=2,e.op-=.05}),this.shockwaves=this.shockwaves.filter(e=>e.op>0),this.glitch>0&&(this.glitch*=.9)}}draw(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);const e=getColors(this.player.level);let t=0,a=0;if(this.glitch>.5&&(t=(Math.random()-.5)*this.glitch,a=(Math.random()-.5)*this.glitch),this.ctx.save(),this.ctx.translate(t,a),showGrid){this.ctx.strokeStyle="rgba(128,128,128,0.2)",this.ctx.lineWidth=.05,this.ctx.beginPath();for(let e=0;e<=this.cols;e++)this.ctx.moveTo(e,0),this.ctx.lineTo(e,this.rows);for(let e=0;e<=this.rows;e++)this.ctx.moveTo(0,e),this.ctx.lineTo(this.cols,e);this.ctx.stroke()}const s=(t,a,s)=>{t.forEach((t,i)=>{t.forEach((t,o)=>{0!==t&&(this.ctx.fillStyle=s?document.body.classList.contains("dark-mode")?"#555":"#bbb":e[t],this.ctx.fillRect(o+a.x,i+a.y,1,1),s||(this.ctx.lineWidth=.05,this.ctx.strokeStyle=document.body.classList.contains("dark-mode")?"#000":"#fff",this.ctx.strokeRect(o+a.x,i+a.y,1,1)))})})};if(s(this.arena,{x:0,y:0}),!this.isDead){const e={...this.player.pos};for(;!this.collide(this.arena,{pos:e,matrix:this.player.matrix});)e.y++;e.y--,this.ctx.globalAlpha=.3,s(this.player.matrix,e,!0),this.ctx.globalAlpha=1,s(this.player.matrix,this.player.pos)}this.ctx.restore(),this.ctx.save(),this.ctx.scale(SCALE,SCALE),this.particles.forEach(e=>{this.ctx.fillStyle=e.col,this.ctx.globalAlpha=e.life,this.ctx.fillRect(e.x,e.y,.2,.2)}),this.ctx.restore(),this.shockwaves.forEach(e=>{this.ctx.beginPath(),this.ctx.strokeStyle=e.col,this.ctx.globalAlpha=e.op,this.ctx.lineWidth=2;const t=e.r;this.ctx.rect(e.x-t,e.y-t,2*t,2*t),this.ctx.stroke()}),this.ctx.globalAlpha=1}floatText(e,t=1,a=null){a||(a=document.body.classList.contains("dark-mode")?"#fff":"#333");const s=document.createElement("div");s.classList.add("float-text"),s.innerText=e,s.style.fontSize=1.5*t+"rem",s.style.color=a,s.style.left="50%",s.style.top="40%",this.container.appendChild(s),setTimeout(()=>s.remove(),1500)}}let p1,p2,lastTime=0,isPaused=!0,vsAI=!1,showGrid=!1,passiveTimer=0,gameRunning=!1;const gpState={a:!1,b:!1,x:!1,y:!1,start:!1,moveTimer:0};document.addEventListener("keydown",e=>{if(!gameRunning)return;const t=e.key.toLowerCase(),a=e.code;"p"!==t&&"Escape"!==a?isPaused||("ArrowLeft"===a||"a"===t?(p1.player.pos.x--,p1.collide(p1.arena,p1.player)?p1.player.pos.x++:sfx.play("move")):"ArrowRight"===a||"d"===t?(p1.player.pos.x++,p1.collide(p1.arena,p1.player)?p1.player.pos.x--:sfx.play("move")):"ArrowUp"===a||"w"===t?p1.playerRotate(1):"q"===t?hold():"f"===t?steal():"Space"!==a&&"s"!==t&&"ArrowDown"!==a||(e.preventDefault(),p1.dropInterval=50)):togglePause()}),document.addEventListener("keyup",e=>{const t=e.key.toLowerCase(),a=e.code;"Space"!==a&&"s"!==t&&"ArrowDown"!==a||(p1.dropInterval=p1.baseSpeed)}),window.addEventListener("gamepadconnected",e=>{console.log("Gamepad connected at index %d: %s. %d buttons, %d axes.",e.gamepad.index,e.gamepad.id,e.gamepad.buttons.length,e.gamepad.axes.length)}),document.getElementById("pause-btn").style.display="none",showMenu();