function applyRandomTheme(){const e=THEMES[Math.floor(Math.random()*THEMES.length)];document.body.style.background=e.bg,document.documentElement.style.setProperty("--board-grad",e.board),document.documentElement.style.setProperty("--accent",e.accent),currentThemeColor=e.accent}function getQuote(e){return QUOTES[e][Math.floor(Math.random()*QUOTES[e].length)]}function toast(e,t="normal",n="info"){const i=document.getElementById("toast-container");i.innerHTML="";const s=document.createElement("div");s.className=`toast ${t}`,s.innerHTML=`${e} <i class="material-icons">${n}</i>`,i.appendChild(s),setTimeout(()=>{s.parentNode&&s.parentNode.removeChild(s)},4e3)}function resizeCanvas(){const e=canvas.parentElement.getBoundingClientRect();canvas.width=e.width,canvas.height=e.height}function handleInteraction(e,t){if(STATE.paused||!STATE.active||0!==STATE.turn)return;const n=canvas.getBoundingClientRect(),i=canvas.width/CONFIG.size,s=Math.floor((e-n.left)/i),a=Math.floor((t-n.top)/i);a>=0&&a<CONFIG.size&&s>=0&&s<CONFIG.size&&(null!==STATE.grid[a][s].owner||STATE.grid[a][s].frozen||(STATE.active=!1,STATE.grid[a][s].set(0),addScore(10,e-n.left,t-n.top),checkRoundEnd(0)))}function toMenu(){STATE.active=!1,document.querySelectorAll(".overlay").forEach(e=>e.style.display="none"),document.getElementById("game-view").style.display="none",document.getElementById("menu").style.display="flex",document.getElementById("top-socials").classList.remove("hidden"),document.getElementById("toast-container").innerHTML="",MUSIC.stop()}function getUniqueSymbol(e){const t=e.map(e=>e.symbol),n=SYMBOLS_POOL.filter(e=>!t.includes(e));return n.length>0?n[Math.floor(Math.random()*n.length)]:"help_outline"}function initGame(){document.getElementById("menu").style.display="none",document.getElementById("top-socials").classList.add("hidden"),document.getElementById("game-view").style.display="flex",resizeCanvas(),applyRandomTheme(),"suspended"===audioCtx.state&&audioCtx.resume(),MUSIC.start(),isMuted||(document.getElementById("music-ctrl").style.color="var(--accent)",document.getElementById("music-ctrl").innerHTML='<i class="material-icons">volume_up</i>'),CONFIG.size=parseInt(document.getElementById("inp-size").value),CONFIG.win=parseInt(document.getElementById("inp-win").value),CONFIG.enemies=parseInt(document.getElementById("inp-enemies").value),CONFIG.difficulty=parseInt(document.getElementById("inp-diff").value),CONFIG.startLives=parseInt(document.getElementById("inp-lives").value),CONFIG.baseTime=1e3*parseFloat(document.getElementById("inp-time").value),STATE.roundsWon=0,STATE.roundStreak=0,STATE.timeLimit=CONFIG.baseTime,STATE.chaosBag=[];const e=document.getElementById("inp-name").value||"Player";STATE.players=[new Player(0,selectedPlayerSymbol,e)],STATE.players[0].lives=CONFIG.startLives;let t=[...NAMES];t.sort(()=>Math.random()-.5);for(let e=1;e<=CONFIG.enemies;e++){let n=getUniqueSymbol(STATE.players),i=new Player(e,n);i.lives=3,e<=t.length&&(i.name=t[e-1]),STATE.players.push(i)}startNewRound(),gameLoop()}function startNewRound(){STATE.grid=Array(CONFIG.size).fill(null).map((e,t)=>Array(CONFIG.size).fill(null).map((e,n)=>new Cell(t,n))),STATE.floatingTexts=[],STATE.fog=null,STATE.roundsWon>0&&applyRandomTheme(),particles=[],STATE.winningLine=null,STATE.ripples=[],STATE.turn=Math.floor(Math.random()*STATE.players.length),STATE.active=!0,STATE.paused=!1,STATE.startTime=Date.now(),updateHUD(),toast(`Cycle ${STATE.roundsWon+1} awakens.`,"normal","autorenew"),processTurn()}function drawFluidLine(e,t,n,i,s){ctx.beginPath(),ctx.moveTo(e,t);const a=(n-e)/s,r=(i-t)/s,o=.002*Date.now();for(let i=1;i<s;i++){let s=e+a*i,l=t+r*i;const c=Math.hypot(s-STATE.mouse.x,l-STATE.mouse.y),d=120;let h=1.5*Math.sin(o+.5*i);if(c<d){const e=15*(1-c/d),t=Math.atan2(l-STATE.mouse.y,s-STATE.mouse.x);s+=Math.cos(t)*e,l+=Math.sin(t)*e}Math.abs(n-e)<1?s+=h:l+=h,ctx.lineTo(s,l)}ctx.lineTo(n,i),ctx.stroke()}function gameLoop(){if(requestAnimationFrame(gameLoop),STATE.paused)return;ctx.clearRect(0,0,canvas.width,canvas.height);const e=canvas.width/CONFIG.size,t=.4+.2*Math.sin(.002*Date.now());ctx.strokeStyle=`rgba(255,255,255,${t})`,ctx.lineWidth=2;for(let t=1;t<CONFIG.size;t++)drawFluidLine(t*e,0,t*e,canvas.height,20);for(let t=1;t<CONFIG.size;t++)drawFluidLine(0,t*e,canvas.width,t*e,20);if(STATE.active&&0===STATE.turn&&STATE.mouse.x>0){const t=Math.floor(STATE.mouse.x/e),n=Math.floor(STATE.mouse.y/e);n>=0&&n<CONFIG.size&&t>=0&&t<CONFIG.size&&(ctx.save(),ctx.strokeStyle="rgba(255,255,255, 0.8)",ctx.lineWidth=4,ctx.shadowBlur=15,ctx.shadowColor="white",ctx.strokeRect(t*e+4,n*e+4,e-8,e-8),ctx.restore(),null===STATE.grid[n][t].owner&&(ctx.save(),ctx.globalAlpha=.4,ctx.fillStyle="#fff",ctx.font=`${.5*e}px 'Material Icons'`,ctx.textAlign="center",ctx.textBaseline="middle",ctx.fillText(STATE.players[0].symbol,t*e+e/2,n*e+e/2),ctx.restore()))}for(let e=STATE.ripples.length-1;e>=0;e--){let t=STATE.ripples[e];t.update(),t.draw(ctx),t.alpha<=0&&STATE.ripples.splice(e,1)}for(let t=0;t<CONFIG.size;t++)for(let n=0;n<CONFIG.size;n++){const i=STATE.grid[t][n];i.update();const s=n*e+e/2,a=t*e+e/2;if(STATE.fog){let i=!1;if("row"===STATE.fog.type&&t===STATE.fog.val&&(i=!0),"col"===STATE.fog.type&&n===STATE.fog.val&&(i=!0),"diag"===STATE.fog.type&&t===n&&0===STATE.fog.val&&(i=!0),"diag"===STATE.fog.type&&t+n===CONFIG.size-1&&1===STATE.fog.val&&(i=!0),i){ctx.fillStyle=`rgba(255,255,255,${.2+.1*Math.random()})`,ctx.fillRect(n*e,t*e,e,e);continue}}if(i.frozen&&(ctx.fillStyle="rgba(200,230,255,0.3)",ctx.fillRect(n*e,t*e,e,e)),null!==i.visualOwner){if(ctx.globalAlpha=i.alpha,999===i.visualOwner)ctx.fillStyle="#888",ctx.beginPath(),ctx.arc(s,a,e/4,0,2*Math.PI),ctx.fill();else{i.highlight&&(ctx.fillStyle="rgba(255,255,255,0.3)",ctx.fillRect(n*e,t*e,e,e),ctx.shadowBlur=20,ctx.shadowColor="#fff");let r=STATE.players.find(e=>e.id===i.visualOwner),o=r?r.symbol:"help_outline";ctx.fillStyle="#fff",ctx.font=`${.5*e}px 'Material Icons'`,ctx.textAlign="center",ctx.textBaseline="middle",ctx.fillText(o,s,a),ctx.shadowBlur=0}ctx.globalAlpha=1}}if(STATE.winningLine&&STATE.winningLine.length>0){const t=STATE.winningLine[0],n=STATE.winningLine[STATE.winningLine.length-1];ctx.strokeStyle="#fff",ctx.lineWidth=6,ctx.lineCap="round",ctx.shadowBlur=15,ctx.shadowColor="#fff",ctx.beginPath(),ctx.moveTo(t.c*e+e/2,t.r*e+e/2),ctx.lineTo(n.c*e+e/2,n.r*e+e/2),ctx.stroke(),ctx.lineWidth=1,ctx.shadowBlur=0}for(let e=particles.length-1;e>=0;e--){let t=particles[e];t.update(),t.draw(ctx),t.life<=0&&particles.splice(e,1)}for(let e=STATE.floatingTexts.length-1;e>=0;e--){let t=STATE.floatingTexts[e];t.update(),t.draw(ctx),t.life<=0&&STATE.floatingTexts.splice(e,1)}if(STATE.active){const e=Date.now()-STATE.startTime,t=Math.max(0,STATE.timeLimit-e);uiStats.timer.style.transform=`scaleX(${t/STATE.timeLimit})`,t<=0&&(STATE.startTime=Date.now(),triggerPulse())}}function spawnParticles(e,t,n){const i=canvas.width/CONFIG.size;for(let s=0;s<n;s++)particles.push(new Particle(e*i+i/2,t*i+i/2))}function addRipple(e,t){const n=canvas.width/CONFIG.size;STATE.ripples.push(new Ripple(e*n+n/2,t*n+n/2,n))}function addScore(e,t,n){STATE.players[0].score+=e,t&&n&&STATE.floatingTexts.push(new FloatingText(t,n,`+${e}`)),updateHUD()}function updateHUD(){let e="";for(let t=0;t<STATE.players[0].lives;t++)e+='<i class="material-icons">favorite</i>';uiStats.lives.innerHTML=e,uiStats.score.innerText=STATE.players[0].score;let t=[0,.25,.5,.75,.95,1][CONFIG.difficulty],n=Math.floor(100*(t+.05*STATE.roundsWon));document.getElementById("presence-header").innerHTML=`Presences <span style="font-size:0.6em; opacity:0.7; margin-left:5px;">(AI: ${n}%)</span>`;const i=document.getElementById("player-list");i.innerHTML="",STATE.players.forEach((e,t)=>{const n=document.createElement("div");n.className=`player-card ${STATE.turn===t?e.isHuman?"active":"active-cpu":""}`;let s="";for(let t=0;t<e.lives;t++)s+='<i class="material-icons" style="font-size:10px; color:var(--accent)">favorite</i>';n.innerHTML=`\n                <div class="p-symbol"><i class="material-icons">${e.symbol}</i></div>\n                <div class="p-info">\n                    <div class="p-name">${e.name}</div>\n                    <div class="p-details">\n                        <span>${s}</span>\n                        <span>Score: ${e.score}</span>\n                    </div>\n                </div>\n            `,i.appendChild(n)})}function processTurn(){if(!STATE.active)return;STATE.startTime=Date.now(),STATE.cpuTimerId&&clearTimeout(STATE.cpuTimerId);const e=STATE.players[STATE.turn];if(uiStats.turn.innerText=e.isHuman?"Your Moment":`${e.name} Reflecting...`,e.isHuman?(uiStats.timer.style.backgroundColor="var(--accent)",uiStats.board.classList.remove("desaturated")):(uiStats.timer.style.backgroundColor="#aaa",uiStats.board.classList.add("desaturated")),updateHUD(),!e.isHuman){const t=.2+.4*Math.random(),n=STATE.timeLimit*t;STATE.cpuTimerId=setTimeout(()=>{STATE.active&&!STATE.paused&&cpuMove(e.id)},n)}}function cpuMove(e){const t=CONFIG.size,n=[];for(let e=0;e<t;e++)for(let i=0;i<t;i++)null!==STATE.grid[e][i].owner||STATE.grid[e][i].frozen||n.push({r:e,c:i});if(0===n.length)return;let i=[0,.25,.5,.75,.95,1][CONFIG.difficulty],s=i+.05*STATE.roundsWon;s>1&&(s=1);let a=null;if(Math.random()<s){for(let t of n){if(STATE.grid[t.r][t.c].owner=e,checkWin(e)){a=t,STATE.grid[t.r][t.c].owner=null;break}STATE.grid[t.r][t.c].owner=null}if(!a)for(let t of n){for(let n of STATE.players)if(n.id!==e){if(STATE.grid[t.r][t.c].owner=n.id,checkWin(n.id)){a=t,STATE.grid[t.r][t.c].owner=null;break}STATE.grid[t.r][t.c].owner=null}if(a)break}}a||(a=n[Math.floor(Math.random()*n.length)]),a&&(STATE.grid[a.r][a.c].set(e),checkRoundEnd(e))}function checkWin(e){const t=CONFIG.size,n=CONFIG.win,i=(i,s,a,r)=>{for(let o=0;o<n;o++){let n=i+o*a,l=s+o*r;if(n<0||n>=t||l<0||l>=t||STATE.grid[n][l].owner!==e)return!1}return!0};for(let n=0;n<t;n++)for(let s=0;s<t;s++)if(STATE.grid[n][s].owner===e&&(i(n,s,0,1)||i(n,s,1,0)||i(n,s,1,1)||i(n,s,1,-1)))return!0;return!1}function getWinningLine(e){const t=CONFIG.size,n=CONFIG.win,i=(i,s,a,r)=>{let o=[];for(let l=0;l<n;l++){let n=i+l*a,c=s+l*r;if(n<0||n>=t||c<0||c>=t||STATE.grid[n][c].owner!==e)return null;o.push({r:n,c:c})}return o};for(let n=0;n<t;n++)for(let s=0;s<t;s++){if(STATE.grid[n][s].owner!==e)continue;let t=i(n,s,0,1)||i(n,s,1,0)||i(n,s,1,1)||i(n,s,1,-1);if(t)return t}return null}function checkRoundEnd(e){if(99!==e&&checkWin(e)){STATE.active=!1;const t=getWinningLine(e);return void handleRoundOver(e,t)}let t=!0;for(let e=0;e<CONFIG.size;e++)STATE.grid[e].some(e=>null===e.owner)&&(t=!1);if(t)return STATE.active=!1,void handleRoundOver(-1);STATE.fog=null,STATE.turn=(STATE.turn+1)%STATE.players.length,STATE.active=!0,processTurn()}function triggerShake(){const e=document.getElementById("stage-area");e.classList.remove("shake"),e.offsetWidth,e.classList.add("shake")}function handleRoundOver(e,t){t&&(STATE.winningLine=t,t.forEach(e=>{STATE.grid[e.r][e.c].highlight=!0,spawnParticles(e.c,e.r,20)})),setTimeout(()=>{if(e===STATE.players[0].id)SOUNDS.winRound(),STATE.roundsWon++,STATE.roundStreak++,STATE.players[0].score+=500,STATE.players.forEach(e=>{e.isHuman||e.lives--}),toast(`Harmony restored by ${STATE.players[0].name}. ${getQuote("WIN")}`,"gain","emoji_events"),checkRivalDeaths(),STATE.roundStreak%3==0&&(STATE.players[0].lives++,toast("The spirit mends.","gain","favorite")),setTimeout(()=>startNewRound(),2500);else if(-1===e)STATE.players.forEach(e=>{e.isHuman||e.lives--}),toast("The dream halts. Silence reigns.","gain","remove_circle_outline"),checkRivalDeaths(),setTimeout(()=>startNewRound(),2e3);else{let t=STATE.players.find(t=>t.id===e);t&&(t.score+=500,toast(`Aligned by ${t.name}. ${getQuote("LOSE")}`,"chaos",t.symbol)),SOUNDS.loseRound(),STATE.players[0].lives--,STATE.roundStreak=0,updateHUD(),triggerShake(),STATE.players[0].lives<=0?(STATE.active=!1,document.getElementById("modal-over").style.display="flex",document.getElementById("final-score").innerText=STATE.players[0].score,MUSIC.stop()):(toast("The spirit fractures.","chaos","broken_image"),setTimeout(()=>startNewRound(),2500))}},1500)}function checkRivalDeaths(){const e=STATE.players.length;STATE.players=STATE.players.filter(e=>e.isHuman||e.lives>0),STATE.players.length<e&&spawnNewRival()}function spawnNewRival(){SOUNDS.newRival(),5===CONFIG.difficulty&&(STATE.timeLimit=Math.max(500,.9*STATE.timeLimit));let e=99+Math.floor(100*Math.random()),t=getUniqueSymbol(STATE.players),n=new Player(e,t);n.lives=3,n.name="Echo",STATE.players.push(n),toast("A Deepening Shape Arrives...","chaos","visibility")}function togglePause(){STATE.active&&(STATE.paused=!STATE.paused,document.getElementById("modal-pause").style.display=STATE.paused?"flex":"none",STATE.paused&&toast("Time holds its breath.","gain","hourglass_empty"))}function triggerPulse(){STATE.cpuTimerId&&clearTimeout(STATE.cpuTimerId),triggerShake();const e=STATE.players[STATE.turn];if(e.lives--,updateHUD(),e.isHuman){if(toast(getQuote("TIMER"),"chaos","timer_off"),e.lives<=0)return SOUNDS.loseRound(),STATE.active=!1,document.getElementById("modal-over").style.display="flex",document.getElementById("final-score").innerText=STATE.players[0].score,void MUSIC.stop()}else toast(`${e.name} faded into silence`,"gain","timer_off"),e.lives<=0&&checkRivalDeaths();let t=Object.keys(ACTIVE_EVENTS).filter(e=>ACTIVE_EVENTS[e]);if(t.length>0){0===STATE.chaosBag.length&&(STATE.chaosBag=[...t],STATE.chaosBag.sort(()=>Math.random()-.5));let e=STATE.chaosBag.pop();for(;e&&!ACTIVE_EVENTS[e]&&0!==STATE.chaosBag.length;)e=STATE.chaosBag.pop();if(e){const t=EVENT_DEFS.find(t=>t.id===e),n=t?t.name:"Pulse";toast(`${n}: ${getQuote("CHAOS")}`,"chaos","flash_on"),spawnParticles(20*CONFIG.size,20*CONFIG.size,20),applyEventEffect(e)}}STATE.active&&checkRoundEnd(99)}function applyEventEffect(e){const t=e=>{const t=e||CONFIG.size;return Array(t).fill(null).map((e,n)=>Array(t).fill(null).map((e,t)=>new Cell(n,t)))};if("expand"===e){if(CONFIG.size<8){const e=CONFIG.size;CONFIG.size++;const n=t(CONFIG.size);for(let t=0;t<e;t++)for(let i=0;i<e;i++){const e=STATE.grid[t][i];n[t][i].owner=e.owner,n[t][i].visualOwner=e.visualOwner,n[t][i].frozen=e.frozen,n[t][i].alpha=1}STATE.grid=n,resizeCanvas()}}else if("new_player"===e)spawnNewRival();else if("fog"===e){const e=Math.floor(3*Math.random());STATE.fog={type:["row","col","diag"][e],val:Math.floor(Math.random()*(2===e?2:CONFIG.size))}}else if("gravity"===e)for(let e=0;e<CONFIG.size;e++){let t=[];for(let n=0;n<CONFIG.size;n++)null!==STATE.grid[n][e].owner&&t.push(STATE.grid[n][e].owner);for(let n=CONFIG.size-1;n>=0;n--)STATE.grid[n][e].owner=t.length>0?t.pop():null,STATE.grid[n][e].visualOwner=STATE.grid[n][e].owner}else if("scramble"===e){let e=[];for(let t=0;t<CONFIG.size;t++)for(let n=0;n<CONFIG.size;n++)null!==STATE.grid[t][n].owner&&e.push(STATE.grid[t][n].owner);e.sort(()=>Math.random()-.5);let t=[];for(let e=0;e<CONFIG.size;e++)for(let n=0;n<CONFIG.size;n++)t.push({r:e,c:n});t.sort(()=>Math.random()-.5);for(let e=0;e<CONFIG.size;e++)for(let t=0;t<CONFIG.size;t++)STATE.grid[e][t].owner=null,STATE.grid[e][t].visualOwner=null;for(let n=0;n<e.length;n++){let i=t[n];STATE.grid[i.r][i.c].owner=e[n],STATE.grid[i.r][i.c].visualOwner=e[n]}}else if("vertigo"===e){let e=t();for(let t=0;t<CONFIG.size;t++)for(let n=0;n<CONFIG.size;n++){let i=STATE.grid[t][n],s=n,a=CONFIG.size-1-t;e[s][a].owner=i.owner,e[s][a].visualOwner=i.visualOwner}STATE.grid=e}else if("doppel"===e){let e=[];for(let t=0;t<CONFIG.size;t++)for(let n=0;n<CONFIG.size;n++)null===STATE.grid[t][n].owner&&e.push({r:t,c:n});if(e.length>0){let t=e[Math.floor(Math.random()*e.length)];STATE.grid[t.r][t.c].visualOwner=STATE.players[STATE.turn].id}}else if("frost"===e){let e=Math.floor(Math.random()*CONFIG.size),t=Math.floor(Math.random()*CONFIG.size);STATE.grid[e][t].frozen=!0}else if("vacuum"===e){let e=Math.floor(Math.random()*(CONFIG.size-1)),t=Math.floor(Math.random()*(CONFIG.size-1));STATE.grid[e][t].owner=null,STATE.grid[e][t].visualOwner=null,STATE.grid[e+1][t].owner=null,STATE.grid[e+1][t].visualOwner=null,STATE.grid[e][t+1].owner=null,STATE.grid[e][t+1].visualOwner=null,STATE.grid[e+1][t+1].owner=null,STATE.grid[e+1][t+1].visualOwner=null}else if("intruder"===e){let e=[];for(let t=0;t<CONFIG.size;t++)for(let n=0;n<CONFIG.size;n++)null===STATE.grid[t][n].owner&&e.push({r:t,c:n});if(e.length>0){let t=e[Math.floor(Math.random()*e.length)];STATE.grid[t.r][t.c].owner=999,STATE.grid[t.r][t.c].visualOwner=999}}else if("gust"===e){let e=[];for(let t=0;t<CONFIG.size;t++)for(let n=0;n<CONFIG.size;n++)null!==STATE.grid[t][n].owner&&e.push({r:t,c:n});if(e.length>0){let t=e[Math.floor(Math.random()*e.length)];STATE.grid[t.r][t.c].owner=null,STATE.grid[t.r][t.c].visualOwner=null}}else if("crosswind"===e){let e=[];for(let t=0;t<CONFIG.size;t++)for(let n=0;n<CONFIG.size;n++)null!==STATE.grid[t][n].owner&&999!==STATE.grid[t][n].owner&&e.push({r:t,c:n,o:STATE.grid[t][n].owner});if(e.length>0){let t=e[Math.floor(Math.random()*e.length)],n=[{r:t.r+1,c:t.c},{r:t.r-1,c:t.c},{r:t.r,c:t.c+1},{r:t.r,c:t.c-1}].filter(e=>e.r>=0&&e.r<CONFIG.size&&e.c>=0&&e.c<CONFIG.size&&null===STATE.grid[e.r][e.c].owner);if(n.length>0){let e=n[Math.floor(Math.random()*n.length)];STATE.grid[e.r][e.c].set(t.o)}}}}function shareTwitter(){const e="https://julibe.com/",t="Julibe",n=["Just wandered through the mists of E•the•real. A drifting strategy of silence and chaos.","Aligned my thoughts against the entropy. E•the•real turns the grid into a dream.","The pulse shifts, the grid turns. A beautiful, meditative puzzle experience by @Julibe.","Drift, align, survive. Found harmony in the void of E•the•real.","Lost in the echo. A serene yet challenging reimagining of strategy."],i=["Dev","CreativeCoding","GenerativeArt","WebGame","Canvas","Ambient","PuzzleGame","Strategy","Relaxing","Javascript","FrontEnd"],s=n[Math.floor(Math.random()*n.length)];let a=i.sort(()=>.5-Math.random()).slice(0,4).map(e=>e.replace(/\s+/g,""));const r=23,o=6+t.length,l=280;for(;a.length>0;){const e=a.reduce((e,t)=>e+t.length+2,0),t=s.length+r+o+e;if(t<=l)break;a.pop()}const c=a.join(","),d=`https://twitter.com/intent/tweet?text=${encodeURIComponent(s)}&url=${encodeURIComponent(e)}&hashtags=${encodeURIComponent(c)}&via=${encodeURIComponent(t)}`;window.open(d,"_blank")}const THEMES=[{bg:"linear-gradient(180deg, #fdfbfd 0%, #f9f4ff 100%)",board:"linear-gradient(180deg, #a18cd1 0%, #fbc2eb 100%)",accent:"#c471ed"},{bg:"linear-gradient(180deg, #fff5f5 0%, #ffe6e6 100%)",board:"linear-gradient(180deg, #ff9a9e 0%, #fecfef 100%)",accent:"#ff9a9e"},{bg:"linear-gradient(135deg, #f0fff4 0%, #e6fffa 100%)",board:"linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%)",accent:"#84fab0"},{bg:"linear-gradient(135deg, #fffaf0 0%, #fff5f5 100%)",board:"linear-gradient(135deg, #fccb90 0%, #d57eeb 100%)",accent:"#d57eeb"},{bg:"linear-gradient(135deg, #f3f0ff 0%, #ebf8ff 100%)",board:"linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%)",accent:"#e0c3fc"},{bg:"linear-gradient(135deg, #f0ffff 0%, #fff0f5 100%)",board:"linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)",accent:"#a8edea"}];let currentThemeColor="#c471ed";const SYMBOLS_POOL=["close","radio_button_unchecked","change_history","crop_square","diamond","star_border","hexagon","bolt","spa","ac_unit","filter_drama","brightness_7"],NAMES=["The Weaver of Mist","The Silent Mender","The Void Sage","The Drifting Echo","The Observer of Time","The Pale Guardian","The Lunar Mystic","The Hollow Voice","Mistborne Custodian","Echo of the Last Lantern","Silent Veilwalker","Keeper of Waning Runes","Ashen-Seer of the Vale","Warden of Quiet Horizons","Oracle of Pale Tides","Driftbound Pilgrim","Shoreless Wanderer","Sage of the Faint Pulse","Celestial Threadbinder","Watcher of the Fallow Sky","Mender of Lost Whispers","Horizon Shaper","Seeker of Hollow Roads","Voice Beneath the Stillwater","Nomad of the Dim Path","Gloomlight Scribe","Whisperborne Herald","Cartographer of Unseen Trails","Keeper of the Last Ember","Frostlit Observer","Warden of Sleeping Fields","Spirit of the Soft Quiet","Moonwither Oracle","Emberbound Listener","Traveler of the Fading Crossroads","Harvester of Silent Echoes","Astral Thread Seeker","Murmur of the Forgotten Well"],DEFAULT_NAMES=NAMES,QUOTES={WIN:["The stars align in your favor.","A perfect resonance is found.","The dream stabilizes into form.","Order emerges from the mist.","The pattern reveals its hidden symmetry.","Light gathers at your footsteps.","Your intent shapes the current.","The veil parts in quiet acceptance.","All threads converge with grace.","The echo sings in harmony with you.","Even the void nods in approval.","The tide bends around your will.","A silent bloom unfolds within the moment.","Clarity settles like falling snow.","The unseen paths open to greet you.","Balance leans gently toward your side.","A soft radiance follows your choice.","The horizon brightens for an instant.","You rise through still air.","The hum of creation steadies around you.","Your step resonates with quiet strength.","The drifting veil glimmers with promise.","The world exhales in calm alignment.","The lattice of fate responds in kind.","A distant voice whispers approval.","Your presence steadies the trembling fabric.","The silence offers you a small smile.","The wandering tide bows to your motion.","The moment crowns you with subtle light.","The hidden truth reflects your victory.","Even the faintest echoes brighten.","The void holds its breath in respect.","A calm spark ignites within the ether.","The mist folds itself around your triumph."],LOSE:["The fracture widens.","The echo drowns the signal.","Chaos claims this moment.","A lesson written in echoes.","The ground trembles beneath misaligned fate.","The mist recoils from your grasp.","A quiet discord hums in the distance.","The path slips from beneath your feet.","A hollow chill lingers in the air.","The tide abandons its rhythm.","Your echo fades before it finds shape.","The moment frays at the edges.","A dull ache spreads through the pattern.","Shadows reclaim their territory.","Your step falls out of harmony.","The world turns its face away for now.","The lattice rejects your touch.","The wind carries a muted warning.","Clarity slips through your grasp.","The horizon dims without hesitation.","A faint crack disrupts the foundation.","The whisper you reach for dissolves.","The signal weakens into static.","The air tightens with misfortune.","The void answers with indifference.","Your thread drifts into uncertainty.","Stillness becomes uneasy around you.","The current twists out of alignment.","A silent tremor marks the moment.","The unseen paths close their eyes.","The echo returns without recognition.","The moment folds against your intent.","The mask of fate reveals cold neutrality.","The dream rejects your footprint."],CHAOS:["Reality ripples like water...","A sudden shift in the wind.","The laws of the void bend.","Patterns unravel without warning.","Time loops around your thoughts.","Stillness trembles at the edges.","The air flickers as if dreaming.","Possibility multiplies in all directions.","The mist rearranges itself in confusion.","Nothing stands where it once did.","The ground hums in strange resonance.","A spark leaps between unseen points.","Your senses blur into one another.","The sky tilts for a heartbeat.","Fate hesitates, then splits in two.","The void laughs softly to itself.","The horizon jumps forward a step.","Uncertainty blossoms like wildfire.","A ringing note echoes from nowhere.","The moment twists into an impossible shape.","Order loosens its grip on reality.","Colors shift in unpredictable waves.","The dream shivers awake.","Shadows forget where they belong.","The world blinks out, then in again.","Heat and cold trade places.","The edges of everything melt.","A whisper becomes a roar, then silence.","Crossroads multiply under your feet.","The unseen stirs without intention.","Gravity hums in a foreign scale.","A familiar shape turns unfamiliar.","Meaning unravels then reforms."],TIMER:["Time dissolves into mist.","Hold fast to your essence.","The moment slips away.","Seconds unwind like loose thread.","The clock hesitates in mid pulse.","A soft chime echoes from nowhere.","Your breath floats between stillness and hurry.","Each instant grows thin around the edges.","The world pauses in contemplative quiet.","The next moment peers at you expectantly.","You feel the weight of passing minutes.","The present stretches, fragile and bright.","Every heartbeat counts more than the last.","The horizon blurs with fleeting light.","The tick behind your ear slows.","The future leans closer with curiosity.","Moments begin to drip like water.","Your shadow shortens in anticipation.","Silence grows warm with waiting.","Time coils gently at your feet.","The pace of the world sidesteps you.","Your focus sharpens despite the tide.","Night and day blur at the seams.","A faint ringing marks the transition.","The next heartbeat pulls you forward.","Stillness holds you for a breath.","Your thoughts move faster than time.","The minute hand stirs impatiently.","The present exhales a thin sigh.","The tempo around you fluctuates.","Moments crumble like dried petals.","The now becomes a fleeting spark.","Your awareness glows in the pause."]},EVENT_DEFS=[{id:"gravity",name:"Tide",desc:"The heavy pull of the tide moves all marks."},{id:"scramble",name:"Ripple",desc:"A disturbance scatters the pattern."},{id:"vertigo",name:"Tilt",desc:"The world turns on its unseen axis."},{id:"doppel",name:"Mirage",desc:"A deceptive shape manifests from nothing."},{id:"fog",name:"Veil",desc:"A thick mist obscures the truth."},{id:"intruder",name:"Artifact",desc:"Ancient debris clutters the void."},{id:"vacuum",name:"Hollow",desc:"Existence is consumed by a sudden void."},{id:"frost",name:"Silence",desc:"A cold stillness freezes time in a cell."},{id:"crosswind",name:"Bloom",desc:"A mark expands into its neighbors."},{id:"gust",name:"Lapse",desc:"A memory fades into nothingness."},{id:"expand",name:"Horizon",desc:"The boundaries of the dream stretch further."},{id:"new_player",name:"Presence",desc:"Another soul enters the drift."}];let CONFIG={size:6,win:3,enemies:2,baseTime:3e3,difficulty:1,startLives:3};const audioCtx=new(window.AudioContext||window.webkitAudioContext),masterGain=audioCtx.createGain();masterGain.connect(audioCtx.destination),masterGain.gain.value=.3;let isMuted=!1;class AmbientMusic{constructor(){this.playing=!1,this.timer=null,this.notes=[261.63,293.66,329.63,392,440,523.25]}playNote(){if(!this.playing||"suspended"===audioCtx.state)return;const e=this.notes[Math.floor(Math.random()*this.notes.length)],t=audioCtx.createOscillator(),n=audioCtx.createGain(),i=audioCtx.createBiquadFilter();t.type="sine",t.frequency.setValueAtTime(e,audioCtx.currentTime),i.type="lowpass",i.frequency.setValueAtTime(800,audioCtx.currentTime);const s=audioCtx.currentTime,a=4+2*Math.random();n.gain.setValueAtTime(0,s),n.gain.linearRampToValueAtTime(.08,s+2),n.gain.exponentialRampToValueAtTime(.001,s+a),t.connect(i),i.connect(n),n.connect(masterGain),t.start(),t.stop(s+a+1),this.timer=setTimeout(()=>this.playNote(),2e3*Math.random()+1500)}start(){this.playing||(this.playing=!0,"suspended"===audioCtx.state&&audioCtx.resume(),this.playNote())}stop(){this.playing=!1,clearTimeout(this.timer)}}const MUSIC=new AmbientMusic,SOUNDS={play:(e,t,n,i=.05)=>{"suspended"===audioCtx.state&&audioCtx.resume();const s=audioCtx.createOscillator(),a=audioCtx.createGain();s.type=t,s.frequency.setValueAtTime(e,audioCtx.currentTime),a.gain.setValueAtTime(0,audioCtx.currentTime),a.gain.linearRampToValueAtTime(i,audioCtx.currentTime+.05),a.gain.linearRampToValueAtTime(0,audioCtx.currentTime+n),s.connect(a),a.connect(masterGain),s.start(),s.stop(audioCtx.currentTime+n)},move:()=>SOUNDS.play(600,"sine",.2,.08),winRound:()=>{SOUNDS.play(523,"sine",.4),setTimeout(()=>SOUNDS.play(659,"sine",.4),100),setTimeout(()=>SOUNDS.play(783,"sine",.6),200)},loseRound:()=>{SOUNDS.play(400,"sine",.4),setTimeout(()=>SOUNDS.play(300,"sine",.6),200)},newRival:()=>{SOUNDS.play(200,"sine",.8,.1),setTimeout(()=>SOUNDS.play(150,"sine",.8,.1),200)}};class BackgroundAnim{constructor(){this.canvas=document.getElementById("bg-canvas"),this.ctx=this.canvas.getContext("2d"),this.items=[],this.symbols=SYMBOLS_POOL,this.resize(),window.addEventListener("resize",()=>this.resize()),this.mouseX=-1e3,this.mouseY=-1e3,window.addEventListener("mousemove",e=>{this.mouseX=e.clientX,this.mouseY=e.clientY}),this.initItems(),this.loop()}resize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight}initItems(){for(let e=0;e<16;e++)this.items.push({x:Math.random()*this.canvas.width,y:Math.random()*this.canvas.height,size:40*Math.random()+20,symbol:this.symbols[Math.floor(Math.random()*this.symbols.length)],vx:.4*(Math.random()-.5),vy:.4*(Math.random()-.5),rotation:Math.random()*Math.PI*2,vRot:.01*(Math.random()-.5)})}loop(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.items.forEach(e=>{let t=e.x-this.mouseX,n=e.y-this.mouseY,i=Math.sqrt(t*t+n*n);if(i<150){let s=(150-i)/150;e.vx+=t/i*s*.05,e.vy+=n/i*s*.05}e.x+=e.vx,e.y+=e.vy,e.rotation+=e.vRot,e.vx*=.99,e.vy*=.99,e.x<-100&&(e.x=this.canvas.width+100),e.x>this.canvas.width+100&&(e.x=-100),e.y<-100&&(e.y=this.canvas.height+100),e.y>this.canvas.height+100&&(e.y=-100),this.ctx.save(),this.ctx.translate(e.x,e.y),this.ctx.rotate(e.rotation),this.ctx.font=`${e.size}px 'Material Icons'`,this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillStyle=currentThemeColor,this.ctx.globalAlpha=.15,this.ctx.fillText(e.symbol,0,0),this.ctx.restore()}),requestAnimationFrame(()=>this.loop())}}new BackgroundAnim;let selectedPlayerSymbol="close",ACTIVE_EVENTS={};EVENT_DEFS.forEach(e=>ACTIVE_EVENTS[e.id]=!0);const STATE={grid:[],turn:0,players:[],active:!1,paused:!1,startTime:0,timeLimit:0,fog:null,lives:3,roundsWon:0,roundStreak:0,floatingTexts:[],chaosBag:[],cpuTimerId:null,winningLine:null,ripples:[],mouse:{x:-1e3,y:-1e3}};class Player{constructor(e,t,n){this.id=e,this.isHuman=0===e,this.name=this.isHuman?n||"You":NAMES[e%NAMES.length],this.symbol=t,this.score=0,this.lives=3}}class Cell{constructor(e,t){this.r=e,this.c=t,this.owner=null,this.visualOwner=null,this.frozen=!1,this.alpha=0,this.highlight=!1}set(e){this.owner=e,this.visualOwner=e,this.alpha=0,spawnParticles(this.c,this.r,8),addRipple(this.c,this.r),SOUNDS.move()}update(){this.alpha<1&&(this.alpha+=.05)}}let particles=[];class Particle{constructor(e,t){this.x=e,this.y=t;const n=6.28*Math.random(),i=1*Math.random();this.vx=Math.cos(n)*i,this.vy=Math.sin(n)*i,this.life=1,this.decay=.02*Math.random()+.01}update(){this.x+=this.vx,this.y+=this.vy,this.life-=this.decay}draw(e){e.globalAlpha=.5*this.life,e.fillStyle="#fff",e.beginPath(),e.arc(this.x,this.y,1.5,0,2*Math.PI),e.fill(),e.globalAlpha=1}}class Ripple{constructor(e,t,n){this.x=e,this.y=t,this.r=0,this.maxR=.8*n,this.alpha=1,this.lw=3}update(){this.r+=2,this.alpha-=.04,this.lw-=.1}draw(e){this.alpha<=0||(e.save(),e.beginPath(),e.arc(this.x,this.y,this.r,0,2*Math.PI),e.strokeStyle=`rgba(255,255,255,${this.alpha})`,e.lineWidth=Math.max(.1,this.lw),e.stroke(),e.restore())}}class FloatingText{constructor(e,t,n){this.x=e,this.y=t,this.text=n,this.life=1,this.vy=-1.5}update(){this.y+=this.vy,this.life-=.02}draw(e){e.save(),e.globalAlpha=Math.max(0,this.life),e.fillStyle="var(--accent)",e.font="bold 20px 'Helvetica Neue', Arial, sans-serif",e.textAlign="center",e.shadowColor="rgba(255,255,255,0.8)",e.shadowBlur=4,e.fillText(this.text,this.x,this.y),e.restore()}}const canvas=document.getElementById("game-canvas"),ctx=canvas.getContext("2d"),uiStats={lives:document.getElementById("disp-lives"),score:document.getElementById("disp-score"),turn:document.getElementById("turn-text"),timer:document.getElementById("timer-bar"),board:document.getElementById("canvas-wrap")
};window.addEventListener("resize",resizeCanvas),window.addEventListener("blur",()=>{STATE.active&&!STATE.paused&&togglePause()}),document.getElementById("music-ctrl").addEventListener("click",e=>{isMuted=!isMuted,isMuted?(masterGain.gain.setValueAtTime(0,audioCtx.currentTime),e.currentTarget.innerHTML='<i class="material-icons">volume_off</i>',e.currentTarget.style.color="#bbb"):("suspended"===audioCtx.state&&audioCtx.resume(),masterGain.gain.setValueAtTime(1,audioCtx.currentTime),e.currentTarget.innerHTML='<i class="material-icons">volume_up</i>',e.currentTarget.style.color="var(--accent)",MUSIC.playing||MUSIC.start())}),canvas.addEventListener("mousemove",e=>{const t=canvas.getBoundingClientRect();STATE.mouse.x=e.clientX-t.left,STATE.mouse.y=e.clientY-t.top}),canvas.addEventListener("mouseleave",()=>{STATE.mouse.x=-1e3,STATE.mouse.y=-1e3}),canvas.addEventListener("mousedown",e=>handleInteraction(e.clientX,e.clientY)),canvas.addEventListener("touchstart",e=>{e.preventDefault(),handleInteraction(e.touches[0].clientX,e.touches[0].clientY)},{passive:!1}),document.getElementById("inp-name").value=DEFAULT_NAMES[Math.floor(Math.random()*DEFAULT_NAMES.length)];const symContainer=document.getElementById("sym-select-row");SYMBOLS_POOL.forEach(e=>{const t=document.createElement("div");t.className="sym-btn",e===selectedPlayerSymbol&&t.classList.add("selected"),t.innerHTML=`<i class="material-icons">${e}</i>`,t.addEventListener("click",()=>{document.querySelectorAll(".sym-btn").forEach(e=>e.classList.remove("selected")),t.classList.add("selected"),selectedPlayerSymbol=e}),symContainer.appendChild(t)});const listContainer=document.getElementById("events-list-container");EVENT_DEFS.forEach(e=>{const t=document.createElement("div");t.className="event-item",t.innerHTML=`\n            <div class="event-head">\n                <input type="checkbox" id="chk-${e.id}" checked>\n                <span>${e.name}</span>\n            </div>\n            <div class="event-desc">${e.desc}</div>`,listContainer.appendChild(t),t.querySelector("input").addEventListener("change",t=>{ACTIVE_EVENTS[e.id]=t.target.checked})}),document.getElementById("btn-events").addEventListener("click",()=>{document.getElementById("modal-events").style.display="flex"}),document.getElementById("btn-close-events").addEventListener("click",()=>{document.getElementById("modal-events").style.display="none"}),document.querySelectorAll(".btn-close-overlay").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".overlay").forEach(e=>e.style.display="none")})}),document.getElementById("btn-open-intro").addEventListener("click",()=>{document.getElementById("modal-intro").style.display="flex"}),document.getElementById("btn-open-theory").addEventListener("click",()=>{document.getElementById("modal-theory").style.display="flex"}),document.getElementById("btn-open-rules").addEventListener("click",()=>{document.getElementById("modal-rules").style.display="flex"}),document.getElementById("btn-open-about").addEventListener("click",()=>{document.getElementById("modal-about").style.display="flex"}),document.getElementById("btn-start").addEventListener("click",initGame),document.getElementById("btn-pause").addEventListener("click",togglePause),document.getElementById("btn-resume").addEventListener("click",togglePause),document.getElementById("btn-quit").addEventListener("click",toMenu),document.getElementById("btn-menu-back").addEventListener("click",toMenu),document.getElementById("btn-replay").addEventListener("click",()=>{document.getElementById("modal-over").style.display="none",initGame()});