function submitSetup(){let e=parseInt(dom.inpRows.value)||9,t=parseInt(dom.inpCols.value)||9,a=parseInt(dom.inpMines.value)||10;e=Math.max(5,Math.min(30,e)),t=Math.max(5,Math.min(30,t)),a=Math.max(1,Math.min(a,Math.floor(e*t*.8))),baseConfig={rows:e,cols:t,mines:a},dom.setup.style.display="none",restartGame()}function restartGame(){state.hp=3,state.level=1,state.score=0,state.items={scan:1,heal:0},dom.overlay.style.display="none",startLevel()}function startLevel(){state.grid=[],state.gameOver=!1,state.firstClick=!0,state.bombTimers.forEach(clearInterval),state.bombTimers=[],clearInterval(state.chaosInterval),clearInterval(state.timerInterval);const e=Math.floor((state.level-1)/2);config.rows=baseConfig.rows+e,config.cols=baseConfig.cols+e;const t=baseConfig.mines/(baseConfig.rows*baseConfig.cols),a=2*(state.level-1);config.mines=Math.floor(config.rows*config.cols*t)+a,state.flags=config.mines,renderGrid(),updateHUD(),dom.face.innerText="ðŸ™‚",dom.face.style.backgroundColor="var(--c-yellow)",dom.overlay.style.display="none",state.startTime=Date.now(),state.timerInterval=setInterval(updateTimer,1e3),state.chaosInterval=setInterval(chaosEvent,5e3)}function renderGrid(){dom.grid.style.gridTemplateColumns=`repeat(${config.cols}, 40px)`,dom.grid.innerHTML="";for(let e=0;e<config.rows;e++){let t=[];for(let a=0;a<config.cols;a++){const s={r:e,c:a,isMine:!1,revealed:!1,flagged:!1,neighbors:0,isTrap:!1,trapHp:0,isBomb:!1,bombTime:0,el:document.createElement("div")};s.el.className="tile",s.el.onmouseup=(e=>handleInput(e,s)),s.el.oncontextmenu=(e=>e.preventDefault()),dom.grid.appendChild(s.el),t.push(s)}state.grid.push(t)}let e=Math.floor(state.level/2)+2;for(;e>0;){let t=Math.floor(Math.random()*config.rows),a=Math.floor(Math.random()*config.cols);state.grid[t][a].isTrap||(state.grid[t][a].isTrap=!0,state.grid[t][a].trapHp=3,state.grid[t][a].el.classList.add("trap"),e--)}}function handleInput(e,t){state.gameOver||(2===e.button?toggleFlag(t):0===e.button&&(t.isTrap?hitTrap(t):clickTile(t)))}function clickTile(e){e.flagged||e.revealed||(state.firstClick&&(state.firstClick=!1,generateMines(e)),e.isMine?triggerMine(e):reveal(e))}function generateMines(e){let t=0;for(;t<config.mines;){let a=Math.floor(Math.random()*config.rows),s=Math.floor(Math.random()*config.cols),o=state.grid[a][s];o.isMine||o.isTrap||Math.abs(a-e.r)<=1&&Math.abs(s-e.c)<=1||(o.isMine=!0,t++)}for(let e=0;e<config.rows;e++)for(let t=0;t<config.cols;t++)if(!state.grid[e][t].isMine){let a=0;getNeighbors(e,t).forEach(e=>{e.isMine&&a++}),state.grid[e][t].neighbors=a}}function reveal(e){e.revealed||e.flagged||(e.revealed=!0,e.el.classList.add("revealed"),e.el.classList.add(`val-${e.neighbors}`),e.neighbors>0?e.el.innerText=e.neighbors:getNeighbors(e.r,e.c).forEach(e=>{e.revealed||e.isTrap||reveal(e)}),Math.random()<.02&&(Math.random()>.5?(state.items.scan++,showFloat(e,"+ðŸ“¡")):(state.items.heal++,showFloat(e,"+ðŸ’Š")),updateHUD()),checkLevelClear())}function toggleFlag(e){e.revealed||(e.flagged=!e.flagged,e.el.classList.toggle("flagged"),state.flags+=e.flagged?-1:1,e.isBomb&&e.flagged&&e.isMine&&defuseBomb(e),updateHUD())}function hitTrap(e){e.trapHp--,e.el.style.transform="scale(0.9)",setTimeout(()=>e.el.style.transform="scale(1)",100),e.trapHp<=0&&(e.isTrap=!1,e.el.classList.remove("trap"),e.isMine||reveal(e))}function triggerMine(e){e.el.classList.add("mine"),state.hp--,dom.face.innerText="ðŸ˜£",dom.face.style.backgroundColor="var(--c-magenta)",document.body.style.transform="translate(5px, 0)",setTimeout(()=>document.body.style.transform="none",50),setTimeout(()=>{state.gameOver||(dom.face.innerText="ðŸ™‚",dom.face.style.backgroundColor="var(--c-yellow)")},600),updateHUD(),state.hp<=0&&gameOver()}function chaosEvent(){if(!state.gameOver&&Math.random()<.3){let e=[];if(state.grid.forEach(t=>t.forEach(t=>{!t.isMine||t.revealed||t.flagged||t.isBomb||e.push(t)})),e.length>0){let t=e[Math.floor(Math.random()*e.length)];activateBomb(t)}}}function activateBomb(e){e.isBomb=!0,e.bombTime=10,e.el.classList.add("time-bomb"),e.el.setAttribute("data-timer","10s");let t=setInterval(()=>{!state.gameOver&&e.isBomb?(e.bombTime--,e.el.setAttribute("data-timer",e.bombTime+"s"),e.bombTime<=0&&(clearInterval(t),e.flagged||(e.el.classList.remove("time-bomb"),triggerMine(e),e.revealed=!0,e.el.classList.add("mine","revealed")))):clearInterval(t)},1e3);state.bombTimers.push(t)}function defuseBomb(e){e.isBomb=!1,e.el.classList.remove("time-bomb"),state.score+=50,showFloat(e,"+50"),updateHUD()}function useItem(e){if(!(state.items[e]<=0))if("heal"===e)state.hp<state.maxHp&&(state.items.heal--,state.hp++,updateHUD());else if("scan"===e){state.items.scan--;let e=Math.floor(Math.random()*(config.rows-2))+1,t=Math.floor(Math.random()*(config.cols-2))+1;for(let a=-1;a<=1;a++)for(let s=-1;s<=1;s++){let o=state.grid[e+a][t+s];o.isMine||o.revealed||reveal(o),o.isMine&&!o.flagged&&toggleFlag(o)}updateHUD()}}function getNeighbors(e,t){let a=[];for(let s=-1;s<=1;s++)for(let o=-1;o<=1;o++)0==s&&0==o||e+s>=0&&e+s<config.rows&&t+o>=0&&t+o<config.cols&&a.push(state.grid[e+s][t+o]);return a}function updateHUD(){dom.flags.innerText=state.flags.toString().padStart(3,"0"),dom.hp.innerText=state.hp+"/"+state.maxHp,dom.lvl.innerText=state.level,dom.score.innerText=state.score,dom.scanQty.innerText=state.items.scan,dom.healQty.innerText=state.items.heal,document.getElementById("btn-heal").disabled=0===state.items.heal||state.hp===state.maxHp,document.getElementById("btn-scan").disabled=0===state.items.scan}function updateTimer(){let e=Math.floor((Date.now()-state.startTime)/1e3),t=Math.floor(e/60).toString().padStart(2,"0"),a=(e%60).toString().padStart(2,"0");dom.timer.innerText=`${t}:${a}`}function showFloat(e,t){let a=document.createElement("div");a.innerText=t,a.style.position="absolute",a.style.color="var(--c-cyan)",a.style.fontWeight="bold",a.style.fontSize="20px",a.style.textShadow="1px 1px 0 white",a.style.pointerEvents="none",a.style.zIndex=100;let s=e.el.getBoundingClientRect();a.style.left=s.left+"px",a.style.top=s.top+"px",document.body.appendChild(a);let o=0,l=setInterval(()=>{o-=2,a.style.transform=`translateY(${o}px)`,a.style.opacity=1+o/30,o<-30&&(clearInterval(l),a.remove())},16)}function checkLevelClear(){let e=0;state.grid.forEach(t=>t.forEach(t=>{t.isMine||t.revealed||e++})),0===e&&(state.score+=100*state.level,state.level++,dom.ovTitle.innerText="LEVEL CLEAR!",dom.ovTitle.style.color="var(--c-cyan)",dom.ovMsg.innerText="Moving to next sector...",dom.overlay.style.display="flex",setTimeout(startLevel,1500))}function gameOver(){state.gameOver=!0,dom.face.innerText="ðŸ˜µ",dom.face.style.backgroundColor="var(--c-magenta)",state.grid.forEach(e=>e.forEach(e=>{e.isMine&&(e.el.classList.add("mine"),e.el.classList.add("revealed"))})),clearInterval(state.timerInterval),clearInterval(state.chaosInterval),state.bombTimers.forEach(clearInterval),dom.ovTitle.innerText="GAME OVER",dom.ovTitle.style.color="var(--c-magenta)",dom.ovMsg.innerText=`Level: ${state.level} | Score: ${state.score}`,dom.overlay.style.display="flex"}let baseConfig={rows:9,cols:9,mines:10},config={rows:9,cols:9,mines:10},state={grid:[],gameOver:!1,firstClick:!0,hp:3,maxHp:3,level:1,score:0,flags:10,items:{scan:1,heal:0},startTime:0,timerInterval:null,chaosInterval:null,bombTimers:[]};const dom={setup:document.getElementById("setup-screen"),inpRows:document.getElementById("set-rows"),inpCols:document.getElementById("set-cols"),inpMines:document.getElementById("set-mines"),grid:document.getElementById("grid"),flags:document.getElementById("flag-cnt"),timer:document.getElementById("timer-disp"),face:document.getElementById("face-btn"),hp:document.getElementById("hp-val"),lvl:document.getElementById("lvl-val"),score:document.getElementById("score-val"),scanQty:document.getElementById("scan-qty"),healQty:document.getElementById("heal-qty"),overlay:document.getElementById("overlay"),ovTitle:document.getElementById("ov-title"),ovMsg:document.getElementById("ov-msg")};