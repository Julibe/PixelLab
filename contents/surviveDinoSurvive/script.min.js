function spawnMeteor(){if(state.won)return;const e=LEVELS[state.levelIdx]||LEVELS[0];state.meteors.length<e.palette.meteors&&state.meteors.push({x:800*Math.random()+200,y:-100,size:10*Math.random()+5,speedX:-2-4*Math.random(),speedY:4+6*Math.random()})}function spawnParticles(){if(state.won)return;if(state.levelIdx<3)return;const e=state.levelIdx-2;state.particles.length<30*e&&state.particles.push({x:800*Math.random(),y:-10,speedY:2*Math.random()+1,speedX:2*(Math.random()-.5),size:3*Math.random()+1,type:Math.random()>.7?"ember":"ash",life:1})}function draw(){let e=LEVELS[state.levelIdx]?LEVELS[state.levelIdx].palette:LEVELS[0].palette;if(state.won&&(e=PARADISE_PALETTE),ctx.save(),!state.won&&(state.danger>80||state.levelIdx>=5)){const e=(state.danger>80?.2*(state.danger-80):0)+(state.levelIdx>=5?2:0),t=(Math.random()-.5)*e,s=(Math.random()-.5)*e;ctx.translate(t,s)}let t=ctx.createLinearGradient(0,0,0,500);t.addColorStop(0,e.skyTop),t.addColorStop(1,e.skyBot),ctx.fillStyle=t,ctx.fillRect(0,0,800,500),ctx.fillStyle=e.sun,ctx.beginPath();let s=600-40*state.levelIdx,a=100+30*state.levelIdx;state.won&&(s=600,a=100),ctx.arc(s,a,60,0,2*Math.PI),ctx.fill(),ctx.fillStyle="rgba(0,0,0,0.3)";for(let e=0;e<3;e++){let t=(300*e-.1*state.bgOffset)%1e3;t<-200&&(t+=1e3),ctx.beginPath(),ctx.moveTo(t,500),ctx.lineTo(t+150,250),ctx.lineTo(t+300,500),ctx.fill()}if(state.active&&!state.won){spawnMeteor();for(let e=state.meteors.length-1;e>=0;e--){let t=state.meteors[e];t.x+=t.speedX,t.y+=t.speedY,ctx.fillStyle=`rgba(255, ${255-30*state.levelIdx}, 0, 0.6)`,ctx.beginPath(),ctx.moveTo(t.x,t.y),ctx.lineTo(t.x-10*t.speedX,t.y-10*t.speedY),ctx.lineTo(t.x+t.size,t.y),ctx.fill(),ctx.fillStyle="#fff",ctx.fillRect(t.x,t.y,t.size,t.size),t.y>550&&state.meteors.splice(e,1)}}ctx.fillStyle=e.ground,ctx.fillRect(0,420,800,80),ctx.fillStyle=e.grass;for(let t=0;t<15;t++){let s=(100*t-state.bgOffset)%900;s<-50&&(s+=900),state.won||state.levelIdx<4?(ctx.beginPath(),ctx.arc(s,420,20,0,2*Math.PI),ctx.fill()):(ctx.fillRect(s,400,5,20),state.levelIdx>6&&!state.won&&(ctx.fillStyle="orange",ctx.fillRect(s,395,5,5),ctx.fillStyle=e.grass))}if(state.won&&(ctx.drawImage(dinoAsset,300,340,150,150),ctx.drawImage(dinoAsset,440,390,80,80),ctx.drawImage(dinoAsset,550,360,130,130)),!state.won){let e=6*state.danger-300;if(state.danger>0||state.levelIdx>5){let t=ctx.createLinearGradient(e,0,e+300,0);t.addColorStop(0,"rgba(0,0,0,0.95)"),t.addColorStop(.5,"rgba(255,50,0,0.6)"),t.addColorStop(1,"rgba(0,0,0,0)"),ctx.fillStyle=t,ctx.fillRect(0,0,e+300,500)}}if(state.active&&!state.won){spawnParticles();for(let e=state.particles.length-1;e>=0;e--){let t=state.particles[e];t.x+=t.speedX,t.y+=t.speedY,t.life-=.005,"ash"===t.type?ctx.fillStyle=`rgba(100, 100, 100, ${t.life})`:ctx.fillStyle=`rgba(255, 100, 0, ${t.life})`,ctx.fillRect(t.x,t.y,t.size,t.size),(t.y>500||t.life<=0)&&state.particles.splice(e,1)}}!state.won&&state.danger>85&&(ctx.fillStyle=`rgba(255, 0, 0, ${.1*(Math.sin(Date.now()/100)+1)})`,ctx.fillRect(0,0,800,500)),ctx.restore(),state.active&&requestAnimationFrame(loop)}function loop(){if(!state.active)return;let e=.05+.04*state.levelIdx;if(state.won?state.danger=0:("idle"===state.mode?state.danger+=e:"walk"===state.mode?(state.danger-=.1,state.bgOffset+=4):"run"===state.mode&&(state.danger-=.5,state.bgOffset+=10),state.danger=Math.max(0,Math.min(100,state.danger))),document.getElementById("danger-fill").style.width=state.danger+"%",state.gameStartTime>0){let e=(Date.now()-state.gameStartTime)/1e3,t=state.totalStrokes/(e||1);document.getElementById("speed-val").innerText=t.toFixed(1)}if(!state.won&&state.combo>0){let e=Date.now()-state.lastComboTime,t=Math.max(0,state.comboTimeout-e),s=t/state.comboTimeout*100;const a=document.getElementById("combo-timer-bar");a.style.width=s+"%",state.multiplier>=3?a.style.backgroundColor="#ff00ff":state.multiplier>=2?a.style.backgroundColor="#00ffff":a.style.backgroundColor="#fff",e>=state.comboTimeout&&(state.combo=0,state.multiplier=1,updateStatsUI())}else document.getElementById("combo-timer-bar").style.width="0%";state.danger>=100?endGame(!1):draw()}function setMode(e){state.mode!==e&&(state.mode=e,"idle"===e&&(heroImg.src=IMG_IDLE),"walk"===e&&(heroImg.src=IMG_WALK),"run"===e&&(heroImg.src=IMG_RUN))}function updateStatsUI(){document.getElementById("score-val").innerText=state.score,document.getElementById("combo-display").innerHTML=`${state.combo} <span id="multi-val" style="font-size:8px">(${state.multiplier}x)</span>`,document.getElementById("error-val").innerText=state.errors;const e=document.getElementById("combo-display"),t=document.getElementById("combo-box");e.className="stat-value",state.multiplier>=4?(e.classList.add("combo-god"),t.style.borderColor="#ff00ff"):state.multiplier>=3?(e.classList.add("combo-high"),t.style.borderColor="#00ffff"):state.multiplier>=2?(e.classList.add("combo-med"),t.style.borderColor="#ffff00"):(e.classList.add("combo-low"),t.style.borderColor="#555")}function renderSentence(){let e="";for(let t=0;t<state.text.length;t++){let s=state.text[t],a="pending";t<state.charIdx?a="typed":t===state.charIdx&&(a="current"),e+=`<span class="${a}">${" "===s?"&nbsp;":s}</span>`}document.getElementById("sentence-display").innerHTML=e}function nextSentence(){if(state.sentenceIdx++,state.sentenceIdx>=LEVELS[state.levelIdx].sentences.length){if(state.score+=50,state.levelIdx++,state.levelIdx>=LEVELS.length)return state.won=!0,void endGame(!0);document.getElementById("level-badge").innerText=state.levelIdx+1,state.sentenceIdx=0,state.danger=Math.max(0,state.danger-30)}state.text=LEVELS[state.levelIdx].sentences[state.sentenceIdx],state.charIdx=0,setMode("idle"),renderSentence(),updateStatsUI()}function showScreen(e){document.querySelectorAll(".screen").forEach(e=>e.classList.add("hidden"));const t=document.getElementById(e);t&&t.classList.remove("hidden")}function startGame(e){state.stopTimer&&clearTimeout(state.stopTimer);let t=TEXT_DATA[e];for(let e=0;e<LEVELS.length;e++)LEVELS[e].sentences=t[e]||t[0];state.active=!0,state.won=!1,state.levelIdx=0,state.sentenceIdx=0,state.danger=0,state.bgOffset=0,state.meteors=[],state.particles=[],state.text=LEVELS[0].sentences[0],state.charIdx=0,state.score=0,state.errors=0,state.correct=0,state.combo=0,state.multiplier=1,state.totalStrokes=0,state.gameStartTime=Date.now(),state.lastComboTime=Date.now(),document.getElementById("level-badge").innerText="1",showScreen("none"),setMode("idle"),renderSentence(),updateStatsUI(),loop()}function endGame(e){if(state.stopTimer&&clearTimeout(state.stopTimer),e)document.getElementById("sentence-display").innerHTML="",showScreen("win-screen");else{state.active=!1,setMode("idle");let e=(Date.now()-state.gameStartTime)/1e3,t=(state.totalStrokes/e).toFixed(1),s=`\n                    <p>SCORE: ${state.score}</p>\n                    <p>SPEED: ${t} KPS</p>\n                    <p>ERRORS: ${state.errors}</p>\n                `;document.getElementById("end-stats-loss").innerHTML=s,showScreen("game-over-screen")}draw()}const IMG_IDLE=document.getElementById("asset-idle").src,IMG_WALK=document.getElementById("asset-walk").src,IMG_RUN=document.getElementById("asset-run").src,TEXT_DATA={easy:[["sun","warm","leaf","play","calm"],["wind!","sounds","birds?","rumble!","scared"],["ROCK","on","sky!","GLOW","Run"],["FIRE!","HEAT","FAST!","Burn","HOT!"],["JUMP!","RUN!","To Cave","Hide","FLEE!"],["LAVA!","LOUD!","DOOM","Bang!","END."],["RUN!!!","FAST!","FIRE","NOW!","ZERO"],["SAFE!","Green","LOVE","HOME","Life"]],medium:[["sun is warm","eat green leaves","river flows by","safe and calm"],["wind is fast","clouds are dark","birds fly away","i feel scared"],["Sky is orange","Rocks fall down","Ground shakes","Keep moving on"],["Big rock falls","Trees on fire","Run very fast","Do not stop"],["Dodge the fire","Ash falls down","See the cave","Jump the log"],["Ground cracks","Lava flows fast","Noise is loud","Stay brave now"],["Ten seconds left","Sky falls down","Run for life","Almost there"],["The air is cool","I see trees","We are safe","My family is here"]],hard:[["the morning sun is very warm","a gentle breeze blows by me","I eat the tasty green leaves,","The river flows slowly today","It is a beautiful quiet day."],["The birds stopped singing?","The wind is moving faster!","I see strange dark clouds.","A deep rumble comes from far,","The other animals look scared!"],["The sky is turning orange!!!","Small rocks fall from the sky?","I must keep moving forward...","The ground is SHAKING hard!","A bright light is above us."],["A GIANT rock is falling down!","The forest is catching fire?!","I have to run very fast now.","The air is getting too HOT!","Do not look back! Don't look at the FIRE."],["RUN away from the flames!","JUMP over the burning trees.","The ash is FALLING like snow...","I can see the SAFE CAVE ahead!","Do not stop for anything!!!"],["THE GROUND IS BREAKING APART.","LAVA IS FLOWING BEHIND ME.","THE NOISE IS VERY LOUD NOW.","I MUST BE BRAVE TO SURVIVE.","THE END IS COMING CLOSER."],["IMPACT IN 10 SECONDS!","10, 9, 8...","THE SKY IS FALLING DOWN","7, 6","RUN FASTER THAN EVER!","Five","ALMOST THERE!","Four, THREE","DONT_LET_THE_FIRE_CATCH_YOU!","TWO!","ONE..."],["The smoke clears away.","I see a green valley ahead!","My friends are waiting for me.","We made it! We are safe."]]},PARADISE_PALETTE={skyTop:"#00c6ff",skyBot:"#0072ff",ground:"#2d6a4f",grass:"#40916c",sun:"#ffaa00",meteors:0},LEVELS=[{palette:{skyTop:"#4facfe",skyBot:"#00f2fe",ground:"#2d6a4f",grass:"#40916c",sun:"#ffd700",meteors:0},sentences:[]},{palette:{skyTop:"#4facfe",skyBot:"#f6d365",ground:"#556b2f",grass:"#6b8e23",sun:"#ffcc33",meteors:0},sentences:[]},{palette:{skyTop:"#f6d365",skyBot:"#fda085",ground:"#8b4513",grass:"#a0522d",sun:"#ffaa00",meteors:1},sentences:[]},{palette:{skyTop:"#fcb045",skyBot:"#fd1d1d",ground:"#654321",grass:"#8b0000",sun:"#ff4500",meteors:3},sentences:[]},{palette:{skyTop:"#833ab4",skyBot:"#fd1d1d",ground:"#3e2723",grass:"#4e342e",sun:"#ff0000",meteors:5},sentences:[]},{palette:{skyTop:"#330000",skyBot:"#aa0000",ground:"#1a0505",grass:"#220a0a",sun:"#880000",meteors:8},sentences:[]},{palette:{skyTop:"#220000",skyBot:"#550000",ground:"#000000",grass:"#331100",sun:"#440000",meteors:15},sentences:[]},{palette:{skyTop:"#000000",skyBot:"#ff0000",ground:"#110000",grass:"#ff4500",sun:"#000000",meteors:30},sentences:[]}],canvas=document.getElementById("gameCanvas"),ctx=canvas.getContext("2d"),heroImg=document.getElementById("hero-dino"),dinoAsset=document.getElementById("asset-idle");let state={active:!1,won:!1,levelIdx:0,text:"",sentenceIdx:0,charIdx:0,bgOffset:0,danger:0,mode:"idle",lastInputTime:0,stopTimer:null,meteors:[],particles:[],score:0,errors:0,correct:0,combo:0,multiplier:1,gameStartTime:0,totalStrokes:0,lastComboTime:0,comboTimeout:3e3};document.addEventListener("keydown",e=>{if(!state.active||state.won)return;if(e.key.length>1&&"Backspace"!==e.key)return;let t=state.text[state.charIdx],s=e.key,a=!1;if(state.levelIdx<4?t.toLowerCase()===s.toLowerCase()&&(a=!0):t===s&&(a=!0),state.totalStrokes++,a){state.charIdx++,state.correct++,state.combo++,state.lastComboTime=Date.now(),state.multiplier=1+Math.floor(state.combo/5),state.score+=10*state.multiplier,state.danger-=1;const e=Date.now();e-state.lastInputTime<300?setMode("run"):setMode("walk"),state.lastInputTime=e,state.stopTimer&&clearTimeout(state.stopTimer),state.stopTimer=setTimeout(()=>{state.active&&setMode("idle")},500),state.charIdx>=state.text.length?nextSentence():renderSentence()}else if(1===e.key.length){state.errors++,state.score=Math.max(0,state.score-20),state.combo=0,state.multiplier=1,state.danger+=5;let e=document.getElementById("sentence-display");e.classList.add("wrong"),setTimeout(()=>e.classList.remove("wrong"),100)}updateStatsUI()}),draw();