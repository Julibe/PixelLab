function toIso(t,s){return{x:(t-s)*ISO_X,y:(t+s)*ISO_Y}}const GB={0:"#0f380f",1:"#306230",2:"#8bac0f",3:"#9bbc0f"},TILE=40,GRID_W=19,GRID_H=19,ISO_X=TILE,ISO_Y=TILE/2,SPRITES={PLAYER:[[0,0,0,1,1,1,1,1,0,0,0,0],[0,0,1,3,3,3,3,3,1,0,0,0],[0,1,3,1,1,3,1,1,3,1,0,0],[1,3,1,3,3,3,3,3,1,3,1,0],[1,3,1,1,3,1,1,3,1,3,1,0],[1,3,1,1,3,1,1,3,1,3,1,0],[1,3,3,3,3,3,3,3,3,3,1,0],[1,3,3,1,1,1,1,1,3,3,1,0],[0,1,3,3,3,3,3,3,3,1,0,0],[0,0,1,1,3,3,3,1,1,0,0,0],[0,1,1,0,1,1,1,0,1,1,0,0],[0,1,1,0,0,0,0,0,1,1,0,0]],GHOST:[[0,0,0,0,1,1,1,1,0,0,0,0],[0,0,0,1,2,2,2,2,1,0,0,0],[0,0,1,2,2,2,2,2,2,1,0,0],[0,1,2,2,3,3,2,3,3,2,1,0],[0,1,2,2,3,1,2,3,1,2,1,0],[1,2,2,2,2,2,2,2,2,2,2,1],[1,2,2,2,2,2,2,2,2,2,2,1],[1,2,1,2,2,2,2,2,2,1,2,1],[1,2,2,1,1,1,1,1,1,2,2,1],[1,2,2,2,2,2,2,2,2,2,2,1],[0,1,2,1,2,1,1,2,1,2,1,0],[0,0,1,0,1,0,0,1,0,1,0,0]],GHOST_SCARED:[[0,0,0,0,1,1,1,1,0,0,0,0],[0,0,0,1,3,3,3,3,1,0,0,0],[0,0,1,3,3,3,3,3,3,1,0,0],[0,1,3,3,1,3,3,1,3,3,1,0],[1,3,3,3,3,3,3,3,3,3,3,1],[1,3,3,3,3,3,3,3,3,3,3,1],[1,3,3,1,0,1,1,0,1,3,3,1],[1,3,3,1,0,1,1,0,1,3,3,1],[1,3,3,3,1,1,1,1,3,3,3,1],[0,1,3,1,3,1,1,3,1,3,1,0],[0,0,1,0,1,0,0,1,0,1,0,0],[0,0,0,0,0,0,0,0,0,0,0,0]],BOMB:[[0,0,0,0,1,1,0,0,0,0,0,0],[0,0,0,1,3,3,1,0,0,0,0,0],[0,0,1,1,1,1,1,1,0,0,0,0],[0,1,1,3,3,1,1,1,1,0,0,0],[1,1,3,3,1,1,1,1,1,1,0,0],[1,1,1,1,1,1,1,1,1,1,0,0],[1,1,1,1,3,3,1,1,1,1,0,0],[1,1,1,1,3,3,1,1,1,1,0,0],[0,1,1,1,1,1,1,1,1,0,0,0],[0,0,1,1,1,1,1,1,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0]]};class MazeGen{static generate(t,s){let e=[];for(let i=0;i<s;i++){let s=[];for(let e=0;e<t;e++)s.push(1);e.push(s)}let i=[{x:1,y:1}];for(e[1][1]=0;i.length>0;){let h=i[i.length-1],o=[],a=[{x:0,y:-2},{x:0,y:2},{x:-2,y:0},{x:2,y:0}];for(let i of a){let a=h.x+i.x,r=h.y+i.y;a>0&&a<t-1&&r>0&&r<s-1&&1===e[r][a]&&o.push({x:a,y:r,dx:i.x/2,dy:i.y/2})}if(o.length>0){let t=o[Math.floor(Math.random()*o.length)];e[h.y+t.dy][h.x+t.dx]=0,e[t.y][t.x]=0,i.push({x:t.x,y:t.y})}else i.pop()}for(let i=2;i<s-2;i++)for(let s=2;s<t-2;s++)1===e[i][s]&&Math.random()<.25&&(e[i][s]=0);return e}}class Actor{constructor(t,s){this.gx=t,this.gy=s,this.x=t*TILE,this.y=s*TILE,this.dir={x:0,y:0},this.nextDir={x:0,y:0},this.speed=2,this.moving=!1,this.flip=1}moveLogic(t){const s=this.gx*TILE,e=this.gy*TILE;this.x===s&&this.y===e?(this.moving=!1,this.onTileCenter(t)):(this.moving=!0,this.x<s&&(this.x=Math.min(this.x+this.speed,s)),this.x>s&&(this.x=Math.max(this.x-this.speed,s)),this.y<e&&(this.y=Math.min(this.y+this.speed,e)),this.y>e&&(this.y=Math.max(this.y-this.speed,e)))}canMove(t,s,e){return!(!e.map[this.gy+s]||0!==e.map[this.gy+s][this.gx+t])}}class Player extends Actor{constructor(t,s){super(t,s),this.dashTime=0,this.bombTimer=0}onTileCenter(t){0===this.nextDir.x&&0===this.nextDir.y||this.canMove(this.nextDir.x,this.nextDir.y,t)&&(this.dir={...this.nextDir},this.nextDir={x:0,y:0},0!==this.dir.x&&(this.flip=this.dir.x)),this.canMove(this.dir.x,this.dir.y,t)?(this.gx+=this.dir.x,this.gy+=this.dir.y,0!==this.dir.x&&(this.flip=this.dir.x)):this.dir={x:0,y:0}}update(t,s){s.w&&(this.nextDir={x:0,y:-1}),s.s&&(this.nextDir={x:0,y:1}),s.a&&(this.nextDir={x:-1,y:0}),s.d&&(this.nextDir={x:1,y:0}),this.speed=3,"SLOW_DOWN"===t.chaos&&(this.speed=1.5),s.dash&&this.dashTime<=0&&(this.dashTime=15),this.dashTime>0&&(this.speed=6,this.dashTime--),"BOMB_SPREE"===t.chaos&&(this.bombTimer++,this.bombTimer>15&&(t.spawnBomb(this.x,this.y),this.bombTimer=0)),this.moveLogic(t)}}class Ghost extends Actor{constructor(t,s){super(t,s),this.scared=!1}onTileCenter(t){let s=[],e=[{x:0,y:-1},{x:0,y:1},{x:-1,y:0},{x:1,y:0}];for(let i of e)i.x===-this.dir.x&&i.y===-this.dir.y&&this.moving||this.canMove(i.x,i.y,t)&&s.push(i);if(0===s.length){let e={x:-this.dir.x,y:-this.dir.y};this.canMove(e.x,e.y,t)&&s.push(e)}if(s.length>0){let e=s[0];if(this.scared){let i=-1;for(let h of s){let s=(this.gx+h.x)*TILE,o=(this.gy+h.y)*TILE,a=Math.hypot(s-t.player.x,o-t.player.y);(a>i||Math.random()>.8)&&(i=a,e=h)}}else if(Math.random()<.7){let i=999999;for(let h of s){let s=(this.gx+h.x)*TILE,o=(this.gy+h.y)*TILE,a=Math.hypot(s-t.player.x,o-t.player.y);a<i&&(i=a,e=h)}}else e=s[Math.floor(Math.random()*s.length)];this.dir=e,this.gx+=this.dir.x,this.gy+=this.dir.y,0!==this.dir.x&&(this.flip=this.dir.x)}}update(t){this.speed=2,"ENEMY_FRENZY"===t.chaos&&(this.speed=4),"SLOW_DOWN"===t.chaos&&(this.speed=1),this.scared&&(this.speed=1.5),this.moveLogic(t)}}class Bomb{constructor(t,s){this.x=t,this.y=s,this.timer=60,this.exploded=!1}update(t){this.timer--,this.timer<=0&&!this.exploded&&(this.exploded=!0,t.shake=10,t.ghosts.forEach(t=>{Math.hypot(t.x-this.x,t.y-this.y)<80&&(t.gx=1,t.gy=1,t.x=TILE,t.y=TILE)}))}}class Game{constructor(){this.canvas=document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),this.resize(),window.addEventListener("resize",()=>this.resize()),this.input={w:!1,a:!1,s:!1,d:!1,dash:!1},window.addEventListener("keydown",t=>this.handleKey(t,!0)),window.addEventListener("keyup",t=>this.handleKey(t,!1)),this.restart(),this.loop()}handleKey(t,s){let e=t.key.toLowerCase();("wasd".includes(e)||e.startsWith("arrow"))&&("w"!==e&&"arrowup"!==e||(this.input.w=s),"a"!==e&&"arrowleft"!==e||(this.input.a=s),"s"!==e&&"arrowdown"!==e||(this.input.s=s),"d"!==e&&"arrowright"!==e||(this.input.d=s))," "!==e&&"e"!==e||(this.input.dash=s)}resize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.ctx.imageSmoothingEnabled=!1}restart(){document.getElementById("game-over").style.display="none",this.score=0,this.level=1,this.gameOver=!1,this.chaos="NORMAL",this.chaosTimer=600,this.powerModeTime=0,this.loadLevel()}loadLevel(){this.map=MazeGen.generate(GRID_W,GRID_H);let t=[];for(let s=1;s<GRID_H-1;s++)for(let e=1;e<GRID_W-1;e++)0===this.map[s][e]&&t.push({x:e,y:s});let s=t.shift();this.player=new Player(s.x,s.y),this.powerUps=[];let e=[{x:1,y:1},{x:GRID_W-2,y:1},{x:1,y:GRID_H-2},{x:GRID_W-2,y:GRID_H-2}];e.forEach(t=>{0===this.map[t.y][t.x]&&this.powerUps.push({x:t.x*TILE+TILE/2,y:t.y*TILE+TILE/2,active:!0})}),this.pellets=[];for(let s of t){let t=this.powerUps.some(t=>Math.abs(t.x-(s.x*TILE+TILE/2))<5);!t&&Math.random()>.1&&this.pellets.push({x:s.x*TILE+TILE/2,y:s.y*TILE+TILE/2,active:!0})}this.ghosts=[];let i=3+Math.floor(this.level/2);for(let s=0;s<i;s++){let e=t[t.length-1-s];e&&this.ghosts.push(new Ghost(e.x,e.y))}this.bombs=[],this.shake=0,this.powerModeTime=0}spawnBomb(t,s){this.bombs.push(new Bomb(t,s))}activatePowerMode(){this.powerModeTime=400,this.ghosts.forEach(t=>t.scared=!0)}update(){if(this.gameOver)return;if(this.chaosTimer--,this.chaosTimer<=0){const t=["NORMAL","BOMB_SPREE","ENEMY_FRENZY","SLOW_DOWN"];let s=this.chaos;for(;this.chaos===s;)this.chaos=t[Math.floor(Math.random()*t.length)];this.chaosTimer=500,document.getElementById("chaos-msg").innerText=this.chaos,this.shake=5}if(this.powerModeTime>0&&(this.powerModeTime--,this.powerModeTime<=0&&this.ghosts.forEach(t=>t.scared=!1)),this.player.update(this,this.input),this.pellets.forEach(t=>{t.active&&Math.abs(t.x-(this.player.x+TILE/2))<10&&Math.abs(t.y-(this.player.y+TILE/2))<10&&(t.active=!1,this.score+=10)}),this.powerUps.forEach(t=>{t.active&&Math.abs(t.x-(this.player.x+TILE/2))<15&&Math.abs(t.y-(this.player.y+TILE/2))<15&&(t.active=!1,this.activatePowerMode(),this.score+=50)}),this.ghosts.forEach(t=>t.update(this)),this.player.dashTime<=0)for(let t of this.ghosts){let s=Math.hypot(t.x-this.player.x,t.y-this.player.y);s<20&&(t.scared?(t.gx=1,t.gy=1,t.x=TILE,t.y=TILE,t.scared=!1,this.score+=200,this.shake=5):(this.gameOver=!0,document.getElementById("game-over").style.display="block",document.getElementById("final-score").innerText="FINAL SCORE: "+this.score))}let t=this.pellets.filter(t=>t.active).length;document.getElementById("score-ui").innerText="SCORE: "+this.score,0===t&&(this.level++,this.loadLevel()),this.bombs.forEach(t=>t.update(this)),this.bombs=this.bombs.filter(t=>!t.exploded),this.shake>0&&(this.shake*=.9)}draw(){this.ctx.fillStyle=GB[0],this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);let t=this.canvas.width/2,s=this.canvas.height/2,e=toIso(this.player.x/TILE,this.player.y/TILE),i=(Math.random()-.5)*this.shake,h=(Math.random()-.5)*this.shake;this.ctx.save(),this.ctx.translate(t-e.x+i,s-e.y+h-150);let o=[];for(let t=0;t<GRID_H;t++)for(let s=0;s<GRID_W;s++)Math.abs(s-this.player.gx)>16||Math.abs(t-this.player.gy)>16||o.push({type:"tile",val:this.map[t][s],gx:s,gy:t,sort:s+t});o.push({type:"player",gx:this.player.x/TILE,gy:this.player.y/TILE,sort:this.player.x/TILE+this.player.y/TILE}),this.ghosts.forEach(t=>o.push({type:"ghost",obj:t,gx:t.x/TILE,gy:t.y/TILE,sort:t.x/TILE+t.y/TILE})),this.pellets.forEach(t=>{t.active&&o.push({type:"pellet",x:t.x,y:t.y,sort:t.x/TILE+t.y/TILE})}),this.powerUps.forEach(t=>{t.active&&o.push({type:"power",x:t.x,y:t.y,sort:t.x/TILE+t.y/TILE})}),this.bombs.forEach(t=>o.push({type:"bomb",x:t.x,y:t.y,sort:t.x/TILE+t.y/TILE})),o.sort((t,s)=>t.sort-s.sort),o.forEach(t=>{if("tile"===t.type){let s=toIso(t.gx,t.gy);1===t.val?this.drawIsoBlock(s.x,s.y,GB[1],24):this.drawIsoRect(s.x,s.y,GB[2])}else if("pellet"===t.type){let s=toIso(t.x/TILE-.5,t.y/TILE-.5);this.ctx.fillStyle=GB[3],this.ctx.fillRect(s.x-3,s.y-3,6,6)}else if("power"===t.type){let s=toIso(t.x/TILE-.5,t.y/TILE-.5);this.ctx.fillStyle=Math.floor(Date.now()/200)%2==0?GB[3]:GB[2],this.ctx.fillRect(s.x-8,s.y-18,16,16)}else if("player"===t.type){let s=toIso(t.gx,t.gy);this.drawSprite(s.x,s.y,SPRITES.PLAYER,this.player.flip,!1)}else if("ghost"===t.type){let s=toIso(t.gx,t.gy),e=t.obj.scared?SPRITES.GHOST_SCARED:SPRITES.GHOST;this.drawSprite(s.x,s.y,e,t.obj.flip,t.obj.scared)}else if("bomb"===t.type){let s=toIso(t.x/TILE,t.y/TILE);this.drawSprite(s.x,s.y,SPRITES.BOMB,1,!1)}}),this.ctx.restore()}drawIsoRect(t,s,e){this.ctx.beginPath(),this.ctx.moveTo(t,s-ISO_Y),this.ctx.lineTo(t+ISO_X,s),this.ctx.lineTo(t,s+ISO_Y),this.ctx.lineTo(t-ISO_X,s),this.ctx.fillStyle=e,this.ctx.fill(),this.ctx.strokeStyle="rgba(0,0,0,0.1)",this.ctx.stroke()}drawIsoBlock(t,s,e,i){this.ctx.fillStyle=e,this.ctx.beginPath(),this.ctx.moveTo(t,s-ISO_Y-i),this.ctx.lineTo(t+ISO_X,s-i),this.ctx.lineTo(t,s+ISO_Y-i),this.ctx.lineTo(t-ISO_X,s-i),this.ctx.fill(),this.ctx.stroke(),this.ctx.fillStyle=GB[0],this.ctx.beginPath(),this.ctx.moveTo(t+ISO_X,s-i),this.ctx.lineTo(t+ISO_X,s),this.ctx.lineTo(t,s+ISO_Y),this.ctx.lineTo(t,s+ISO_Y-i),this.ctx.fill(),this.ctx.beginPath(),this.ctx.moveTo(t-ISO_X,s-i),this.ctx.lineTo(t-ISO_X,s),this.ctx.lineTo(t,s+ISO_Y),this.ctx.lineTo(t,s+ISO_Y-i),this.ctx.fill()}drawSprite(t,s,e,i,h){const o=3,a=e[0].length,r=e.length,l=a*o/2,x=r*o+10;let y=Math.floor(3*Math.sin(Date.now()/150));this.ctx.fillStyle="rgba(15, 56, 15, 0.4)",this.ctx.beginPath(),this.ctx.ellipse(t,s,12,6,0,0,2*Math.PI),this.ctx.fill();for(let c=0;c<r;c++)for(let r=0;r<a;r++){let n=e[c][r];if(0===n)continue;let d=r;-1===i&&(d=a-1-r);let p=t-l+d*o,I=s-x+c*o-y;1===n&&(this.ctx.fillStyle=GB[0]),2===n&&(this.ctx.fillStyle=h?GB[2]:GB[1]),3===n&&(this.ctx.fillStyle=GB[3]),this.ctx.fillRect(p,I,o,o)}}loop(){this.update(),this.draw(),requestAnimationFrame(()=>this.loop())}}const game=new Game;