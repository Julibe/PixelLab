function shareTwitter(){const t="Julibe",e=Game.players.find(t=>t.isUser),s=e?e.score:0,i=document.getElementById("uiTime").innerText,a=Game.numPlayers-1,o=[`I just scored ${s} in Luminora! Survived ${i} against ${a} bots.`,`Geometric supremacy achieved in Luminora: ${s} PTS vs ${a} enemies in ${i}.`,`The Phoenix Protocol works. My Luminora run: ${s} Score | ${i} Time | ${a} Bots.`,`Just dominated the Luminora Cyber Arena: ${s} PTS, ${a} enemies, ${i} duration.`,`I outlasted ${a} vectors in Luminora for ${i}. Final Efficiency: ${s}.`,`Chaos theory proved wrong in Luminora. I hit ${s} points in ${i} vs ${a} targets.`,`New High Score in Luminora: ${s} PTS! Took down ${a} opponents in ${i}.`,`System hacked in Luminora. ${a} firewalls breached in ${i}. Score: ${s}.`,`Entered the flow state against ${a} bots in Luminora. ${i} of pure focus. Score: ${s}.`],n=["Luminora","IndieDev","HTML5","Cyber","Punk","Game","WebDev","Pong","GameDev","Neon"],l=o[Math.floor(Math.random()*o.length)];let r=n.sort(()=>.5-Math.random()).slice(0,4).map(t=>t.replace(/\s+/g,""));const h=`https://twitter.com/intent/tweet?text=${encodeURIComponent(l)}&url=${encodeURIComponent("https://codepen.io/Julibe/pen/qEboyag")}&hashtags=${encodeURIComponent(r.join(","))}&via=${encodeURIComponent(t)}`;window.open(h,"_blank")}const GameConfig={MinPlayers:2,MaxPlayers:25,KeyboardSpeed:.03,BotSpeed:.012,Score:{Hit:10,Assist:100,Kill:500,Win:3e3,Resurrect:100,SurvivalBase:50,SurvivalMult:.25},ResurrectWindow:1e3,SurvivalTick:1e4,PortalCooldown:60,Audio:{EchoDelay:.25,EchoFeedback:.3}},InputSys={keys:{left:!1,right:!1,shoot:!1},gamepadIndex:null,init(){window.addEventListener("keydown",t=>this.onKey(t,!0)),window.addEventListener("keyup",t=>this.onKey(t,!1)),window.addEventListener("gamepadconnected",t=>{this.gamepadIndex=t.gamepad.index}),window.addEventListener("gamepaddisconnected",()=>{this.gamepadIndex=null}),window.addEventListener("keydown",t=>{"Space"!==t.code&&"Escape"!==t.code&&"p"!==t.key.toLowerCase()||(t.preventDefault(),Game.togglePause())}),window.addEventListener("contextmenu",t=>{t.preventDefault(),Game.togglePause()})},onKey(t,e){"ArrowLeft"!==t.code&&"KeyA"!==t.code||(this.keys.left=e),"ArrowRight"!==t.code&&"KeyD"!==t.code||(this.keys.right=e),"Enter"!==t.code&&"ShiftLeft"!==t.code&&"ShiftRight"!==t.code||(this.keys.shoot=e)},getMovement(){let t=0;if(this.keys.left&&(t-=1),this.keys.right&&(t+=1),null!==this.gamepadIndex){const e=navigator.getGamepads()[this.gamepadIndex];e&&(Math.abs(e.axes[0])>.1&&(t=e.axes[0]),e.buttons[14].pressed&&(t=-1),e.buttons[15].pressed&&(t=1))}return t},getShoot(){if(this.keys.shoot)return this.keys.shoot=!1,!0;if(null!==this.gamepadIndex){const t=navigator.getGamepads()[this.gamepadIndex];if(t&&t.buttons[0].pressed)return!0}return!1}},AudioSys={ctx:null,master:null,delay:null,feedback:null,musicNextTime:0,beatCount:0,musicPlaying:!1,init(){this.ctx||(this.ctx=new(window.AudioContext||window.webkitAudioContext),this.master=this.ctx.createGain(),this.master.gain.value=.3,this.delay=this.ctx.createDelay(),this.delay.delayTime.value=GameConfig.Audio.EchoDelay,this.feedback=this.ctx.createGain(),this.feedback.gain.value=GameConfig.Audio.EchoFeedback,this.delay.connect(this.feedback),this.feedback.connect(this.delay),this.feedback.connect(this.master),this.master.connect(this.ctx.destination)),"suspended"===this.ctx.state&&this.ctx.resume()},startMusic(){this.ctx&&!this.musicPlaying&&(this.musicPlaying=!0,this.musicNextTime=this.ctx.currentTime+.1,this.scheduleMusic())},stopMusic(){this.musicPlaying=!1},scheduleMusic(){if(!this.musicPlaying)return;const t=.15,e=.1;for(;this.musicNextTime<this.ctx.currentTime+e;)this.playBeat(this.musicNextTime,this.beatCount),this.musicNextTime+=t,this.beatCount++;setTimeout(()=>this.scheduleMusic(),25)},playBeat(t,e){const s=this.ctx.createGain();if(s.connect(this.master),s.gain.setValueAtTime(.4,t),s.gain.exponentialRampToValueAtTime(.01,t+.3),e%4==0){const e=this.ctx.createOscillator();e.frequency.setValueAtTime(120,t),e.frequency.exponentialRampToValueAtTime(.01,t+.3),e.connect(s),e.start(t),e.stop(t+.3)}if(e%2!=0){const i=this.ctx.createOscillator();i.type="sawtooth";const a=[73.42,87.31,98,110],o=a[Math.floor(e/16%4)];i.frequency.setValueAtTime(o,t);const n=this.ctx.createBiquadFilter();n.type="lowpass",n.frequency.setValueAtTime(400,t),n.frequency.linearRampToValueAtTime(100,t+.2),i.connect(n),n.connect(s),i.start(t),i.stop(t+.2)}},play(t,e=1){if(!this.ctx)return;const s=this.ctx.currentTime,i=this.ctx.createOscillator(),a=this.ctx.createGain();if(i.connect(a),a.connect(this.master),a.connect(this.delay),"hit"===t){i.type="sine";const t=300+400*e;i.frequency.setValueAtTime(t,s),i.frequency.linearRampToValueAtTime(.5*t,s+.1),a.gain.setValueAtTime(.3+.4*e,s),a.gain.linearRampToValueAtTime(0,s+.1),i.start(s),i.stop(s+.1)}else"shoot"===t?(i.type="square",i.frequency.setValueAtTime(300,s),i.frequency.exponentialRampToValueAtTime(50,s+.2),a.gain.setValueAtTime(.3,s),a.gain.linearRampToValueAtTime(0,s+.2),i.start(s),i.stop(s+.2)):"die"===t?(i.type="sawtooth",i.frequency.setValueAtTime(150,s),i.frequency.exponentialRampToValueAtTime(10,s+1),a.gain.setValueAtTime(.5,s),a.gain.linearRampToValueAtTime(0,s+1),i.start(s),i.stop(s+1)):"event"===t?(i.type="triangle",i.frequency.setValueAtTime(200,s),i.frequency.linearRampToValueAtTime(600,s+.5),a.gain.setValueAtTime(.3,s),a.gain.linearRampToValueAtTime(0,s+.5),i.start(s),i.stop(s+.5)):"resurrect"===t?(i.type="sine",i.frequency.setValueAtTime(200,s),i.frequency.linearRampToValueAtTime(800,s+.6),a.gain.setValueAtTime(.5,s),a.gain.linearRampToValueAtTime(0,s+.6),i.start(s),i.stop(s+.6)):"portal"===t&&(i.type="sine",i.frequency.setValueAtTime(800,s),i.frequency.exponentialRampToValueAtTime(100,s+.3),a.gain.setValueAtTime(.4,s),a.gain.linearRampToValueAtTime(0,s+.3),i.start(s),i.stop(s+.3))}},canvas=document.getElementById("gameCanvas"),ctx=canvas.getContext("2d"),uiScore=document.getElementById("uiScore"),uiTime=document.getElementById("uiTime"),BotNames=["NEON","CANDY","VORTEX","FIZZ","POP","ZAP","GUMMY","ACID","BASE","FLUX","SPARK","GLOW","CYBER","TRON","DATA","BIT"],ChaosTypes=["WORMHOLE","MULTI-BALL","CHAOS","CURVEBALL","ZIGZAG","FLUX","SHRINK","GROW","REVERSE","SPIN","SURGE"],Game={active:!1,paused:!1,over:!1,loopId:null,width:0,height:0,centerX:0,centerY:0,radius:0,frame:0,mouseX:0,mouseY:0,numPlayers:4,difficulty:1,startLives:3,userColor:"#ff00ff",activeEvent:null,eventTimer:0,respawning:!1,shrinkMode:!1,growMode:!1,rotation:0,targetRotation:0,warmingUp:!1,spectatorMode:!1,timeAccumulator:0,currentBgRGB:{r:10,g:10,b:10},targetBgRGB:{r:10,g:10,b:10},walls:[],players:[],balls:[],particles:[],shockwaves:[],portals:[],challengeTimer:null,bgGridOffset:0,startTime:0,lastSurvivalCheck:0,enabledEvents:[...ChaosTypes],eventFrequency:1,initMenu(){const t=document.getElementById("socialTemplate").innerHTML;document.querySelectorAll(".menu-footer").forEach(e=>e.innerHTML=t);const e=document.getElementById("chaosList");e.innerHTML="",ChaosTypes.forEach(t=>{const s=document.createElement("div");s.className="chaos-toggle active",s.innerHTML=`<span class="toggle-name uppercase">${t}</span><div class="toggle-indicator"></div>`,s.onclick=(()=>{s.classList.toggle("active"),s.classList.contains("active")?this.enabledEvents.includes(t)||this.enabledEvents.push(t):this.enabledEvents=this.enabledEvents.filter(e=>e!==t)}),e.appendChild(s)})},switchTab(t,e){document.querySelectorAll(".tab-content").forEach(t=>t.classList.remove("active")),document.querySelectorAll(".tab-btn").forEach(t=>t.classList.remove("active")),document.getElementById(t).classList.add("active"),e.classList.add("active")},updateFreqLabel(t){const e=["Disabled","Normal","High","Hyper"];document.getElementById("freqLabel").innerText=e[t],this.eventFrequency=parseInt(t)},showChaos(){document.getElementById("mainMenu").classList.remove("active"),document.getElementById("chaosMenu").classList.add("active")},hideChaos(){document.getElementById("chaosMenu").classList.remove("active"),document.getElementById("mainMenu").classList.add("active")},showInfo(){document.getElementById("mainMenu").classList.remove("active"),document.getElementById("infoMenu").classList.add("active")},hideInfo(){document.getElementById("infoMenu").classList.remove("active"),document.getElementById("mainMenu").classList.add("active")},togglePause(){!this.active||this.over||this.warmingUp||(this.paused?this.resume():this.pause())},init(){InputSys.init(),this.challengeTimer&&clearTimeout(this.challengeTimer),AudioSys.init(),AudioSys.startMusic(),this.numPlayers=parseInt(document.getElementById("optPlayers").value),this.numPlayers<GameConfig.MinPlayers&&(this.numPlayers=GameConfig.MinPlayers),this.numPlayers>GameConfig.MaxPlayers&&(this.numPlayers=GameConfig.MaxPlayers),this.difficulty=parseFloat(document.getElementById("optDiff").value),this.startLives=parseInt(document.getElementById("optLives").value),this.userColor=document.getElementById("optColor").value,document.querySelectorAll(".menu-container").forEach(t=>t.classList.remove("active")),this.active=!0,this.paused=!1,this.over=!1,this.spectatorMode=!1,this.activeEvent=null,this.shrinkMode=!1,this.growMode=!1,this.respawning=!1,this.rotation=0,this.targetRotation=0,this.currentBgRGB={r:5,g:5,b:5},this.warmingUp=!0,this.timeAccumulator=0,this.startTime=Date.now(),this.lastSurvivalCheck=Date.now(),this.resize(),this.createArena(),this.balls=[],this.portals=[],this.shockwaves=[],this.positionStartOverlay(),this.loopId&&cancelAnimationFrame(this.loopId),this.loop(),setTimeout(()=>{this.active&&(this.warmingUp=!1,document.getElementById("startIndicator").classList.remove("visible"),this.spawnBall(),AudioSys.play("event"),this.scheduleEvent(),this.startTime=Date.now(),this.lastSurvivalCheck=Date.now())},2e3)},positionStartOverlay(){const t=this.players.find(t=>t.isUser);if(!t)return;const e=this.walls[t.id],s=(e.p1.x+e.p2.x)/2,i=(e.p1.y+e.p2.y)/2,a=this.centerX-s,o=this.centerY-i,n=70,l=Math.sqrt(a*a+o*o),r=a/l,h=o/l,c=r*n,d=h*n,u=document.getElementById("startIndicator");u.style.left=s+c-25+"px",u.style.top=i+d-40+"px";let m=Math.atan2(-h,-r),p=m*(180/Math.PI)-90;u.style.transform=`rotate(${p}deg)`,u.classList.add("visible")},resume(){this.paused=!1,document.getElementById("pauseMenu").classList.remove("active")},pause(){!this.over&&this.active&&(this.paused=!0,document.getElementById("pauseMenu").classList.add("active"))},restart(){this.init()},toMainMenu(){this.active=!1,this.paused=!1,AudioSys.stopMusic(),this.challengeTimer&&clearTimeout(this.challengeTimer),document.querySelectorAll(".menu-container").forEach(t=>t.classList.remove("active")),document.getElementById("mainMenu").classList.add("active"),document.getElementById("startIndicator").classList.remove("visible")},gameOver(t){this.over=!0,this.paused=!0,AudioSys.stopMusic();const e=this.players[t],s=this.players.find(t=>t.isUser);let i="Terminated",a=`Survivor: ${e?e.name:"Unknown"}`;e&&e.isUser&&(i="Victory",a="System Conquered",this.addScore(e.id,GameConfig.Score.Win)),document.getElementById("goTitle").innerText=i,document.getElementById("goSubtitle").innerText=a,document.getElementById("goScore").innerText=s?s.score:0,document.getElementById("pauseMenu").classList.remove("active"),document.getElementById("gameOverMenu").classList.add("active")},colorStringToRGB(t){let e=document.createElement("div");e.style.color=t,document.body.appendChild(e);let s=window.getComputedStyle(e).color;document.body.removeChild(e);let i=s.match(/(\d+),\s*(\d+),\s*(\d+)/);return i?{r:parseInt(i[1]),g:parseInt(i[2]),b:parseInt(i[3])}:{r:0,g:0,b:0}},createArena(){this.walls=[],this.players=[];const t=this.numPlayers,e=this.radius,s=this.centerX,i=this.centerY;let a=[...BotNames].sort(()=>Math.random()-.5),o=[];if(2===t){const t=1.5*e,n=2.2*e;o.push({x:s-t/2,y:i-n/2}),o.push({x:s+t/2,y:i-n/2}),o.push({x:s+t/2,y:i+n/2}),o.push({x:s-t/2,y:i+n/2});for(let t=0;t<4;t++){let e=o[t],s=o[(t+1)%4],i=0===t||2===t,n=0===t,l=n?this.userColor:`hsl(${360*Math.random()},100%,50%)`;i||(l="#333");const r=s.x-e.x,h=s.y-e.y,c=Math.sqrt(r*r+h*h);this.walls.push({p1:e,p2:s,nx:-h/c,ny:r/c,len:c,id:t});let d=n?"YOU":a.pop();this.players.push({id:t,lives:i?this.startLives:0,pos:.5,color:l,rgb:this.colorStringToRGB(l),isUser:n,dead:!i,isWall:!i,shots:0,score:0,name:d})}}else{let n=4===t?Math.PI/4:6===t?0:Math.PI/2;for(let a=0;a<t;a++){const l=a/t*Math.PI*2+n;o.push({x:s+e*Math.cos(l),y:i+e*Math.sin(l)})}for(let e=0;e<t;e++){let s=o[e],i=o[(e+1)%t];const n=i.x-s.x,l=i.y-s.y,r=Math.sqrt(n*n+l*l);let h=e===Math.floor(t/2),c=h?this.userColor:`hsl(${e/t*360}, 100%, 50%)`;h||c!==this.userColor||(c="#ffffff"),this.walls.push({p1:s,p2:i,nx:-l/r,ny:n/r,len:r,id:e});let d=h?"YOU":a.pop();this.players.push({id:e,lives:this.startLives,pos:.5,color:c,rgb:this.colorStringToRGB(c),isUser:h,dead:!1,isWall:!1,shots:0,score:0,name:d})}}},spawnBall(t,e,s,i,a=null){if(!(this.balls.length>=this.numPlayers+3)){if(void 0===t){const a=Math.random()*Math.PI*2,o=4*this.difficulty;t=this.centerX,e=this.centerY,s=Math.cos(a)*o,i=Math.sin(a)*o}this.balls.push({x:t,y:e,vx:s,vy:i,curveDir:Math.random()<.5?1:-1,trail:[],ownerId:a,spawnTime:Date.now(),lastTouchId:null,portalCooldown:0})}},shootFromDead(t){if(!t.dead||t.shots<=0||!this.active||this.paused||this.warmingUp)return;t.shots--;const e=this.walls[t.id],s=t.pos,i=e.p1.x+(e.p2.x-e.p1.x)*s,a=e.p1.y+(e.p2.y-e.p1.y)*s,o=Math.atan2(this.centerY-a,this.centerX-i),n=6*this.difficulty;this.spawnBall(i+10*Math.cos(o),a+10*Math.sin(o),Math.cos(o)*n,Math.sin(o)*n,t.id),AudioSys.play("shoot")},addScore(t,e){const s=this.players[t];s&&(s.score+=e)},spawnPortals(){this.portals=[];for(let t=0;t<2;t++){const e=Math.random()*Math.PI*2,s=Math.random()*(.7*this.radius);this.portals.push({x:this.centerX+Math.cos(e)*s,y:this.centerY+Math.sin(e)*s,color:0===t?"#0ff":"#f90"})}this.triggerActiveEvent("WORMHOLE",500)},update(){if(this.paused)return;const t=this.players.find(t=>t.isUser);if(t&&!this.warmingUp){const e=InputSys.getMovement();0!==e&&(t.pos+=e*GameConfig.KeyboardSpeed,t.pos=Math.max(.1,Math.min(.9,t.pos))),t.dead&&InputSys.getShoot()&&this.shootFromDead(t)}const e=Date.now();if(e-this.lastSurvivalCheck>=GameConfig.SurvivalTick){const t=this.players.filter(t=>!t.dead&&!t.isWall).length,s=Math.floor(GameConfig.Score.SurvivalBase*(t*GameConfig.Score.SurvivalMult));this.players.forEach(t=>{t.dead||t.isWall||this.addScore(t.id,s)}),this.lastSurvivalCheck=e}t&&(uiScore.innerText=t.score);let s=Math.floor((e-this.startTime)/1e3),i=Math.floor(s/60).toString().padStart(2,"0"),a=(s%60).toString().padStart(2,"0");uiTime.innerText=`${i}:${a}`;const o=this.players.filter(t=>!t.dead&&!t.isWall);if(o.length<=1&&this.numPlayers>1)return void this.gameOver(1===o.length?o[0].id:null);t&&t.dead&&!this.spectatorMode&&(this.spectatorMode=!0),this.activeEvent&&(this.eventTimer--,this.eventTimer<=0&&(this.activeEvent=null,this.shrinkMode=!1,this.growMode=!1,this.portals=[]));let n=null,l=-1;this.players.forEach(t=>{!t.dead&&!t.isWall&&t.lives>l&&(l=t.lives,n=t)}),this.players.forEach(t=>{if(!t.isUser&&!t.isWall)if(t.dead){if(t.dead&&t.shots>0){let e=n||this.players.find(t=>!t.dead&&!t.isWall);if(e){Math.random()<.05&&(t.targetPos=Math.random()),t.targetPos||(t.targetPos=.5);const e=.02*this.difficulty;t.pos<t.targetPos&&(t.pos+=e),t.pos>t.targetPos&&(t.pos-=e),t.pos=Math.max(.1,Math.min(.9,t.pos)),Math.random()<.005&&this.shootFromDead(t)}}}else{let e=.5,s=99999;this.balls.forEach(i=>{const a=this.walls[t.id],o=(i.x-a.p1.x)**2+(i.y-a.p1.y)**2;if(o<s){s=o;const t=(i.x-a.p1.x)*((a.p2.x-a.p1.x)/a.len)+(i.y-a.p1.y)*((a.p2.y-a.p1.y)/a.len);e=t/a.len}});const i=GameConfig.BotSpeed*this.difficulty*(this.spectatorMode?1.5:1);t.pos<e-.05&&(t.pos+=i),t.pos>e+.05&&(t.pos-=i),t.pos=Math.max(.1,Math.min(.9,t.pos))}});for(let t=this.balls.length-1;t>=0;t--){let e=this.balls[t];if(e.portalCooldown>0&&e.portalCooldown--,2===this.portals.length&&e.portalCooldown<=0)for(let t=0;t<2;t++){let s=this.portals[t],i=Math.hypot(e.x-s.x,e.y-s.y);if(i<25){let i=this.portals[(t+1)%2];e.x=i.x,e.y=i.y,e.portalCooldown=GameConfig.PortalCooldown,AudioSys.play("portal"),this.boom(s.x,s.y,s.color,10),this.boom(i.x,i.y,i.color,10);break}}if("CURVE"===this.activeEvent){let t=.003*this.difficulty,s=e.vx;e.vx-=e.vy*t*e.curveDir,e.vy+=s*t*e.curveDir}else if("ZIGZAG"===this.activeEvent&&this.frame%20==0){const t=Math.atan2(e.vy,e.vx),s=Math.sqrt(e.vx*e.vx+e.vy*e.vy);e.vx=Math.cos(t+(Math.random()-.5))*s,e.vy=Math.sin(t+(Math.random()-.5))*s}else if("FLUX"===this.activeEvent&&Math.random()<.02){let t=.8+.4*Math.random();e.vx*=t,e.vy*=t}else if("CHAOS"===this.activeEvent&&Math.random()<.01){const t=Math.random()*Math.PI*2,s=Math.sqrt(e.vx*e.vx+e.vy*e.vy);e.vx=Math.cos(t)*s,e.vy=Math.sin(t)*s}else"REVERSE"===this.activeEvent&&Math.random()<.005&&(e.vx*=-1,e.vy*=-1,AudioSys.play("event"),this.boom(e.x,e.y,"#fff",5));if(e.x+=e.vx,e.y+=e.vy,e.trail.push({x:e.x,y:e.y}),e.trail.length>15&&e.trail.shift(),(e.x-this.centerX)**2+(e.y-this.centerY)**2>(2.5*this.radius)**2)this.balls.splice(t,1);else for(let s=0;s<this.walls.length;s++){const i=this.walls[s],a=this.players[i.id],o=e.x-i.p1.x,n=e.y-i.p1.y,l=o*i.nx+n*i.ny,r=e.vx*i.nx+e.vy*i.ny;if(l<10&&l>-15&&r<0){const l=o*((i.p2.x-i.p1.x)/i.len)+n*((i.p2.y-i.p1.y)/i.len),h=l/i.len;if(h>=0&&h<=1){let o=this.shrinkMode?.08:this.growMode?.25:.15;if(!a.dead&&!a.isWall&&Math.abs(h-a.pos)<o/2){let t=Math.min(1,Math.abs(r)/15);AudioSys.play("hit",t),this.boom(e.x,e.y,a.color,15),e.vx-=2*r*i.nx,e.vy-=2*r*i.ny;const s=2*(h-a.pos);e.vx+=-i.ny*s*2,e.vy+=i.nx*s*2,e.x+=5*i.nx,e.y+=5*i.ny,e.vx*=1.05,e.vy*=1.05,e.curveDir*=-1,e.lastTouchId=a.id,this.addScore(a.id,GameConfig.Score.Hit)}else a.dead||a.isWall?(AudioSys.play("wall"),e.vx-=2*r*i.nx,e.vy-=2*r*i.ny,e.x+=5*i.nx,e.y+=5*i.ny,this.boom(e.x,e.y,"#555",5),e.curveDir*=-1,e.lastTouchId=null):(this.loseLife(a,t),s=this.walls.length)}}}}for(let t=this.shockwaves.length-1;t>=0;t--){let e=this.shockwaves[t];e.r+=5,e.op-=.02,e.op<=0&&this.shockwaves.splice(t,1)}0!==this.balls.length||this.respawning||this.warmingUp||this.over||(this.respawning=!0,setTimeout(()=>{this.active&&(this.spawnBall(),this.respawning=!1)},1e3))},loseLife(t,e){const s=this.balls[e],i=this.walls[t.id],a=(i.p1.x+i.p2.x)/2,o=(i.p1.y+i.p2.y)/2;if(this.shockwaves.push({x:a,y:o,r:10,op:1,color:t.color}),s&&null!==s.lastTouchId&&s.lastTouchId!==t.id&&(this.addScore(s.lastTouchId,GameConfig.Score.Assist),t.lives<=1&&this.addScore(s.lastTouchId,GameConfig.Score.Kill)),s&&null!==s.ownerId){const t=this.players[s.ownerId];t&&t.dead&&Date.now()-s.spawnTime<GameConfig.ResurrectWindow&&this.resurrectPlayer(t)}s&&(this.boom(s.x,s.y,"#fff",40),this.balls.splice(e,1)),AudioSys.play("die"),t.lives--,t.lives<=0&&(t.dead=!0,t.shots=this.numPlayers,t.isUser&&this.showAlert("REVENGE MODE"))},resurrectPlayer(t){t.dead=!1,t.lives=1,t.shots=0,this.addScore(t.id,GameConfig.Score.Resurrect),this.showAlert("RESURRECTED!"),AudioSys.play("resurrect"),t.isUser&&(this.spectatorMode=!1);const e=this.walls[t.id],s=(e.p1.x+e.p2.x)/2,i=(e.p1.y+e.p2.y)/2;this.boom(s,i,"#00ff00",50)},boom(t,e,s,i){for(let a=0;a<i;a++){const i=Math.random()*Math.PI*2,a=5*Math.random()+2;this.particles.push({x:t,y:e,vx:Math.cos(i)*a,vy:Math.sin(i)*a,color:s,life:1,size:4*Math.random()+1})}},draw(){let t=null,e=-1;this.players.forEach(s=>{!s.dead&&!s.isWall&&s.lives>e&&(e=s.lives,t=s)}),this.targetBgRGB=t?t.rgb:{r:10,g:10,b:10},["r","g","b"].forEach(t=>this.currentBgRGB[t]+=.05*(this.targetBgRGB[t]-this.currentBgRGB[t]));let s=Math.floor(this.currentBgRGB.r),i=Math.floor(this.currentBgRGB.g),a=Math.floor(this.currentBgRGB.b);ctx.fillStyle=`rgb(${.1*s},${.1*i},${.1*a})`,ctx.fillRect(0,0,this.width,this.height),ctx.lineWidth=1,ctx.strokeStyle=`rgba(${s},${i},${a},0.2)`;const o=60,n=this.bgGridOffset,l=(t,e)=>{const s=Math.hypot(t-this.mouseX,e-this.mouseY);if(s<250){const i=(250-s)/250,a=Math.atan2(e-this.mouseY,t-this.mouseX);return{x:t+Math.cos(a)*i*40,y:e+Math.sin(a)*i*40}}return{x:t,y:e}};for(let t=n;t<this.width;t+=o){ctx.beginPath();for(let e=0;e<this.height;e+=30){let s=l(t,e);0===e?ctx.moveTo(s.x,s.y):ctx.lineTo(s.x,s.y)}ctx.stroke()}for(let t=n;t<this.height;t+=o){ctx.beginPath();for(let e=0;e<this.width;e+=30){let s=l(e,t);0===e?ctx.moveTo(s.x,s.y):ctx.lineTo(s.x,s.y)}ctx.stroke()}const r=ctx.createRadialGradient(this.centerX,this.centerY,this.radius,this.centerX,this.centerY,2.5*this.radius);r.addColorStop(0,"rgba(0,0,0,0)"),r.addColorStop(1,"rgba(0,0,0,0.8)"),ctx.fillStyle=r,ctx.fillRect(0,0,this.width,this.height),ctx.save(),ctx.translate(this.centerX,this.centerY),ctx.rotate(this.rotation),ctx.translate(-this.centerX,-this.centerY),this.shockwaves.forEach(t=>{ctx.strokeStyle=t.color,ctx.lineWidth=15,ctx.globalAlpha=t.op,ctx.beginPath(),ctx.arc(t.x,t.y,t.r,0,2*Math.PI),ctx.stroke()}),ctx.globalAlpha=1,this.portals.forEach(t=>{ctx.fillStyle=t.color,ctx.shadowColor=t.color,ctx.shadowBlur=20,ctx.beginPath(),ctx.arc(t.x,t.y,25,0,2*Math.PI),ctx.fill(),ctx.strokeStyle="#fff",ctx.lineWidth=2,ctx.beginPath();for(let e=0;e<3;e++){let s=.1*this.frame+2*e;ctx.moveTo(t.x,t.y),ctx.lineTo(t.x+25*Math.cos(s),t.y+25*Math.sin(s))}ctx.stroke(),ctx.shadowBlur=0}),"CURVE"===this.activeEvent?ctx.strokeStyle="#a0a":"ZIGZAG"===this.activeEvent?ctx.strokeStyle="#aa0":"FLUX"===this.activeEvent||"CHAOS"===this.activeEvent?ctx.strokeStyle="#0aa":"REVERSE"===this.activeEvent?ctx.strokeStyle="#fff":this.shrinkMode?ctx.strokeStyle="#f00":this.growMode?ctx.strokeStyle="#0f0":ctx.strokeStyle="#444",ctx.lineWidth=3,this.walls.forEach(t=>{const e=this.players[t.id];if(ctx.beginPath(),ctx.moveTo(t.p1.x,t.p1.y),ctx.lineTo(t.p2.x,t.p2.y),ctx.stroke(),!e.isWall){const s=(t.p1.x+t.p2.x)/2,i=(t.p1.y+t.p2.y)/2,a=s-this.centerX,o=i-this.centerY,n=Math.sqrt(a*a+o*o),l=a/n,r=o/n,h=60+10*this.difficulty,c=s+l*h,d=i+r*h;ctx.save(),ctx.translate(c,d);const u=Math.atan2(t.ny,t.nx);let m=u+Math.PI/2;if(ctx.rotate(m),ctx.textAlign="center",ctx.textBaseline="middle",ctx.fillStyle=e.color,ctx.font="bold 12px Orbitron",ctx.fillText(e.name,0,-15),ctx.fillStyle="#fff",ctx.font="bold 20px Orbitron",e.dead){if(ctx.fillStyle="#555",ctx.fillText("DEAD",0,5),e.shots>0){ctx.fillStyle="#fff";for(let t=0;t<e.shots;t++)ctx.beginPath(),ctx.arc(8*(t-(e.shots-1)/2),20,2,0,2*Math.PI),ctx.fill()}}else ctx.fillText(e.lives,0,5),ctx.font="10px Orbitron",ctx.fillStyle="rgba(255,255,255,0.7)",ctx.fillText(e.score,0,20);ctx.restore()}if(e.isUser&&e.dead&&e.shots>0){const e=(t.p1.x+t.p2.x)/2,s=(t.p1.y+t.p2.y)/2;ctx.fillStyle="#fff",ctx.shadowColor="#fff",ctx.shadowBlur=10,ctx.beginPath(),ctx.arc(e,s,6,0,2*Math.PI),ctx.fill(),ctx.shadowBlur=0}});let h=this.shrinkMode?.08:this.growMode?.25:.15;this.walls.forEach(t=>{const e=this.players[t.id];if(e.isWall)return;const s=e.pos-h/2,i=e.pos+h/2,a=t.p1.x+(t.p2.x-t.p1.x)*s,o=t.p1.y+(t.p2.y-t.p1.y)*s,n=t.p1.x+(t.p2.x-t.p1.x)*i,l=t.p1.y+(t.p2.y-t.p1.y)*i;ctx.lineWidth=8,ctx.lineCap="round",e.dead?(ctx.strokeStyle="rgba(255, 255, 255, 0.3)",ctx.setLineDash([5,10])):(ctx.strokeStyle=e.color,ctx.shadowColor=e.color,ctx.shadowBlur=15,ctx.setLineDash([])),ctx.beginPath(),ctx.moveTo(a,o),ctx.lineTo(n,l),ctx.stroke(),ctx.shadowBlur=0,ctx.lineCap="butt",ctx.setLineDash([])}),ctx.fillStyle="#fff",this.balls.forEach(t=>{null!==t.ownerId?(ctx.fillStyle="#ff5555",ctx.shadowColor="#f00"):(ctx.fillStyle="#fff",ctx.shadowColor="#fff"),ctx.shadowBlur=10,ctx.beginPath(),ctx.arc(t.x,t.y,6,0,2*Math.PI),ctx.fill(),ctx.shadowBlur=0,ctx.strokeStyle="rgba(255,255,255,0.3)",ctx.lineWidth=2,ctx.beginPath(),t.trail.forEach((t,e)=>{0===e?ctx.moveTo(t.x,t.y):ctx.lineTo(t.x,t.y)}),ctx.stroke()}),ctx.globalCompositeOperation="lighter",this.particles.forEach(t=>{ctx.fillStyle=t.color,ctx.globalAlpha=t.life,ctx.beginPath(),ctx.arc(t.x,t.y,t.size,0,2*Math.PI),ctx.fill()}),ctx.globalAlpha=1,ctx.globalCompositeOperation="source-over",ctx.restore()},loop(){if(!this.warmingUp&&!this.paused&&!this.over){let t=1;if(this.spectatorMode){const e=this.players.filter(t=>!t.dead&&!t.isWall).length;t=1+1/Math.max(1,e)}for(this.timeAccumulator+=t;this.timeAccumulator>=1;)this.update(),this.frame++,this.rotation+=.05*(this.targetRotation-this.rotation),this.timeAccumulator-=1;this.bgGridOffset=(this.bgGridOffset+.5*t)%60;for(let t=this.particles.length-1;t>=0;t--){let e=this.particles[t];e.x+=e.vx,e.y+=e.vy,e.life-=.02,e.life<=0&&this.particles.splice(t,1)}}this.draw(),this.loopId=requestAnimationFrame(()=>this.loop())},resize(){this.width=window.innerWidth,this.height=window.innerHeight,canvas.width=this.width,canvas.height=this.height,this.centerX=this.width/2,this.centerY=this.height/2;let t=this.numPlayers>10?.45:.4;this.radius=Math.min(this.width,this.height)*t,this.active&&this.createArena()},scheduleEvent(){if(!this.active)return;if(this.challengeTimer&&clearTimeout(this.challengeTimer),0===this.eventFrequency||0===this.enabledEvents.length)return;let t=1;if(this.spectatorMode){const e=this.players.filter(t=>!t.dead&&!t.isWall).length;t=1+1/Math.max(1,e)}let e=7e3-1500*this.eventFrequency,s=(e+4e3*Math.random())/t;this.challengeTimer=setTimeout(()=>{if(!this.active||this.paused||this.warmingUp||this.over)return void this.scheduleEvent();const t=this.enabledEvents[Math.floor(Math.random()*this.enabledEvents.length)],e=2===this.numPlayers?3:this.numPlayers+1;"MULTI-BALL"===t?this.balls.length<e?(this.spawnBall(),this.balls.length<e&&Math.random()>.5&&this.spawnBall(),this.showAlert("MULTI-BALL"),AudioSys.play("event")):this.triggerActiveEvent("GROW",400):"SPIN"===t?(this.targetRotation+=(Math.random()-.5)*Math.PI,this.showAlert("SPIN"),AudioSys.play("event")):"SURGE"===t?(this.balls.forEach(t=>{t.vx*=1.3,t.vy*=1.3}),this.showAlert("SURGE"),AudioSys.play("event")):"SHRINK"===t?(this.shrinkMode=!0,this.triggerActiveEvent("SHRINK",400)):"GROW"===t?(this.growMode=!0,this.triggerActiveEvent("GROW",400)):"WORMHOLE"===t?(this.spawnPortals(),this.showAlert("WORMHOLE"),AudioSys.play("event")):this.triggerActiveEvent(t,"ZIGZAG"===t||"FLUX"===t?300:400),this.scheduleEvent()},s)},triggerActiveEvent(t,e){this.activeEvent=t.replace("BALL",""),this.eventTimer=e,this.showAlert(t),AudioSys.play("event")},showAlert(t){const e=document.getElementById("alertBanner");e.innerText=t,e.classList.add("visible"),setTimeout(()=>e.classList.remove("visible"),2500)},handleInput(t,e){if(this.mouseX=t,this.mouseY=e,this.paused||!this.active||this.warmingUp)return;const s=this.players.find(t=>t.isUser);if(!s)return;const i=t-this.centerX,a=e-this.centerY,o=Math.cos(-this.rotation),n=Math.sin(-this.rotation),l=i*o-a*n,r=i*n+a*o,h=l+this.centerX,c=r+this.centerY,d=this.walls[s.id],u=h-d.p1.x,m=c-d.p1.y,p=d.p2.x-d.p1.x,y=d.p2.y-d.p1.y,x=d.len*d.len;let f=(u*p+m*y)/x;f=Math.max(.1,Math.min(.9,f)),s.pos=f}};window.addEventListener("resize",()=>Game.resize()),window.addEventListener("load",()=>{Game.initMenu(),Game.resize()}),window.addEventListener("mousemove",t=>Game.handleInput(t.clientX,t.clientY)),window.addEventListener("touchmove",t=>{t.preventDefault(),Game.handleInput(t.touches[0].clientX,t.touches[0].clientY)},{passive:!1}),window.addEventListener("mousedown",()=>{const t=Game.players.find(t=>t.isUser);t&&t.dead&&Game.shootFromDead(t)}),window.addEventListener("touchstart",()=>{const t=Game.players.find(t=>t.isUser);t&&t.dead&&Game.shootFromDead(t)});