function hexPalettesToNumeric(e){const t={};for(const n in e)t[n]=e[n].map(e=>parseInt(e.replace("#","0x")));return t}function luminance(e){const t=parseInt(e.slice(1),16),n=t>>16&255,o=t>>8&255,s=255&t;return.2126*n+.7152*o+.0722*s}function darker(e){const t=parseInt(e.slice(1),16);let n=t>>16&255,o=t>>8&255,s=255&t;return n=Math.floor(.6*n),o=Math.floor(.6*o),s=Math.floor(.6*s),"#"+((1<<24)+(n<<16)+(o<<8)+s).toString(16).slice(1)}function pickSound(e){const t=e.map(luminance).reduce((e,t)=>e+t,0)/e.length;return t<40?"bitcrush":t<70?"square":t<100?"sawtooth":t<130?"triangle":t<160?"sine":t<190?"chorus":t<220?"bells":"airpad"}function buildTheme(e){const t=[...e].sort((e,t)=>darker(e)-luminance(t)),n=t[0],o=t[1],s=o,r=t[t.length-1],a=luminance(n)<150?"#fff":"#111",i=pickSound(e),l=e.slice(0,8).map(e=>({t:e,b:darker(e)}));return{bgA:n,bgB:o,sound:i,panel:s,border:r,text:a,btns:l}}function fitCamera(e,t){const n=Math.sqrt(3),o=n,s=1.5,r=e/t;let a;a=r>GRID_COLS*o*1.1/(GRID_ROWS*s*1.1)?GRID_ROWS*s*1.1/2/Math.tan(Math.PI*camera.fov/360):GRID_COLS*o*1.1/2/Math.tan(Math.PI*camera.fov/360)/r,baseCameraPos.set(0,.5,a+2),camera.position.copy(baseCameraPos)}function setNextComboTarget(){comboTarget=Math.floor(16*Math.random())+15,comboCounter>comboTarget&&(comboCounter=comboTarget)}function createGridSafe(){const e=Math.sqrt(3),t=e,n=1.5,o=-(GRID_COLS-1)*t/2,s=(GRID_ROWS-1)*n/2;for(let e=0;e<GRID_ROWS;e++){let r=[];for(let a=0;a<GRID_COLS;a++){let i,l=new Set,c=e%2!=0;if(a>0&&l.add(r[a-1].type),e>0){const t=grid[e-1];let n=c?a:a-1,o=c?a+1:a;n>=0&&n<GRID_COLS&&l.add(t[n].type),o>=0&&o<GRID_COLS&&l.add(t[o].type)}do{i=Math.floor(Math.random()*currentPalette.length)}while(l.has(i));const F=createMesh(i,!1);F.position.set(o+a*t+(c?t/2:0),s-e*n,0),scene.add(F),r.push({r:e,c:a,type:i,mesh:F,wx:F.position.x,wy:F.position.y,isXion:!1})}grid.push(r)}calcClusters()}function createMesh(e,t){let n=t?MAT_XION.clone():MAT_GEM.clone();t||(n.color.setHex(currentPalette[e]),n.emissive.setHex(currentPalette[e]));const o=new THREE.Mesh(HEX_GEO,n);if(o.castShadow=!0,o.receiveShadow=!0,!t){const e=new THREE.LineSegments(EDGE_GEO,new THREE.LineBasicMaterial({color:0,linewidth:2}));e.scale.set(1.01,1.01,1.01),o.add(e)}if(t){const e=new THREE.Mesh(new THREE.IcosahedronGeometry(.4,1),new THREE.MeshBasicMaterial({color:16777215,wireframe:!0}));e.position.z=.4,o.add(e);const t=new THREE.PointLight(16777215,1,3);t.position.z=1,o.add(t)}return o}function calcClusters(){clusters=[];const e=(e,t)=>e>=0&&e<GRID_ROWS&&t>=0&&t<GRID_COLS?grid[e][t]:null;for(let t=0;t<GRID_ROWS;t++)for(let n=0;n<GRID_COLS;n++){const o=e(t,n);if(!o)continue;const s=t%2!=0,r=e(t+1,s?n:n-1),a=e(t+1,s?n+1:n);r&&a&&clusters.push({x:(o.wx+r.wx+a.wx)/3,y:(o.wy+r.wy+a.wy)/3,cells:[o,a,r]})}}function createSelector(){selectorMesh&&scene.remove(selectorMesh);const e=1.25,t=new THREE.RingGeometry(.8*e,.85*e,32),n=new THREE.MeshBasicMaterial({color:16777215,transparent:!0,opacity:0,side:2});selectorMesh=new THREE.Group,selectorMesh.add(new THREE.Mesh(t,n));const o=new THREE.Mesh(new THREE.CircleGeometry(e,32),new THREE.MeshBasicMaterial({color:16777215,transparent:!0,opacity:.15}));o.position.z=-.1,selectorMesh.add(o),scene.add(selectorMesh)}function onPointerMove(e){if(e.target.closest("#bottom-dashboard")||e.target.closest("dialog"))return;const t=renderer.domElement.getBoundingClientRect();if(mouse.x=(e.clientX-t.left)/t.width*2-1,mouse.y=-(e.clientY-t.top)/t.height*2+1,isAnimating)return;raycaster.setFromCamera(mouse,camera);const n=raycaster.intersectObject(dummyPlane);if(n.length>0){const e=n[0].point;let t=null,o=.8;for(const n of clusters){const s=Math.hypot(e.x-n.x,e.y-n.y);s<o&&(o=s,t=n)}t!==activeCluster&&(activeCluster=t,updateSelector())}}function onPointerDown(e){SoundEngine.init(),isAnimating||!activeCluster||e.target.closest("#bottom-dashboard")||e.target.closest("dialog")||rotateCluster(activeCluster,0===e.button)}function updateSelector(){activeCluster?(selectorMesh.position.set(activeCluster.x,activeCluster.y,.5),selectorMesh.children[0].material.opacity=1,selectorMesh.children[1].material.opacity=.2,document.body.style.cursor="pointer"):(selectorMesh.children[0].material.opacity=0,selectorMesh.children[1].material.opacity=0,document.body.style.cursor="default")}function rotateCluster(e,t){isAnimating=!0,selectorMesh.children[0].material.opacity=.3,SoundEngine.playRotate();const n=new THREE.Group;n.position.set(e.x,e.y,0),scene.add(n),e.cells.forEach(e=>n.attach(e.mesh));const o=t?2*-Math.PI/3:2*Math.PI/3;tween(n.rotation,{z:o},220,0,easeBackOut,()=>{e.cells.forEach(e=>{scene.attach(e.mesh),e.mesh.position.set(e.wx,e.wy,0),e.mesh.rotation.set(0,0,0)}),scene.remove(n);const[o,s,r]=e.cells,a=[{t:o.type,b:o.isXion},{t:s.type,b:s.isXion},{t:r.type,b:r.isXion}];t?(ap(s,a[0]),ap(r,a[1]),ap(o,a[2])):(ap(r,a[0]),ap(o,a[1]),ap(s,a[2])),updateVisuals(e.cells),resolveMatches(!0)})}function ap(e,t){e.type=t.t,e.isXion=t.b}function updateVisuals(e){e.forEach(e=>{for(;e.mesh.children.length;)e.mesh.remove(e.mesh.children[0]);if(e.isXion){e.mesh.material=MAT_XION.clone();const t=new THREE.Mesh(new THREE.IcosahedronGeometry(.4,1),new THREE.MeshBasicMaterial({color:16777215,wireframe:!0}));t.position.z=.4,e.mesh.add(t);const n=new THREE.PointLight(16777215,1,3);n.position.z=1,e.mesh.add(n)}else{e.mesh.material=MAT_GEM.clone();const t=currentPalette[e.type];e.mesh.material.color.setHex(t),e.mesh.material.emissive.setHex(t);const n=new THREE.LineSegments(EDGE_GEO,new THREE.LineBasicMaterial({color:0,linewidth:2}));n.scale.set(1.01,1.01,1.01),e.mesh.add(n)}})}function resolveMatches(e){let t=new Set,n=[];const o=(e,t)=>{const n=e%2!=0,o=[[0,-1],[0,1],[-1,n?0:-1],[-1,n?1:0],[1,n?0:-1],[1,n?1:0]];return o.map(n=>({r:e+n[0],c:t+n[1]})).filter(e=>e.r>=0&&e.r<GRID_ROWS&&e.c>=0&&e.c<GRID_COLS)};for(let e=0;e<GRID_ROWS;e++)for(let s=0;s<GRID_COLS;s++){const r=`${e},${s}`;if(t.has(r))continue;let a=grid[e][s].type;if(-1===a)continue;let i=[];t.add(r),i.push({r:e,c:s});let l=0;for(;l<i.length;){let e=i[l++];o(e.r,e.c).forEach(e=>{let n=`${e.r},${e.c}`;t.has(n)||grid[e.r][e.c].type!==a||-1===grid[e.r][e.c].type||(t.add(n),i.push(e))})}i.length>=3&&(n=n.concat(i))}if(n.length>0){isAnimating=!0;let t=new Set,o=!1,s=-1;if(n.forEach(e=>{grid[e.r][e.c].isXion&&(o=!0,s=grid[e.r][e.c].type)}),shakeIntensity=o?1.5:n.length>5?.8:.4,o){for(let e=0;e<GRID_ROWS;e++)for(let n=0;n<GRID_COLS;n++)grid[e][n].type===s&&t.add(`${e},${n}`);comboCounter=0,setNextComboTarget()}else if(n.forEach(e=>t.add(`${e.r},${e.c}`)),e&&(comboCounter++,comboCounter>=comboTarget&&(comboCounter=comboTarget,spawnXionNext=!0),score+=10*n.length,xp+=10,SoundEngine.playMatch(),xp>=100)){level++,xp-=100,SoundEngine.playLevelUp();const e=document.getElementById("level-display");e.classList.remove("level-anim"),e.offsetWidth,e.classList.add("level-anim");const t=Object.keys(PALETTES_HEX),n=t[Math.floor(Math.random()*t.length)];if(setPalette(n),level%5==0)return document.getElementById("final-score").innerText=score,document.getElementById("game-over-modal").showModal(),void(isAnimating=!0)}updateUI();const r=Array.from(t).map(e=>{const[t,n]=e.split(",");return{r:+t,c:+n}});let a=0;r.forEach(e=>{const t=grid[e.r][e.c];spawnParticles(t.mesh.position,currentPalette[t.type]),tween(t.mesh.scale,{x:.01,y:.01},200,100*Math.random(),easeInQuad,()=>{t.mesh.visible=!1,a++,a===r.length&&applyGravity(r)})})}else isAnimating=!1,updateSelector()}function applyGravity(e){e.forEach(e=>{grid[e.r][e.c].type=-1,grid[e.r][e.c].mesh.scale.set(1,1,1),grid[e.r][e.c].mesh.visible=!1});for(let t=0;t<GRID_COLS;t++){let n=[];for(let e=0;e<GRID_ROWS;e++)-1!==grid[e][t].type&&n.push({t:grid[e][t].type,b:grid[e][t].isXion});let o=GRID_ROWS-n.length;for(let e=0;e<o;e++){let t,s=-1;0===e&&n.length>0&&(s=n[0].t);do{t=Math.floor(Math.random()*currentPalette.length)}while(t===s);let r=!1;spawnXionNext&&e===o-1&&(r=!0,spawnXionNext=!1,updateUI()),n.unshift({t:t,b:r})}for(let o=0;o<GRID_ROWS;o++){const s=grid[o][t],r=n[o];s.type=r.t,s.isXion=r.b,s.mesh.visible=!0,s.mesh.scale.set(1,1,1),s.mesh.rotation.set(0,0,0),updateVisuals([s]),e.some(e=>e.c===t&&e.r>=o)?(s.mesh.position.y=s.wy+6,tween(s.mesh.position,{y:s.wy},500,200*Math.random(),easeOutBounce)):s.mesh.position.y=s.wy}}setTimeout(()=>resolveMatches(!0),650)}function spawnParticles(e,t){for(let n=0;n<12;n++){const n=new THREE.Mesh(PARTICLE_GEO,new THREE.MeshBasicMaterial({color:t,side:2,transparent:!0}));n.position.set(e.x,e.y,e.z+.5);const o=Math.random()*Math.PI*2,s=.05+.1*Math.random();scene.add(n),particles.push({mesh:n,vx:Math.cos(o)*s,vy:Math.sin(o)*s,vz:.1,life:1})}}function updateUI(){document.getElementById("ui-level").innerText=level,document.getElementById("txt-score").innerText=xp+"%",document.getElementById("bar-score").style.width=Math.min(100,xp)+"%";const e=Math.min(100,comboCounter/comboTarget*100);document.getElementById("bar-charge").style.width=e+"%"}function tween(e,t,n,o,s,r){const a={};for(let n in t)e[n]&&e[n].clone?a[n]=e[n].clone():a[n]=e[n];tweens.push({obj:e,props:t,start:a,startTime:Date.now()+o,duration:n,easing:s||(e=>e),onComplete:r})}function updateTweens(){const e=Date.now();for(let t=tweens.length-1;t>=0;t--){const n=tweens[t];if(e<n.startTime)continue;let o=(e-n.startTime)/n.duration;if(o>=1){for(let e in n.props)n.obj[e]&&n.obj[e].copy?n.obj[e].copy(n.props[e]):n.obj[e]=n.props[e];n.onComplete&&n.onComplete(),tweens.splice(t,1)}else{const e=n.easing(o);for(let t in n.props)"number"==typeof n.obj[t]?n.obj[t]=n.start[t]+(n.props[t]-n.start[t])*e:n.obj[t]&&n.obj[t].lerp?n.obj[t].copy(n.start[t]).lerp(n.props[t],e):n.obj[t]&&n.obj[t].isColor&&(n.obj[t].r=n.start[t].r+(n.props[t].r-n.start[t].r)*e,n.obj[t].g=n.start[t].g+(n.props[t].g-n.start[t].g)*e,n.obj[t].b=n.start[t].b+(n.props[t].b-n.start[t].b)*e)}}}function animate(){requestAnimationFrame(animate),updateTweens(),bgMesh&&(bgMesh.material.uniforms.uTime.value+=.02),shakeIntensity>0&&(camera.position.x=baseCameraPos.x+.2*(Math.random()-.5)*shakeIntensity,camera.position.y=baseCameraPos.y+.2*(Math.random()-.5)*shakeIntensity,shakeIntensity-=.05,shakeIntensity<0&&(shakeIntensity=0,camera.position.copy(baseCameraPos)));for(let e=particles.length-1;e>=0;e--){const t=particles[e];t.life-=.02,t.mesh.position.add(new THREE.Vector3(t.vx,t.vy,t.vz)),t.mesh.scale.setScalar(t.life),t.mesh.material.opacity=t.life,t.life<=0&&(scene.remove(t.mesh),t.mesh.material&&t.mesh.material.dispose(),particles.splice(e,1))}renderer.render(scene,camera),selectorMesh&&selectorMesh.children[0].material.opacity>0&&(selectorMesh.rotation.z+=.005)}function onResize(){const e=document.getElementById("game-container");camera.aspect=e.clientWidth/e.clientHeight,camera.updateProjectionMatrix(),renderer.setSize(e.clientWidth,e.clientHeight),fitCamera(e.clientWidth,e.clientHeight)}import*as THREE from"https://esm.sh/three";import{RoomEnvironment}from"https://esm.sh/three/addons/environments/RoomEnvironment.js";const SoundEngine={ctx:null,enabled:!0,waveform:"sine",init:function(){this.ctx||(this.ctx=new(window.AudioContext||window.webkitAudioContext)),"suspended"===this.ctx.state&&this.ctx.resume()},toggle:function(){return this.enabled=!this.enabled,this.enabled},setWaveform:function(e){this.waveform=e},playTone:function(e,t,n=.1){if(!this.enabled||!this.ctx)return;const o=this.ctx.createOscillator(),s=this.ctx.createGain();o.type=this.waveform,o.frequency.setValueAtTime(e,this.ctx.currentTime),s.gain.setValueAtTime(n,this.ctx.currentTime),s.gain.exponentialRampToValueAtTime(.01,this.ctx.currentTime+t),o.connect(s),s.connect(this.ctx.destination),o.start(),o.stop(this.ctx.currentTime+t)},playClick:function(){this.playTone(800,.1,.05)},playRotate:function(){this.playTone(300,.15,.05)},playMatch:function(){const e="square"===this.waveform?220:440;this.playTone(e,.3,.1),setTimeout(()=>this.playTone(1.25*e,.3,.1),50),setTimeout(()=>this.playTone(1.5*e,.3,.1),100)},playLevelUp:function(){this.playTone(523,.4,.1),setTimeout(()=>this.playTone(659,.4,.1),100),setTimeout(()=>this.playTone(784,.4,.1),200),setTimeout(()=>this.playTone(1046,.6,.1),300)}},BG_VERT="varying vec2 vUv;void main(){vUv=uv;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);}",BG_FRAG="varying vec2 vUv;uniform float uTime;uniform vec3 uColorA;uniform vec3 uColorB;void main(){float v=sin(vUv.x*10.0+uTime);v+=sin((vUv.y*10.0+uTime)*0.5);v+=sin((vUv.x*10.0+vUv.y*10.0+uTime)*0.5);float cx=vUv.x+0.5*sin(uTime*0.2);float cy=vUv.y+0.5*cos(uTime*0.3);v+=sin(sqrt(cx*cx+cy*cy+1.0)*10.0+uTime);v=v*0.5;float r=sin(v*4.0*3.1415)*0.5+0.5;vec3 col=mix(uColorA,uColorB,r);col=mix(col,vec3(1.0),0.1);float dist=distance(vUv,vec2(0.5));col*=1.2-dist*0.5;gl_FragColor=vec4(col,1.0);}",PALETTES_HEX={earthy_ocean_tones:["#0D1F22","#3E5C60","#A0684F","#D6D6D6","#F2E8D5","#E3C992","#50E3C2","#FFFFFF"],lush_green_forest:["#02120A","#1F4F2A","#00FF55","#CCFF00","#EBE0CC","#FFFFFF","#FF3333","#4A2205"],cozy_autumn_glow:["#FFFFFF","#FF4500","#D1925C","#FFD700","#5C4033","#4A90E2","#2F4F4F","#000000"],fiery_citrus_green:["#FF2200","#FFAA00","#FFFF00","#F0E68C","#66FF00","#006400","#000000","#FFFFFF"],tropical_sunset_paradise_mix:["#002222","#00E5FF","#80CBC4","#FFFF00","#FF6600","#111111","#FF0000","#BBFFBB"],tropical_sunset_paradise_pink:["#003333","#00FFFF","#FFD700","#FF5500","#FF0000","#FFAA88","#FF99CC","#FFFFFF"],vibrant_mix:["#0000FF","#00FFFF","#00FF00","#DDDD00","#FFFF00","#FFAA00","#FF0000","#FF00FF"],enchanted_forest_adventure:["#443311","#8B4513","#4B0082","#0000FF","#004400","#AAAA00","#000000","#EEEEEE"],fiery_hot_summer:["#330000","#AA0000","#FF0000","#FF5500","#FFAA00","#FFFF00","#FFFFFF","#001133"],rosy_golden_delight:["#550088","#224455","#00FF99","#FFD700","#FF8800","#990000","#FF66AA","#FFFFFF"],sunset_citrus_delight:["#FFFFFF","#FF9900","#FFEE00","#CCCC99","#888844","#445522","#000000","#663311"],vibrant_earthy_oasis:["#FF0055","#FF7755","#FFFF00","#00FF66","#00AAFF","#000066","#666666","#000000"],dark_stormy_skyline:["#FFFFFF","#CCCCCC","#888888","#444444","#000000","#552200","#990000","#000099"],summer_sunset_palette:["#002244","#00EEEE","#88FF88","#EEAA55","#FF3300","#660000","#FFFFFF","#444444"],golden_summer_magic:["#FFFF00","#FF9900","#CC1155","#660066","#330066","#000088","#000000","#FFFFFF"],summer_sunset_spectrum:["#FF0088","#FF4400","#FFCC00","#00CC00","#00FFFF","#0000FF","#111166","#000000"],turquoise_dreamland:["#66FFCC","#00FFFF","#3399FF","#0000FF","#000066","#FFFFFF","#006666","#111144"],blue_lagoon_gradients:["#FFFFFF","#88CCFF","#00AAFF","#2266FF","#0000FF","#000066","#00FFFF","#44FFCC"],golden_sky_symphony:["#88CCFF","#2288FF","#000088","#FFFFFF","#FFFF00","#FFCC00","#FF8800","#000000"],earthy_neutral_tones:["#663311","#CC6611","#FF9944","#DDBB88","#FFFFEE","#FFFFFF","#888888","#000000"],dark_gray_mystery:["#FFFFFF","#DDDDDD","#AAAAAA","#777777","#555555","#333333","#111111","#000000"],golden_desert_oasis:["#445522","#AAAA55","#FFEE88","#FFCC00","#FF8800","#AA4411","#663311","#FFFFFF"],electric_rainbow_dreams:["#00FFFF","#00FF00","#FFFF00","#FF00FF","#8800CC","#440088","#0000FF","#FFFFFF"],vibrant_summer_garden:["#FF0000","#FF8800","#FFFF00","#00FF00","#00FFFF","#0000FF","#8800AA","#FFFFFF"],sunflower_meadow_bliss:["#666600","#FFCC00","#FFFF00","#FFFFCC","#FFFFFF","#000000","#663311","#004400"],nautical_blue_journey:["#000066","#0000FF","#00AAFF","#88CCFF","#DDFFFF","#FFFFFF","#666666","#000000"],neon_pop_candy:["#FF0088","#FF66AA","#8800CC","#FFFF00","#FF4400","#2288FF","#00FFFF","#FFFFFF"],cherry_blossom_delight:["#220000","#660000","#AA0000","#FF0000","#FF5533","#FFFFFF","#000000","#FFBBDD"],warm_autumn_glow:["#445522","#88AA88","#FFEE88","#FFCC00","#FF8800","#AA4411","#663311","#000000"],pastel_garden_party:["#88BB88","#FF7777","#FFCC99","#FFFFCC","#99CCFF","#FFFFFF","#EEDDFF","#AAAAAA"],vibrant_summer_fiesta:["#CC0033","#00FFFF","#FF5599","#33CC33","#8866CC","#FF3300","#006666","#FFCC00"],summer_fun_colors:["#001133","#2288FF","#228855","#66FFCC","#FFCC00","#FF3300","#CC0033","#FFFFFF"],whimsical_dreamy_hues:["#CCFFFF","#88CCFF","#FFBBDD","#FF6699","#FFFFCC","#88FF88","#AAFFEE","#FFFFFF"],vibrant_earthy_rainforest:["#224444","#2288FF","#00FF88","#228855","#FFCC00","#FF8800","#FF3300","#000000"],enchanted_twilight:["#330066","#6600AA","#8866CC","#FFFFFF","#000000","#660066","#AAFF00","#FFFF00"],vibrant_rainbow_delight:["#FF0000","#FF8800","#FFFF00","#2288FF","#330066","#00FFFF","#00FF00","#FF0088"],pastel_garden_escape:["#EEFFEE","#88FF88","#00CC00","#006600","#004400","#228855","#00FF88","#000000"],autumn_spice_delight:["#331111","#883311","#CC5511","#FF9944","#CC9900","#AA9944","#445522","#000000"],earthy_mauve_blush:["#224444","#333366","#6600AA","#CC44CC","#FF4488","#FFAA66","#FFCCAA","#FFFFFF"],vintage_summer_vibes:["#FFEECC","#CC8844","#AA3333","#663311","#224444","#667788","#999999","#EEEE88"],cozy_neutral_haven:["#EEEEEE","#EEEE88","#CCAA66","#AA6666","#663311","#FFFFFF","#888888","#CC6611"],mystic_earth_tones:["#000000","#224444","#660066","#CC0033","#FF6666","#FF8800","#FFCC00","#FFFFCC"],fiery_autumn_sunset:["#222222","#660000","#CC5511","#CC9900","#FFEE88","#FFFFFF","#008888","#004400"]},THEME_NAMES={earthy_ocean_tones:"Earthy Ocean Tones",lush_green_forest:"Lush Green Forest",cozy_autumn_glow:"Cozy Autumn Glow",fiery_citrus_green:"Fiery Citrus Green",tropical_sunset_paradise_mix:"Tropical Sunset (Mix)",tropical_sunset_paradise_pink:"Tropical Sunset (Pink)",vibrant_mix:"Vibrant Mix",enchanted_forest_adventure:"Enchanted Forest",fiery_hot_summer:"Fiery Hot Summer",rosy_golden_delight:"Rosy Golden Delight",sunset_citrus_delight:"Sunset Citrus Delight",vibrant_earthy_oasis:"Vibrant Earthy Oasis",dark_stormy_skyline:"Dark Stormy Skyline",summer_sunset_palette:"Summer Sunset Palette",golden_summer_magic:"Golden Summer Magic",summer_sunset_spectrum:"Summer Sunset Spectrum",turquoise_dreamland:"Turquoise Dreamland",blue_lagoon_gradients:"Blue Lagoon Gradients",golden_sky_symphony:"Golden Sky Symphony",earthy_neutral_tones:"Earthy Neutral Tones",dark_gray_mystery:"Dark Gray Mystery",golden_desert_oasis:"Golden Desert Oasis",electric_rainbow_dreams:"Electric Rainbow Dreams",vibrant_summer_garden:"Vibrant Summer Garden",sunflower_meadow_bliss:"Sunflower Meadow Bliss",nautical_blue_journey:"Nautical Blue Journey",neon_pop_candy:"Neon Pop Candy",cherry_blossom_delight:"Cherry Blossom Delight",warm_autumn_glow:"Warm Autumn Glow",pastel_garden_party:"Pastel Garden Party",vibrant_summer_fiesta:"Vibrant Summer Fiesta",summer_fun_colors:"Summer Fun Colors",whimsical_dreamy_hues:"Whimsical Dreamy Hues",vibrant_earthy_rainforest:"Vibrant Earthy Rainforest",enchanted_twilight:"Enchanted Twilight",vibrant_rainbow_delight:"Vibrant Rainbow Delight",pastel_garden_escape:"Pastel Garden Escape",autumn_spice_delight:"Autumn Spice Delight",earthy_mauve_blush:"Earthy Mauve Blush",vintage_summer_vibes:"Vintage Summer Vibes",cozy_neutral_haven:"Cozy Neutral Haven",mystic_earth_tones:"Mystic Earth Tones",fiery_autumn_sunset:"Fiery Autumn Sunset"},PALETTES=hexPalettesToNumeric(PALETTES_HEX),THEME_UI=Object.fromEntries(Object.entries(PALETTES_HEX).map(([e,t])=>[e,buildTheme(t)]));let scene,camera,renderer,raycaster,pmremGenerator,dummyPlane,selectorMesh,currentPalette=PALETTES.tropical_sunset_paradise_mix,mouse=new THREE.Vector2,grid=[],clusters=[],activeCluster=null,isAnimating=!1,score=0,level=1,xp=0,comboCounter=0,comboTarget=30,spawnXionNext=!1,particles=[],shakeIntensity=0,baseCameraPos=new THREE.Vector3(0,0,0);const PARTICLE_GEO=new THREE.PlaneGeometry(.12,.12),GRID_COLS=7,GRID_ROWS=5;let bgMesh,HEX_GEO,MAT_GEM,MAT_XION,EDGE_GEO,hintInterval=null;const pc=document.getElementById("palette-container");for(const[e,t]of Object.entries(THEME_NAMES)){const n=document.createElement("button");n.className="pal-btn",n.innerText=t;const o=THEME_UI[e];n.style.background=`linear-gradient(135deg, ${o.btns[0].t}, ${o.btns[1].t})`,"pastel"!==e&&"candy"!==e||(n.style.color="#333",n.style.textShadow="none"),n.onclick=(()=>{setPalette(e),SoundEngine.playClick(),document.getElementById("modal-colors").close()}),pc.appendChild(n)}window.init=function(){const e=document.getElementById("game-container");e.innerHTML="",scene=new THREE.Scene,HEX_GEO=new THREE.CylinderGeometry(.95,.95,.3,6).rotateX(Math.PI/2),EDGE_GEO=new THREE.EdgesGeometry(HEX_GEO),MAT_GEM=new THREE.MeshStandardMaterial({roughness:.8,metalness:0,emissiveIntensity:.6}),MAT_XION=new THREE.MeshStandardMaterial({color:16777215,roughness:.4,metalness:.8,emissive:16777215,emissiveIntensity:.8});const t=new THREE.PlaneGeometry(50,50),n=new THREE.ShaderMaterial({vertexShader:BG_VERT,fragmentShader:BG_FRAG,uniforms:{uTime:{value:0},uColorA:{value:new THREE.Color(0)},uColorB:{value:new THREE.Color(0)}},depthWrite:!1});bgMesh=new THREE.Mesh(t,n),bgMesh.position.z=-10,scene.add(bgMesh),camera=new THREE.PerspectiveCamera(45,e.clientWidth/e.clientHeight,.1,100),renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),renderer.setSize(e.clientWidth,e.clientHeight),renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),renderer.shadowMap.enabled=!0,renderer.shadowMap.type=THREE.PCFSoftShadowMap,renderer.toneMapping=THREE.ACESFilmicToneMapping,renderer.toneMappingExposure=1,e.appendChild(renderer.domElement),pmremGenerator=new THREE.PMREMGenerator(renderer),scene.environment=pmremGenerator.fromScene(new RoomEnvironment,.04).texture,raycaster=new THREE.Raycaster,dummyPlane=new THREE.Mesh(new THREE.PlaneGeometry(200,200),new THREE.MeshBasicMaterial({visible:!1})),scene.add(dummyPlane),window.addEventListener("pointermove",onPointerMove),window.addEventListener("pointerdown",onPointerDown),window.addEventListener("resize",onResize),document.body.oncontextmenu=(()=>!1);const o=Object.keys(PALETTES_HEX),s=o[Math.floor(Math.random()*o.length)];setPalette(s),startLevel(!1),fitCamera(e.clientWidth,e.clientHeight),animate(),setTimeout(onResize,100)},window.startLevel=function(e){grid&&grid.forEach(e=>e.forEach(e=>{e.mesh&&(scene.remove(e.mesh),e.mesh.material&&e.mesh.material.clone&&e.mesh.material.dispose())})),particles.forEach(e=>{scene.remove(e.mesh),e.mesh.material&&e.mesh.material.dispose()}),particles=[],grid=[],clusters=[],activeCluster=null,e||(score=0,level=1),xp=0,comboCounter=0,isAnimating=!1,spawnXionNext=!1,setNextComboTarget(),createSelector(),createGridSafe(),updateUI()},window.resetGame=(()=>{SoundEngine.playClick(),startLevel(!1)}),window.nextLevel=(()=>{SoundEngine.playClick(),document.getElementById("game-over-modal").close(),startLevel(!0)}),window.toggleSound=(()=>{const e=SoundEngine.toggle();document.getElementById("icon-sound").innerText=e?"volume_up":"volume_off",SoundEngine.playClick()}),window.setPalette=function(e){if(PALETTES[e]){currentPalette=PALETTES[e],grid.forEach(e=>e.forEach(e=>updateVisuals([e])));const t=THEME_UI[e];if(t){const n=document.documentElement.style;n.setProperty("--c-panel",t.panel),n.setProperty("--c-panel-border",t.border),n.setProperty("--c-text-main",t.text),n.setProperty("--c-text-btn",e.includes("pastel")||e.includes("candy")?"#333":"#fff");for(let e=0;e<8;e++)n.setProperty(`--btn-${e+1}-top`,t.btns[e].t),n.setProperty(`--btn-${e+1}-bot`,t.btns[e].b),n.setProperty(`--btn-${e+1}-shadow`,new THREE.Color(t.btns[e].b).multiplyScalar(.7).getStyle());bgMesh&&(tween(bgMesh.material.uniforms.uColorA.value,new THREE.Color(t.bgA),500,0,e=>e),tween(bgMesh.material.uniforms.uColorB.value,new THREE.Color(t.bgB),500,0,e=>e)),SoundEngine.setWaveform(t.sound)}}},window.shareTwitter=function(){SoundEngine.playClick();const e="https://codepen.io/Julibe/pen/GgZGmqb",t="Julibe",n=["Twisting hexes and blowing minds! ðŸš€","Six sides. Infinite possibilities. ðŸ§ âœ¨","Forget square grids. Hex is key. #Hexplosion ðŸŽ¨ðŸ”¥","Hex logic hits different. ðŸš¨ðŸ§©","Sharpen your mind one hex at a time. âš¡","The grid just evolved. Welcome to the hex zone. ðŸ”·","When geometry becomes pure art. ðŸŽ›ï¸âœ¨","Hex moves. Big brain energy. ðŸ§ ðŸ’¥","Your next obsession has six sides. ðŸ’«","Tactical. Clean. Addictive. Hex mastery unlocked. ðŸ”“"],o=n[Math.floor(Math.random()*n.length)],s="WebGL,ThreeJS,HexGrid,GameDev,BrainPuzzle,IndieDev,LogicGame";window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(o)}&url=${encodeURIComponent(e)}&hashtags=${encodeURIComponent(s)}&via=${encodeURIComponent(t)}`,"_blank")},window.hint=(()=>{if(SoundEngine.playClick(),!hintInterval&&clusters.length){const e=Math.floor(Math.random()*clusters.length);activeCluster=clusters[e],updateSelector(),hintInterval=setInterval(()=>{selectorMesh.visible=!selectorMesh.visible},100),setTimeout(()=>{clearInterval(hintInterval),hintInterval=null,selectorMesh.visible=!0,activeCluster===clusters[e]&&(activeCluster=null),updateSelector()},800)}});let tweens=[];const easeBackOut=e=>1+2.70158*Math.pow(e-1,3)+1.70158*Math.pow(e-1,2),easeOutBounce=e=>{const t=7.5625,n=2.75;return e<1/n?t*e*e:e<2/n?t*(e-=1.5/n)*e+.75:e<2.5/n?t*(e-=2.25/n)*e+.9375:t*(e-=2.625/n)*e+.984375},easeInQuad=e=>e*e;window.onload=init;