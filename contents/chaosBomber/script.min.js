function generateLevel(){map=[],entities=[],particles=[];for(let t=0;t<ROWS;t++){let e=[];for(let i=0;i<COLS;i++)if(0===t||t===ROWS-1||0===i||i===COLS-1)e.push(1);else if(t%2==0&&i%2==0)e.push(1);else{let t=.3+.02*floorLevel;t>.5&&(t=.5),Math.random()<t?e.push(2):e.push(0)}map.push(e)}map[1][1]=0,map[1][2]=0,map[2][1]=0,entities.push(new Player(TILE_SIZE+8,TILE_SIZE+8));let t=!1;for(;!t;){let e=Math.floor(Math.random()*(ROWS-2))+1,i=Math.floor(Math.random()*(COLS-2))+1;(e>ROWS/2||i>COLS/2)&&2===map[e][i]&&(map[e][i]=5,t=!0)}let e=2+Math.floor(floorLevel/2);for(let t=0;t<e;t++)findSafeSpawn("ghost");floorLevel>=2&&findSafeSpawn("bot"),document.getElementById("score").innerText="FLOOR: "+floorLevel}function findSafeSpawn(t){let e=!1;for(;!e;){let i=Math.floor(Math.random()*(ROWS-2))+1,s=Math.floor(Math.random()*(COLS-2))+1;if(0===map[i][s]&&(i>4||s>4)){const h=s*TILE_SIZE+8,o=i*TILE_SIZE+8;"ghost"===t&&entities.push(new Ghost(h,o)),"bot"===t&&entities.push(new Bot(h,o)),e=!0}}}function placeBomb(t){const e=Math.floor((t.x+t.w/2)/TILE_SIZE),i=Math.floor((t.y+t.h/2)/TILE_SIZE),s=entities.find(t=>t instanceof Bomb&&t.gx===e&&t.gy===i);return!s&&1!==map[i][e]&&(entities.push(new Bomb(e,i,t)),!0)}function createExplosion(t,e,i){const s=[[0,0],[0,-1],[0,1],[-1,0],[1,0]];fire(t,e),s.slice(1).forEach(s=>{for(let h=1;h<=i;h++){let i=t+s[0]*h,o=e+s[1]*h;if(1===map[o][i])break;if(fire(i,o),2===map[o][i]||5===map[o][i]){if(5===map[o][i])map[o][i]=9;else{const t=Math.random();map[o][i]=t<.15?6:t<.3?7:0}createExplosionEffect(i*TILE_SIZE+25,o*TILE_SIZE+25,10,"#aaa");break}}})}function fire(t,e){particles.push({x:t*TILE_SIZE,y:e*TILE_SIZE,w:TILE_SIZE,h:TILE_SIZE,life:15,type:"fire"}),entities.forEach(i=>{if(i.dead||i instanceof Bomb)return;const s=i.getCenter(),h=Math.floor(s.x/TILE_SIZE),o=Math.floor(s.y/TILE_SIZE);h===t&&o===e&&("player"===i.type?i.die():(i.dead=!0,createExplosionEffect(i.x+i.w/2,i.y+i.h/2,15,i.color)))}),entities.forEach(i=>{i instanceof Bomb&&!i.exploded&&i.gx===t&&i.gy===e&&(i.timer=1)})}function isDanger(t,e){for(let i of entities)if(i instanceof Bomb&&!i.exploded){const s=Math.abs(i.gx-t),h=Math.abs(i.gy-e);if(0===h&&s<=i.range)return!0;if(0===s&&h<=i.range)return!0}return!1}function checkCollision(t,e,i,s){const h=[{cx:t,cy:e},{cx:t+i,cy:e},{cx:t,cy:e+s},{cx:t+i,cy:e+s}];for(let t of h){const e=Math.floor(t.cx/TILE_SIZE),i=Math.floor(t.cy/TILE_SIZE);if(i<0||i>=ROWS||e<0||e>=COLS)return!0;const s=map[i][e];if(1===s||2===s||5===s)return!0}return!1}function checkItemPickup(t){const e=Math.floor((t.x+t.w/2)/TILE_SIZE),i=Math.floor((t.y+t.h/2)/TILE_SIZE),s=map[i][e];9===s?nextLevel():6===s?(t.maxBombs++,map[i][e]=0,createFloatingText("BOMBS++",t.x,t.y)):7===s&&(t.bombRange++,map[i][e]=0,createFloatingText("FIRE++",t.x,t.y))}function rectIntersect(t,e,i,s,h,o,a,l){return h<t+i&&h+a>t&&o<e+s&&o+l>e}function createParticle(t,e,i,s){const h=Math.random()*Math.PI*2;particles.push({x:t,y:e,vx:Math.cos(h)*s,vy:Math.sin(h)*s,life:30+20*Math.random(),color:i,type:"part"})}function createExplosionEffect(t,e,i,s){for(let h=0;h<i;h++)createParticle(t,e,s,3*Math.random())}function createFloatingText(t,e,i){particles.push({x:e,y:i,vx:0,vy:-1,life:60,text:t,type:"text"})}function screenShake(t){shakeIntensity=t}function update(){gameRunning&&(shakeIntensity>0&&(shakeIntensity*=.9),shakeIntensity<.5&&(shakeIntensity=0),entities.forEach(t=>t.update()),entities=entities.filter(t=>!t.dead&&!t.exploded),particles.forEach(t=>{"fire"===t.type?t.life--:"part"!==t.type&&"text"!==t.type||(t.x+=t.vx,t.y+=t.vy,t.life--)}),particles=particles.filter(t=>t.life>0))}function draw(){ctx.setTransform(1,0,0,1,0,0),ctx.fillStyle=C_BG,ctx.fillRect(0,0,WIDTH,HEIGHT);const t=(Math.random()-.5)*shakeIntensity,e=(Math.random()-.5)*shakeIntensity;ctx.translate(t,e);for(let t=0;t<ROWS;t++)for(let e=0;e<COLS;e++){const i=e*TILE_SIZE,s=t*TILE_SIZE,h=map[t][e];1===h?(ctx.fillStyle=C_WALL_HARD,ctx.fillRect(i,s,TILE_SIZE,TILE_SIZE),ctx.fillStyle="#444",ctx.fillRect(i+5,s+5,TILE_SIZE-10,TILE_SIZE-10)):2===h||5===h?(ctx.fillStyle=C_WALL_SOFT,ctx.fillRect(i+2,s+2,TILE_SIZE-4,TILE_SIZE-4),ctx.fillStyle="#222",ctx.beginPath(),ctx.arc(i+15,s+15,4,0,2*Math.PI),ctx.arc(i+35,s+35,4,0,2*Math.PI),ctx.fill()):9===h?(ctx.strokeStyle=C_ACCENT,ctx.lineWidth=3,ctx.beginPath(),ctx.moveTo(i+TILE_SIZE/2,s+10),ctx.lineTo(i+TILE_SIZE-10,s+TILE_SIZE/2),ctx.lineTo(i+TILE_SIZE/2,s+TILE_SIZE-10),ctx.lineTo(i+10,s+TILE_SIZE/2),ctx.closePath(),ctx.stroke(),ctx.fillStyle=`rgba(255, 68, 34, ${.2+.2*Math.sin(frame/10)})`,ctx.fill()):6===h?(ctx.fillStyle="#333",ctx.beginPath(),ctx.arc(i+TILE_SIZE/2,s+TILE_SIZE/2,10,0,2*Math.PI),ctx.fill(),ctx.fillStyle="#fff",ctx.fillText("B",i+18,s+32)):7===h&&(ctx.fillStyle=C_ACCENT,ctx.beginPath(),ctx.arc(i+TILE_SIZE/2,s+TILE_SIZE/2,10,0,2*Math.PI),ctx.fill(),ctx.fillStyle="#fff",ctx.fillText("F",i+18,s+32))}entities.filter(t=>t instanceof Bomb).forEach(t=>t.draw()),particles.filter(t=>"fire"===t.type).forEach(t=>{ctx.fillStyle=`rgba(255, 68, 34, ${t.life/15})`,ctx.fillRect(t.x,t.y,t.w,t.h),ctx.fillStyle="#fff",ctx.beginPath(),ctx.arc(t.x+t.w/2,t.y+t.h/2,5,0,2*Math.PI),ctx.fill()}),entities.filter(t=>!(t instanceof Bomb)).forEach(t=>t.draw()),particles.filter(t=>"fire"!==t.type).forEach(t=>{"text"===t.type?(ctx.fillStyle="#333",ctx.font="bold 16px Courier New",ctx.fillText(t.text,t.x,t.y)):(ctx.fillStyle=t.color,ctx.globalAlpha=t.life/30,ctx.fillRect(t.x,t.y,4,4),ctx.globalAlpha=1)}),frame++,requestAnimationFrame(loop)}function loop(){update(),draw()}function startGame(){document.getElementById("overlay").classList.add("hidden"),gameRunning=!0,floorLevel=1,generateLevel(),loop()}function nextLevel(){gameRunning=!1,floorLevel++;const t=entities.find(t=>"player"===t.type);setTimeout(()=>{generateLevel();const e=entities.find(t=>"player"===t.type);e.maxBombs=t.maxBombs,e.bombRange=t.bombRange,gameRunning=!0,loop()},500)}function gameOver(){gameRunning=!1,document.getElementById("overlay").classList.remove("hidden"),document.querySelector("#overlay h1").innerText="TERMINATED",document.querySelector("#overlay p").innerText=`You reached Floor ${floorLevel}.`,document.getElementById("startBtn").innerText="RETRY"}const TILE_SIZE=50,COLS=17,ROWS=13,WIDTH=COLS*TILE_SIZE,HEIGHT=ROWS*TILE_SIZE,C_BG="#f0eee4",C_WALL_HARD="#2c2c2c",C_WALL_SOFT="#3d3d3d",C_ACCENT="#ff4422",C_PLAYER="#111",C_BOT="#551111",C_GHOST="#ff4422",canvas=document.getElementById("gameCanvas"),ctx=canvas.getContext("2d");canvas.width=WIDTH,canvas.height=HEIGHT;let gameRunning=!1,frame=0,floorLevel=1,map=[],entities=[],particles=[],shakeIntensity=0;const keys={w:!1,a:!1,s:!1,d:!1,space:!1,e:!1};class Entity{constructor(t,e,i){this.x=t,this.y=e,this.w=34,this.h=34,this.type=i,this.vx=0,this.vy=0,this.speed=3,this.dead=!1,this.color="#000"}update(){let t=this.x+this.vx;checkCollision(t,this.y,this.w,this.h)||(this.x=t);let e=this.y+this.vy;checkCollision(this.x,e,this.w,this.h)||(this.y=e)}draw(){ctx.fillStyle=this.color,ctx.fillRect(this.x,this.y,this.w,this.h)}getCenter(){return{x:this.x+this.w/2,y:this.y+this.h/2}}}class Player extends Entity{constructor(t,e){super(t,e,"player"),this.maxBombs=1,this.bombRange=2,this.activeBombs=0,this.dashCooldown=0,this.dashing=!1,this.dashTime=0,this.invincible=0,this.prevBombInput=!1,this.prevDashInput=!1}update(){if(this.dead)return;this.vx=0,this.vy=0;let t=navigator.getGamepads?navigator.getGamepads()[0]:null,e=.3,i=keys.w||t&&(t.axes[1]<-e||t.buttons[12].pressed),s=keys.s||t&&(t.axes[1]>e||t.buttons[13].pressed),h=keys.a||t&&(t.axes[0]<-e||t.buttons[14].pressed),o=keys.d||t&&(t.axes[0]>e||t.buttons[15].pressed),a=keys.space||t&&(t.buttons[0].pressed||t.buttons[3].pressed),l=keys.e||t&&(t.buttons[1].pressed||t.buttons[2].pressed),n=this.speed;this.dashing?(n=12,this.dashTime--,createParticle(this.x+this.w/2,this.y+this.h/2,C_ACCENT,2),this.dashTime<=0&&(this.dashing=!1)):this.dashCooldown>0&&this.dashCooldown--,i&&(this.vy=-n),s&&(this.vy=n),h&&(this.vx=-n),o&&(this.vx=n),l&&!this.prevDashInput&&this.dashCooldown<=0&&(0!==this.vx||0!==this.vy)&&(this.dashing=!0,this.dashTime=10,this.dashCooldown=120,screenShake(5)),super.update(),!a||this.prevBombInput||this.dashing||this.activeBombs<this.maxBombs&&placeBomb(this)&&this.activeBombs++,this.prevBombInput=a,this.prevDashInput=l,checkItemPickup(this);const c=this.dashCooldown>0?`Wait ${Math.ceil(this.dashCooldown/60)}`:"READY";document.getElementById("stats").innerText=`BOMBS: ${this.maxBombs} | RANGE: ${this.bombRange} | DASH: ${c}`}draw(){this.dead||(this.dashing&&(ctx.globalAlpha=.5,ctx.fillStyle=C_ACCENT,ctx.fillRect(this.x-this.vx,this.y-this.vy,this.w,this.h),ctx.globalAlpha=1),ctx.fillStyle=C_PLAYER,ctx.beginPath(),ctx.roundRect(this.x,this.y,this.w,this.h,8),ctx.fill(),ctx.fillStyle="#fff",ctx.fillRect(this.x+8,this.y+10,6,6),ctx.fillRect(this.x+20,this.y+10,6,6))}die(){this.invincible>0||this.dead||(this.dead=!0,createExplosionEffect(this.x+this.w/2,this.y+this.h/2,20,C_PLAYER),setTimeout(gameOver,1e3))}}class Bot extends Entity{constructor(t,e){super(t,e,"bot"),this.color=C_BOT,this.speed=2.5,this.moveTimer=0,this.bombCooldown=0}update(){if(this.dead)return;const t=entities.find(t=>"player"===t.type);if(!t||t.dead)return;const e=this.getCenter(),i=Math.floor(e.x/TILE_SIZE),s=Math.floor(e.y/TILE_SIZE);if(isDanger(i,s))this.speed=4;else if(this.speed=2.5,this.moveTimer--<=0){this.moveTimer=15;const e=t.x-this.x,i=t.y-this.y;Math.abs(e)>Math.abs(i)?(this.vx=e>0?this.speed:-this.speed,this.vy=0):(this.vx=0,this.vy=i>0?this.speed:-this.speed);const s=Math.hypot(e,i);s<3*TILE_SIZE&&this.bombCooldown<=0&&(placeBomb(this),this.bombCooldown=150,this.vx=-this.vx,this.vy=-this.vy)}this.bombCooldown>0&&this.bombCooldown--;let h=this.x+this.vx;checkCollision(h,this.y,this.w,this.h)?(this.vx=0,this.vy=Math.random()>.5?this.speed:-this.speed):this.x=h;let o=this.y+this.vy;checkCollision(this.x,o,this.w,this.h)?(this.vy=0,this.vx=Math.random()>.5?this.speed:-this.speed):this.y=o}draw(){this.dead||(ctx.fillStyle="#444",ctx.beginPath(),ctx.roundRect(this.x,this.y,this.w,this.h,5),ctx.fill(),ctx.fillStyle="red",ctx.fillRect(this.x+5,this.y+12,24,6))}}class Ghost extends Entity{constructor(t,e){super(t,e,"ghost"),this.color=C_GHOST,this.speed=1.5+.2*floorLevel,this.dir=Math.floor(4*Math.random()),this.changeDirTimer=0}update(){if(this.dead)return;this.changeDirTimer--<=0&&(this.dir=Math.floor(4*Math.random()),this.changeDirTimer=60),this.vx=0,this.vy=0,0===this.dir&&(this.vy=-this.speed),1===this.dir&&(this.vx=this.speed),2===this.dir&&(this.vy=this.speed),3===this.dir&&(this.vx=-this.speed);let t=this.x+this.vx,e=this.y+this.vy;checkCollision(t,this.y,this.w,this.h)?(this.x=Math.round(this.x),this.dir=Math.floor(4*Math.random())):this.x=t,checkCollision(this.x,e,this.w,this.h)?(this.y=Math.round(this.y),this.dir=Math.floor(4*Math.random())):this.y=e;const i=entities.find(t=>"player"===t.type);i&&!i.dead&&rectIntersect(this.x,this.y,this.w,this.h,i.x,i.y,i.w,i.h)&&i.die()}draw(){ctx.fillStyle=this.color,ctx.beginPath(),ctx.moveTo(this.x,this.y+this.h),ctx.lineTo(this.x,this.y+10),ctx.arc(this.x+this.w/2,this.y+10,this.w/2,Math.PI,0),ctx.lineTo(this.x+this.w,this.y+this.h),ctx.fill(),ctx.fillStyle="#fff",ctx.fillRect(this.x+8,this.y+12,8,8),ctx.fillRect(this.x+20,this.y+12,8,8),ctx.fillStyle="#000",ctx.fillRect(this.x+10,this.y+14,4,4),ctx.fillRect(this.x+22,this.y+14,4,4)}}class Bomb{constructor(t,e,i){this.gx=t,this.gy=e,this.timer=180,this.owner=i,this.range="player"===i.type?i.bombRange:2,this.exploded=!1}update(){this.timer--,this.timer%20==0&&createParticle(this.gx*TILE_SIZE+25,this.gy*TILE_SIZE+25,"#fff",1),this.timer<=0&&!this.exploded&&this.explode()}explode(){this.exploded=!0,"player"===this.owner.type&&this.owner.activeBombs--,screenShake(5),createExplosion(this.gx,this.gy,this.range)}draw(){const t=this.gx*TILE_SIZE+TILE_SIZE/2,e=this.gy*TILE_SIZE+TILE_SIZE/2;ctx.fillStyle="#333",ctx.beginPath(),ctx.arc(t,e,18,0,2*Math.PI),ctx.fill();const i=Math.floor((180-this.timer)/180*255);ctx.fillStyle=`rgb(255, ${255-i}, 0)`,ctx.beginPath(),ctx.arc(t,e,10,0,2*Math.PI),ctx.fill(),ctx.strokeStyle="#fff",ctx.lineWidth=2,ctx.stroke()}}window.addEventListener("keydown",t=>{"w"!==t.key&&"ArrowUp"!==t.key||(keys.w=!0),"s"!==t.key&&"ArrowDown"!==t.key||(keys.s=!0),"a"!==t.key&&"ArrowLeft"!==t.key||(keys.a=!0),"d"!==t.key&&"ArrowRight"!==t.key||(keys.d=!0)," "===t.key&&(keys.space=!0),"e"!==t.key&&"E"!==t.key||(keys.e=!0)}),window.addEventListener("keyup",t=>{"w"!==t.key&&"ArrowUp"!==t.key||(keys.w=!1),"s"!==t.key&&"ArrowDown"!==t.key||(keys.s=!1),"a"!==t.key&&"ArrowLeft"!==t.key||(keys.a=!1),"d"!==t.key&&"ArrowRight"!==t.key||(keys.d=!1)," "===t.key&&(keys.space=!1),"e"!==t.key&&"E"!==t.key||(keys.e=!1)}),document.getElementById("startBtn").addEventListener("click",startGame);