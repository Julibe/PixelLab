function gameLoopGamepad(){const e=navigator.getGamepads?navigator.getGamepads():[];e[0]&&handleGamepad(e[0]),requestAnimationFrame(gameLoopGamepad)}function handleGamepad(e){const t=.5;isGameRunning&&!isPaused&&((e.buttons[12].pressed||e.axes[1]<-t)&&"DOWN"!==dir&&(nextDir="UP"),(e.buttons[13].pressed||e.axes[1]>t)&&"UP"!==dir&&(nextDir="DOWN"),(e.buttons[14].pressed||e.axes[0]<-t)&&"RIGHT"!==dir&&(nextDir="LEFT"),(e.buttons[15].pressed||e.axes[0]>t)&&"LEFT"!==dir&&(nextDir="RIGHT")),e.buttons[9].pressed?gpState.startPressed||(!isGameRunning&&gameOverScreen.classList.contains("hidden")?startGame():gameOverScreen.classList.contains("hidden")?togglePause():(resetGame(),startGame()),gpState.startPressed=!0):gpState.startPressed=!1,e.buttons[0].pressed?(gpState.aPressed||(isGameRunning||(gameOverScreen.classList.contains("hidden")||resetGame(),startGame()),gpState.aPressed=!0),isGameRunning&&!isPaused&&enableBoost()):(gpState.aPressed=!1,disableBoost())}function updatePersonalBestDisplay(){const e=localStorage.getItem("snakeBestScore");bestScoreDisplay.textContent=e?parseInt(e,10):0}function togglePause(){isGameRunning&&(isPaused=!isPaused,isPaused?(clearInterval(gameLoop),clearTimeout(specialFruitTimer),pauseStart=Date.now(),pauseOverlay.style.display="block"):(pausedTime+=Date.now()-pauseStart,pauseOverlay.style.display="none",updateSpeed(currentSpeed),startSpecialCycle()))}function updateSpeed(e){currentSpeed=e,gameLoop&&clearInterval(gameLoop),!isPaused&&isGameRunning&&(gameLoop=setInterval(draw,currentSpeed))}function enableBoost(){isBoosting||(isBoosting=!0,updateSpeed(baseSpeed/2))}function disableBoost(){isBoosting&&(isBoosting=!1,updateSpeed(baseSpeed))}function spawnFood(){for(standardFood=getRandPos();collision(standardFood,snake)||specialFruits.some(e=>collision(standardFood,[e]));)standardFood=getRandPos()}function startSpecialCycle(){specialFruitTimer&&clearTimeout(specialFruitTimer),specialFruitTimer=setTimeout(()=>{if(!isPaused&&isGameRunning){const e=getRandPos(),t=getRandPos();specialFruits=[{...e,type:"poison"},{...t,type:"bonus"}].filter(e=>!collision(e,snake)&&!collision(e,[standardFood])),showMsg(UI_STRINGS.BONUS_FRUIT_MESSAGE),setTimeout(()=>{isPaused||(specialFruits=[])},8e3),startSpecialCycle()}},5e3*Math.random()+1e4)}function getRandPos(){return{x:Math.floor(Math.random()*cols)*box,y:Math.floor(Math.random()*rows)*box}}function collision(e,t){for(let o of t)if(e.x===o.x&&e.y===o.y)return!0;return!1}function getComboMultiplier(){return 1+.1*comboCount}function calculateScore(e,t,o,n){const a=o/1e3,s=500*e+10*a+10*t;return Math.round(s*n)}function showMsg(e,t=THEME.food){msgOverlay.innerText=e,msgOverlay.style.color=t,msgOverlay.style.opacity=1,setTimeout(()=>msgOverlay.style.opacity=0,1e3)}function createParticles(e,t,o){for(let n=0;n<10;n++)particles.push({x:e+box/2,y:t+box/2,color:o,vx:5*(Math.random()-.5),vy:5*(Math.random()-.5),life:60})}function draw(){ctx.clearRect(0,0,canvas.width,canvas.height);let e=snake[0].x,t=snake[0].y;if(dir=nextDir,"LEFT"===dir&&(e-=box),"UP"===dir&&(t-=box),"RIGHT"===dir&&(e+=box),"DOWN"===dir&&(t+=box),e<0||e>=canvas.width||t<0||t>=canvas.height||collision({x:e,y:t},snake))return void gameOver();const o={x:e,y:t};e===standardFood.x&&t===standardFood.y&&(foodCollected++,pendingGrowth+=2,comboCount++,lastEatTime=Date.now(),showMsg(UI_STRINGS.COMBO_MESSAGE+comboCount),createParticles(standardFood.x,standardFood.y,THEME.food),spawnFood());for(let o=specialFruits.length-1;o>=0;o--){const n=specialFruits[o];if(e===n.x&&t===n.y){if("poison"===n.type){document.body.classList.add("shake"),setTimeout(()=>document.body.classList.remove("shake"),500),pendingGrowth=Math.max(0,pendingGrowth-2);const e=Math.max(3,snake.length-2);snake.length=e,comboCount=Math.max(0,comboCount-3),showMsg(UI_STRINGS.POISON_MESSAGE,THEME.poison),createParticles(n.x,n.y,THEME.poison)}else"bonus"===n.type&&(pendingGrowth+=5,comboCount+=5,showMsg("+5 GROWTH!",THEME.bonus),createParticles(n.x,n.y,THEME.bonus));specialFruits.splice(o,1);break}}snake.unshift(o),pendingGrowth>0?pendingGrowth--:snake.pop(),Date.now()-lastEatTime>COMBO_TIME_LIMIT&&(comboCount=0),drawGrid(),ctx.fillStyle=THEME.food,ctx.fillRect(standardFood.x,standardFood.y,box,box);for(const e of specialFruits)ctx.fillStyle="poison"===e.type?THEME.poison:THEME.bonus,ctx.fillRect(e.x,e.y,box,box);for(let e=0;e<snake.length;e++)if(ctx.fillStyle=0===e?THEME.snake:"rgba(106,78,237, 0.7)",ctx.fillRect(snake[e].x,snake[e].y,box,box),0===e){ctx.fillStyle="#FFFFFF",ctx.beginPath();const t=box/8,o=box/4,n=snake[e].x,a=snake[e].y;"UP"===dir?(ctx.arc(n+o,a+o,t,0,2*Math.PI),ctx.arc(n+box-o,a+o,t,0,2*Math.PI)):"DOWN"===dir?(ctx.arc(n+o,a+box-o,t,0,2*Math.PI),ctx.arc(n+box-o,a+box-o,t,0,2*Math.PI)):"LEFT"===dir?(ctx.arc(n+o,a+o,t,0,2*Math.PI),ctx.arc(n+o,a+box-o,t,0,2*Math.PI)):"RIGHT"===dir&&(ctx.arc(n+box-o,a+o,t,0,2*Math.PI),ctx.arc(n+box-o,a+box-o,t,0,2*Math.PI)),ctx.fill()}for(let e=particles.length-1;e>=0;e--){const t=particles[e];t.x+=t.vx,t.y+=t.vy,t.life--,ctx.fillStyle=t.color,ctx.globalAlpha=t.life/60,ctx.beginPath(),ctx.arc(t.x,t.y,2,0,2*Math.PI),ctx.fill(),t.life<=0&&particles.splice(e,1)}ctx.globalAlpha=1,updateHUD()}function drawGrid(){ctx.strokeStyle="rgba(255, 255, 255, 0.05)";for(let e=0;e<=cols;e++)ctx.beginPath(),ctx.moveTo(e*box,0),ctx.lineTo(e*box,canvas.height),ctx.stroke();for(let e=0;e<=rows;e++)ctx.beginPath(),ctx.moveTo(0,e*box),ctx.lineTo(canvas.width,e*box),ctx.stroke()}function updateHUD(){const e=Date.now(),t=e-startTime-pausedTime,o=calculateScore(foodCollected,snake.length,t,getComboMultiplier()),n=Math.round(t/1e3);hudLength.innerText=snake.length,hudFood.innerText=foodCollected,hudTime.innerText=n,hudScore.innerText=o,latestFinalScore=o,hudComboCount.innerText=(comboCount>0?comboCount:1)+UI_STRINGS.MULTIPLIER_SUFFIX;const a=Math.max(0,COMBO_TIME_LIMIT-(e-lastEatTime));comboBar.style.width=(comboCount>0?a/COMBO_TIME_LIMIT*100:0)+"%"}function gameOver(){clearInterval(gameLoop),clearTimeout(specialFruitTimer),isGameRunning=!1;const e=latestFinalScore,t=document.getElementById("hudTime").innerText;document.getElementById("endLength").innerText=snake.length,document.getElementById("endFood").innerText=foodCollected,document.getElementById("endTime").innerText=t,document.getElementById("endScore").innerText=e;const o=parseInt(localStorage.getItem("snakeBestScore")||"0",10);e>o?(localStorage.setItem("snakeBestScore",e),bestScoreDisplay.innerText=e):bestScoreDisplay.innerText=o,gameOverScreen.classList.remove("hidden"),hudCombo.style.opacity=0,document.body.classList.add("shake")}const THEME={snake:"#6a4eed",food:"#FFFFFF",poison:"#ff6b6b",bonus:"#fad56a"},UI_STRINGS={MODE_LABEL:"Mode: ",EASY_MODE:"Easy (0.5X)",MEDIUM_MODE:"Med (1X)",HARD_MODE:"Hard (2x)",GAME_OVER:"GAME OVER",PAUSED:"PAUSED",COMBO_MESSAGE:"COMBO x",POISON_MESSAGE:"-3 COMBO!",BONUS_FRUIT_MESSAGE:"BONUS FRUIT!",MULTIPLIER_SUFFIX:"x",MS_SUFFIX:"ms"},canvas=document.getElementById("gameCanvas"),ctx=canvas.getContext("2d"),hudCombo=document.getElementById("combo"),hudLength=document.getElementById("hudLength"),hudFood=document.getElementById("hudFood"),hudTime=document.getElementById("hudTime"),hudScore=document.getElementById("hudScore"),hudComboCount=document.getElementById("hudCombo"),comboBar=document.getElementById("combo-bar"),msgOverlay=document.getElementById("msg-overlay"),pauseOverlay=document.getElementById("pause"),startScreen=document.getElementById("start"),gameOverScreen=document.getElementById("gameOver"),diffLabel=document.getElementById("diff-label"),colsInput=document.getElementById("cols-input"),rowsInput=document.getElementById("rows-input"),difficultyButtons=document.getElementById("difficulty-buttons").querySelectorAll(".sm-btn"),bestScoreDisplay=document.getElementById("bestScore");let gameLoop,box=20,cols=40,rows=25,baseSpeed=200,currentSpeed=200,isBoosting=!1,isPaused=!1,isGameRunning=!1,snake=[],dir="RIGHT",nextDir="RIGHT",foodCollected=0,pendingGrowth=0,startTime=0,pausedTime=0,pauseStart=0,comboCount=0,lastEatTime=0;const COMBO_TIME_LIMIT=3e3;let specialFruitTimer,standardFood={},specialFruits=[],particles=[];const gpState={startPressed:!1,aPressed:!1};let latestFinalScore=0;document.addEventListener("keydown",e=>{const t=e.key.toLowerCase(),o=e.keyCode;32!==o?isGameRunning&&!isPaused&&(37!==o&&"a"!==t||"RIGHT"===dir||(nextDir="LEFT"),38!==o&&"w"!==t||"DOWN"===dir||(nextDir="UP"),39!==o&&"d"!==t||"LEFT"===dir||(nextDir="RIGHT"),40!==o&&"s"!==t||"UP"===dir||(nextDir="DOWN"),"e"!==t||isBoosting||enableBoost()):togglePause()}),document.addEventListener("keyup",e=>{"e"===e.key.toLowerCase()&&disableBoost()}),window.setDifficulty=function(e){let t,o,n;difficultyButtons.forEach(e=>e.classList.remove("active")),"easy"===e?(t=200,o=UI_STRINGS.EASY_MODE,n="easy-btn"):"medium"===e?(t=100,o=UI_STRINGS.MEDIUM_MODE,n="medium-btn"):"hard"===e&&(t=50,o=UI_STRINGS.HARD_MODE,n="hard-btn"),baseSpeed=t,currentSpeed=t,diffLabel.innerText=UI_STRINGS.MODE_LABEL+o+" ("+t+UI_STRINGS.MS_SUFFIX+")",document.getElementById(n).classList.add("active")},window.startGame=function(){let e=parseInt(colsInput.value)||20,t=parseInt(rowsInput.value)||20;const o=.95*document.getElementById("game-zone").offsetWidth,n=.95*document.getElementById("game-zone").offsetHeight,a=o/e,s=n/t;box=Math.max(10,Math.floor(Math.min(a,s))),canvas.width=box*e,canvas.height=box*t,cols=e,rows=t,startScreen.classList.add("hidden"),document.getElementById("intro").classList.add("hidden"),document.getElementById("share").classList.add("hidden"),gameOverScreen.classList.add("hidden"),canvas.classList.remove("hidden"),hudCombo.style.opacity=1;const i=Math.floor(cols/2)*box,d=Math.floor(rows/2)*box;snake=[{x:i,y:d},{x:i-box,y:d},{x:i-2*box,y:d}],dir="RIGHT",nextDir="RIGHT",foodCollected=0,pendingGrowth=0,startTime=Date.now(),pausedTime=0,isBoosting=!1,isPaused=!1,isGameRunning=!0,specialFruits=[],particles=[],comboCount=0,lastEatTime=0,updateSpeed(baseSpeed),spawnFood(),startSpecialCycle()},window.resetGame=function(){gameLoop&&clearInterval(gameLoop),specialFruitTimer&&clearTimeout(specialFruitTimer),startScreen.classList.remove("hidden"),document.getElementById("intro").classList.remove("hidden"),document.getElementById("share").classList.remove("hidden"),canvas.classList.add("hidden"),gameOverScreen.classList.add("hidden"),hudCombo.style.opacity=0,isGameRunning=!1,pauseOverlay.style.display="none",document.body.classList.remove("shake"),ctx.clearRect(0,0,canvas.width,canvas.height),drawGrid(),updatePersonalBestDisplay()},window.shareTwitter=function(){const e=document.getElementById("endScore").innerText,t=document.getElementById("endLength").innerText,o=document.getElementById("endFood").innerText,n=document.getElementById("endTime").innerText,a="https://codepen.io/Julibe/full/KwzXdRq",s="nostalgia,90s,retro,gaming,snake,arcade",i=`I survived ${n} seconds, ate ${o} üçé, and grew to ${t} üü©! My Final score in #SnakeChallenge üêç was ${e}. Can you beat me? \nPlay here: ${a}`,d=`https://twitter.com/intent/tweet?text=${encodeURIComponent(i)}&hashtags=${encodeURIComponent(s)}`;window.open(d,"_blank")},window.onload=function(){setDifficulty("easy"),canvas.width=box*cols,canvas.height=box*rows,drawGrid(),resetGame(),requestAnimationFrame(gameLoopGamepad)};